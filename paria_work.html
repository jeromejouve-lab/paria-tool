<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PARIA — MVP</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f7f7f8}
  header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#fff;border-bottom:1px solid #e6e6e6;position:sticky;top:0;z-index:5}
  .tabs button{background:#fff;border:1px solid #e6e6e6;padding:8px 12px;border-radius:10px;cursor:pointer}
  .tabs button.active{background:#222;color:#fff;border-color:#222}
  main{padding:12px;display:grid;gap:12px}
  .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:12px}
  label{display:block;font-size:12px;color:#555;margin:6px 0 4px}
  input,textarea,button{font-size:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .hide{display:none}
</style>
</head>
<body>

<header>
  <div class="tabs">
    <button class="tabbtn active" data-tab="spec">Spécification</button>
    <button class="tabbtn" data-tab="capture">Capture</button>
    <button class="tabbtn" data-tab="client">Client</button>
    <button class="tabbtn" data-tab="scenarios">Scénarios</button>
  </div>
</header>

<main>
  <!-- Réglages toujours visibles -->
  <section class="card">
    <h3>Réglages GitHub & Proxy (MVP)</h3>
    <div class="row">
      <div>
        <label>Owner</label><input id="gh_owner" placeholder="jeromejouve-lab">
        <label>Repo</label><input id="gh_repo" placeholder="paria-audits">
        <label>Branche</label><input id="gh_branch" placeholder="acme">
        <label>Root</label><input id="gh_root" placeholder="clients/acme">
      </div>
      <div>
        <label>Token GitHub (github_pat_…)</label><input id="gh_token" type="password" placeholder="github_pat_...">
        <label>PROXY_URL (Apps Script)</label><input id="proxy_url" placeholder="https://script.google.com/macros/s/.../exec">
        <label>Service</label>
        <select id="serviceKey">
          <option>Direction</option><option>RH</option><option selected>Compta</option>
          <option>IT</option><option>Marketing</option><option>Ventes</option>
        </select>
        <label>Date (AAAA-MM-JJ)</label><input id="gh_date" type="date">
      </div>
    </div>
    <div style="margin-top:8px">
      <button id="btnSave">Sauver réglages</button>
      <span id="saveState" style="margin-left:8px;color:#2d7">—</span>
    </div>
  </section>
  <section class="card">
    <h3>Git (MVP) — Lister & Importer</h3>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span>Service</span>
      <select id="serviceKeyGit">
        <option>Direction</option><option>RH</option><option selected>Compta</option>
        <option>IT</option><option>Marketing</option><option>Ventes</option>
      </select>
      <span>Date</span>
      <input id="gh_date_git" type="date">
			<button id="btnYesterday">Hier</button>
      <button id="btnGhList">Lister dossier</button>
      <button id="btnGhImport">Importer sélection (.json)</button>
    </div>
    <div id="gh_list" style="margin-top:8px;font-size:14px"></div>
    <hr>
    <h4>Aperçu du fichier importé</h4>
    <pre id="gh_preview" style="max-height:260px;overflow:auto;background:#fafafa;padding:8px;border:1px solid #eee;border-radius:8px">—</pre>
  </section>

  <!-- Onglets -->
  <section id="tab-spec" class="card">
    <h3>Spécification</h3>
    <p>Juste un onglet de test. Quand ceci marche, on remet les fonctionnalités.</p>
  </section>

  <section id="tab-capture" class="card hide">
    <h3>Capture</h3>
    <p>Onglet actif : OK ✅</p>
  </section>

  <section id="tab-client" class="card hide">
    <h3>Client</h3>
    <p>Onglet actif : OK ✅</p>
  </section>

  <section id="tab-scenarios" class="card hide">
    <h3>Scénarios</h3>
    <p>Onglet actif : OK ✅</p>
  </section>
</main>

<script>
(function(){
  // 1) Tabs
  function showTab(tab){
    var ids = ["spec","capture","client","scenarios"];
    for(var i=0;i<ids.length;i++){
      var id = ids[i];
      var el = document.getElementById("tab-"+id);
      if(el){ el.classList.toggle("hide", id!==tab); }
    }
  }
  var btns = document.querySelectorAll(".tabbtn");
  for(var i=0;i<btns.length;i++){
    btns[i].addEventListener("click", function(){
      for(var j=0;j<btns.length;j++){ btns[j].classList.remove("active"); }
      this.classList.add("active");
      showTab(this.getAttribute("data-tab"));
    });
  }

  // 2) Charger réglages depuis localStorage
  function loadCfg(){
    try{
      var saved = localStorage.getItem("paria_github");
      if(saved){
        var gh = JSON.parse(saved);
        document.getElementById("gh_owner").value  = gh.owner||"";
        document.getElementById("gh_repo").value   = gh.repo||"";
        document.getElementById("gh_branch").value = gh.branch||"";
        document.getElementById("gh_root").value   = gh.root||"";
        document.getElementById("gh_token").value  = gh.token||"";
      }
      var purl = localStorage.getItem("paria_proxy_url")||"";
      document.getElementById("proxy_url").value = purl;
      var d = localStorage.getItem("paria_gh_date");
      document.getElementById("gh_date").value = d || new Date().toISOString().slice(0,10);
    }catch(e){}
  }
  loadCfg();

  // 3) Sauver réglages
  document.getElementById("btnSave").addEventListener("click", function(){
    var gh = {
      owner:  document.getElementById("gh_owner").value.trim(),
      repo:   document.getElementById("gh_repo").value.trim(),
      branch: document.getElementById("gh_branch").value.trim(),
      root:   document.getElementById("gh_root").value.trim().replace(/\/+$/,""),
      token:  document.getElementById("gh_token").value.trim()
    };
    localStorage.setItem("paria_github", JSON.stringify(gh));
    localStorage.setItem("paria_proxy_url", document.getElementById("proxy_url").value.trim());
    localStorage.setItem("paria_gh_date", document.getElementById("gh_date").value);
    document.getElementById("saveState").textContent = "Réglages sauvegardés ✔";
  });
	  // ====== ÉTAPE 2 : Git (MVP) Lister & Importer ======
  var API = "https://api.github.com";

  function loadGhCfg(){
    var gh = { owner:"", repo:"", branch:"", root:"", token:"" };
    try{
      var raw = localStorage.getItem("paria_github");
      if(raw) gh = JSON.parse(raw);
    }catch(e){}
    return gh;
  }
  function ghHeaders(token){
    return {
      "Accept":"application/vnd.github+json",
      "Authorization":"Bearer "+token,
      "X-GitHub-Api-Version":"2022-11-28"
    };
  }
  function ghUrl(owner, repo, path, ref){
    return API + "/repos/" + encodeURIComponent(owner) + "/" + encodeURIComponent(repo) +
           "/contents/" + encodeURIComponent(path) + (ref? ("?ref="+encodeURIComponent(ref)) : "");
  }
  function ymd(d){ var y=d.getFullYear(), m=("0"+(d.getMonth()+1)).slice(-2), dd=("0"+d.getDate()).slice(-2); return y+"-"+m+"-"+dd; }
  function yyyy(d){ return String(d.getFullYear()); }

  // init date/service par défaut
  (function initGitMvpFields(){
    var d = localStorage.getItem("paria_gh_date");
    document.getElementById("gh_date_git").value = d || new Date().toISOString().slice(0,10);
    document.getElementById("serviceKeyGit").value = "Compta";
  })();

  // Rendu de la liste
  function renderGhList(items, basePath){
    if(!Array.isArray(items)){ document.getElementById("gh_list").innerHTML = "<em>Rien</em>"; return; }
    var html = items.map(function(it){
      var isJson = (it.name||"").toLowerCase().endsWith(".json");
      return '<div><label><input type="checkbox" class="gh_ck" data-path="'+
        basePath+'/'+it.name+'" data-json="'+(isJson?'1':'0')+'"> '+it.type+' — '+it.name+'</label></div>';
    }).join("");
    document.getElementById("gh_list").innerHTML = html;
  }

	document.getElementById('btnYesterday').addEventListener('click', function(){
		var d = new Date();
		d.setDate(d.getDate() - 1);
		document.getElementById('gh_date_git').value = d.toISOString().slice(0,10);
	});

  // Bouton Lister
  document.getElementById("btnGhList").addEventListener("click", async function(){
    try{
      var gh = loadGhCfg();
      if(!gh.owner||!gh.repo||!gh.root||!gh.branch||!gh.token){ alert("Complète les réglages GitHub (en haut) puis Sauver."); return; }
      var svc = document.getElementById("serviceKeyGit").value;
      var dstr = document.getElementById("gh_date_git").value || new Date().toISOString().slice(0,10);
      var d = new Date(dstr+"T12:00:00");
      var day = ymd(d), year = yyyy(d);
      var dir = gh.root.replace(/\/+$/,"") + "/" + svc + "/" + year + "/" + day;

      var url = ghUrl(gh.owner, gh.repo, dir, gh.branch);
      var r = await fetch(url, { headers: ghHeaders(gh.token) });
      if(!r.ok){ document.getElementById("gh_list").innerHTML = '<span style="color:#a00">'+r.status+' '+r.statusText+'</span>'; return; }
      var j = await r.json();
      renderGhList(j, dir);
    }catch(e){
      document.getElementById("gh_list").innerHTML = '<span style="color:#a00">'+String(e)+'</span>';
    }
  });

  // GET fichier (helper)
  async function ghGetFile(path){
    var gh = loadGhCfg();
    var r = await fetch( ghUrl(gh.owner, gh.repo, path, gh.branch), { headers: ghHeaders(gh.token) } );
    if(!r.ok) throw new Error("GET "+path+" "+r.status);
    var j = await r.json();
    var b64 = (j.content||"").replace(/\n/g,"");
    // Décodage base64 (sans dépendance)
    var txt = atob(b64);
    return txt;
  }

  // Bouton Importer
  document.getElementById("btnGhImport").addEventListener("click", async function(){
    try{
      var boxes = Array.prototype.slice.call(document.querySelectorAll(".gh_ck:checked"));
      if(!boxes.length) return alert("Coche un fichier .json à importer.");
      var first = boxes.find(function(x){ return x.dataset.json==="1"; }) || boxes[0];
      var txt = await ghGetFile(first.dataset.path);
      // On vérifie juste que c'est du JSON et on affiche dans l'aperçu
      var obj;
      try{ obj = JSON.parse(txt); }catch(e){ return alert("Le fichier sélectionné n'est pas un JSON valide."); }
      document.getElementById("gh_preview").textContent = JSON.stringify(obj, null, 2);
      // Option : le garder en local pour la suite
      localStorage.setItem("paria_last_import", txt);
      alert("Import OK.");
    }catch(e){
      alert("Erreur import: "+String(e));
    }
  });

})();
</script>
</body>
</html>
