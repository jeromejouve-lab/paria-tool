<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PARIA ‚Äî Workbench</title>
<style>
  :root{--line:#e6e6e6;--bg:#f7f7f8;--ink:#222}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  header{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}

  /* Statuts propositions */
  .status-pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:12px}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.pending{background:#9aa3af}
  .dot.a_preciser{background:#f59e0b}
  .dot.valide{background:#10b981}
  .dot.refuse{background:#ef4444}
  .pact{cursor:pointer}
  .pact.active{background:#222;color:#fff;border-color:#222}

  /* Grille Projecteur standalone */
  .gridProj{display:grid;grid-template-columns:280px 1fr;gap:16px}
  .gridProj.no-agenda{grid-template-columns:1fr}

  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tabs button{background:#fff;border:1px solid var(--line);padding:8px 12px;border-radius:10px;cursor:pointer}
  .tabs button.active{background:#222;color:#fff;border-color:#222}
  .spacer{flex:1}
  .ctx{font-size:12px;opacity:.75}
  main{padding:12px;display:grid;gap:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .row{display:grid;gap:12px}
  @media(min-width:960px){ .row{grid-template-columns:1fr 1fr} }
  label{display:block;font-size:12px;color:#555;margin:6px 0 4px}
  textarea,input,select,button{font-size:14px}
  textarea{width:100%;min-height:100px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid #ddd;background:#fafafa}
  .hide{display:none}

  /* Projecteur (onglet) */
  #projAgenda{border:1px solid #ddd;border-radius:10px;padding:10px;max-height:70vh;overflow:auto}
  #projCard{border:1px solid #ddd;border-radius:10px;padding:16px;min-height:60vh;background:#fff}

  /* Projecteur standalone */
  .full{max-width:1200px;margin:0 auto;padding:16px}
</style>
</head>
<body>

<header>
  <div class="tabs" id="tabbar">
    <button class="tabbtn active" data-tab="reglages">R√©glages</button>
    <button class="tabbtn" data-tab="capture">Capture</button>
    <button class="tabbtn" data-tab="analyse">Analyse</button>
    <button class="tabbtn" data-tab="projecteur">Projecteur</button>
    <button class="tabbtn" data-tab="scenarios">Sc√©narios</button>
  </div>
  <div class="spacer"></div>
  <div class="ctx">Service:
    <select id="serviceKey">
      <option>Direction</option><option>RH</option><option selected>Compta</option>
      <option>IT</option><option>Marketing</option><option>Ventes</option>
    </select>
    &nbsp;|&nbsp; Work ID: <span id="workIdHdr">‚Äî</span>
  </div>
</header>

<main>
  <!-- R√âGLAGES -->
  <section id="tab-reglages" class="card">
    <h3>R√©glages / Persistance</h3>
    <div class="row">
      <div class="card">
        <h4>Google Apps Script (proxy)</h4>
        <label>DEPLOY URL</label>
        <input id="GAS_URL" placeholder="https://script.google.com/macros/s/AKfycb.../exec">
        <div class="actions">
          <button id="btnSaveCfg">Sauver</button>
          <button id="btnTestProxy">Tester</button>
          <span id="proxyState" class="pill">‚Äî</span>
        </div>
        <small>Le proxy g√®re : <code>route=analyze|save|load|echo</code>.</small>
      </div>

      <div class="card">
        <h4>Work ID (Client ¬∑ Service ¬∑ Date)</h4>
        <label>Client</label><input id="workClient" placeholder="ACME">
        <label>Date</label><input id="workDate" type="date">
        <div class="actions">
          <button id="btnBindWork">Lier ce Work ID</button>
          <span id="workBindState" class="pill">‚Äî</span>
        </div>
        <small>Le Work ID est m√©moris√© et visible en haut. Il permet de r√©-ouvrir la m√™me s√©ance.</small>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h4>Charger / Sauver (Apps Script)</h4>
        <div class="actions">
          <button id="btnLoad">Charger depuis Google</button>
          <button id="btnSave">Sauver vers Google</button>
          <span id="gsState" class="pill">‚Äî</span>
        </div>
      </div>

      <div class="card">
        <h4>GitHub (versionning)</h4>
        <label>Owner</label><input id="gh_owner" placeholder="jeromejouve-lab">
        <label>Repo</label><input id="gh_repo" placeholder="paria-audits">
        <label>Branch</label><input id="gh_branch" placeholder="main">
        <label>Base path</label><input id="gh_base" placeholder="clients">
        <label>Token PAT</label><input id="gh_token" type="password" placeholder="ghp_...">
        <label>Message de commit</label><input id="gh_msg" placeholder="feat: audit Compta 2025-08-28">
        <div class="actions">
          <button id="btnSaveGh">Sauver</button>
          <button id="btnPushGh">Pousser snapshot (.json + .md)</button>
          <span id="ghState" class="pill">‚Äî</span>
        </div>
        <small>Le snapshot pousse l‚Äô√©tat du service courant + un Markdown de synth√®se.</small>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h4>√âtat local</h4>
        <div class="actions">
          <button id="btnDump">Voir JSON</button>
          <button id="btnClear">R√©initialiser local</button>
        </div>
        <pre id="dump" style="max-height:240px;overflow:auto;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:8px"></pre>
      </div>
    </div>
  </section>

  <!-- CAPTURE -->
  <section id="tab-capture" class="card hide">
    <div class="row">
      <div class="card">
        <h3>Service Charter</h3>
        <label>Objectifs</label><textarea id="ch_obj"></textarea>
        <label>Contexte & contraintes</label><textarea id="ch_ctx"></textarea>
        <label>P√©rim√®tre</label><textarea id="ch_scope"></textarea>
        <label>Contraintes strictes</label><textarea id="ch_hard"></textarea>
        <label>Douleurs (top 3)</label><textarea id="ch_pains"></textarea>
        <label>KPI</label><textarea id="ch_kpi"></textarea>
        <label>Outils</label><textarea id="ch_tools"></textarea>
        <label>R√¥les & charge</label><textarea id="ch_roles"></textarea>
        <label>Budget & fen√™tre</label><textarea id="ch_budget"></textarea>
        <div class="actions">
          <button id="btnCharterToState">Sauver dans l‚Äô√©tat</button>
          <button id="btnCharterFromState">Charger de l‚Äô√©tat</button>
          <span id="charterState" class="pill">‚Äî</span>
        </div>
      </div>

      <div class="card">
        <h3>Note ‚Üí Analyse IA</h3>
        <div class="actions">
          <button id="btnMic">üéôÔ∏è Dicter</button>
          <span id="micStatus" class="pill">‚Äî</span>
        </div>
        <textarea id="note" placeholder="Parle ou tape ici‚Ä¶"></textarea>
        <div class="actions">
          <button id="btnAnalyze">Analyser (AI)</button>
          <span id="aiState" class="pill">‚Äî</span>
        </div>
        <h4>R√©sultat</h4>
        <pre id="analysis" style="white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:8px;max-height:260px;overflow:auto">‚Äî</pre>
      </div>
    </div>
  </section>

  <!-- ANALYSE / D√âCISIONS -->
  <section id="tab-analyse" class="card hide">
    <div class="row">
      <div class="card">
        <h3>Dernier item (r√©formulation & PARIA)</h3>
        <pre id="lastItem" style="white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:8px;max-height:300px;overflow:auto">‚Äî</pre>
        <div class="actions">
          <button data-status="valide"  class="decide">Valider</button>
          <button data-status="a_preciser" class="decide">√Ä pr√©ciser</button>
          <button data-status="refuse" class="decide">Refuser</button>
          <span id="decState" class="pill">‚Äî</span>
        </div>
      </div>

      <div class="card">
        <h3>D√©cisions (journal)</h3>
        <div id="decisions"></div>
        <div class="actions" style="margin-top:8px">
          <button id="btnExportMd">Exporter Markdown</button>
          <button id="btnExportClientHtml">Exporter HTML client</button>
          <button id="btnImportClientJson">Importer r√©ponses client (JSON)</button>
          <input id="clientJsonFile" type="file" accept="application/json" style="display:none">
          <span id="expState" class="pill">‚Äî</span>
        </div>
      </div>
    </div>
  </section>

  <!-- PROJECTEUR (dans la page) -->
  <section id="tab-projecteur" class="card hide">
    <div class="actions" style="justify-content:space-between">
      <div><strong>Projecteur (pr√©visualisation)</strong></div>
      <div class="actions"><button id="btnOpenProjector">Ouvrir le Projecteur (nouvel onglet)</button></div>
    </div>

    <div class="row">
      <aside id="projAgenda" class="card">
        <h4>Agenda (simplifi√©)</h4>
        <ol id="projAgendaList"></ol>
      </aside>

      <div id="projCard" class="card">
        <em>Analyse un item dans ‚ÄúCapture‚Äù pour l‚Äôafficher ici, ou ouvre le Projecteur.</em>
      </div>
    </div>
  </section>

  <!-- SC√âNARIOS -->
  <section id="tab-scenarios" class="card hide">
    <div class="actions">
      <button id="btnForkScenario">Dupliquer depuis l‚Äô√©tat courant</button>
      <button id="btnPromoteScenario">Promouvoir comme version de travail</button>
    </div>
    <div id="scList" style="margin-top:10px"></div>
  </section>
</main>

<script>
/* ====== CONFIG ====== */
const MODEL   = 'gpt-4o-mini';
const GAS_KEY = 'paria_gas_url';
const DB_KEY  = 'paria_db';
const WORK_KEY= 'paria_work_id'; // "ACME|Compta|2025-08-28"

/* ====== GitHub cfg ====== */
const GH_OWNER='paria_gh_owner', GH_REPO='paria_gh_repo', GH_BRANCH='paria_gh_branch',
      GH_BASE='paria_gh_base', GH_TOKEN='paria_gh_token';
const GH_API = 'https://api.github.com';

const DEFAULT_GAS_URL = ''; // optionnel: mets ici ton URL Apps Script pour pr√©remplir au 1er chargement

function gasUrl(){
  return (localStorage.getItem(GAS_KEY) || DEFAULT_GAS_URL || '').trim();
}

function gasUrl(){ return (localStorage.getItem(GAS_KEY)||'').trim(); }
function setGasUrl(u){ localStorage.setItem(GAS_KEY,u.trim()); }

/* ====== √âTAT LOCAL ====== */
let db = { services:{} }; // services[key]={ charter:{}, items:[], decisions:[], scenarios:[] }
function currentService(){ return document.getElementById('serviceKey').value; }
function svc(){
  const k=currentService();
  if(!db.services[k]) db.services[k]={ charter:{}, items:[], decisions:[], scenarios:[] };
  return db.services[k];
}
function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function loadDB(){ try{ db = JSON.parse(localStorage.getItem(DB_KEY)||'{"services":{}}'); }catch(e){ db={services:{}}; } }

/* ====== ONGLETING ====== */
const tabs = ['reglages','capture','analyse','projecteur','scenarios'];
function showTab(id){
  tabs.forEach(t=>{
    document.getElementById('tab-'+t).classList.toggle('hide', t!==id);
  });
  document.querySelectorAll('.tabbtn').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  if(id==='analyse') renderLastItem();
  if(id==='projecteur') renderProjectorInline();
  if(id==='scenarios') renderScList();
}
document.querySelectorAll('.tabbtn').forEach(b=>b.onclick=()=>showTab(b.dataset.tab));

/* ====== WORK ID ====== */
function currentWorkId(){
  const c = (document.getElementById('workClient').value||'').trim() || 'CLIENT';
  const s = currentService();
  const d = (document.getElementById('workDate').value||'').trim() || new Date().toISOString().slice(0,10);
  return `${c}|${s}|${d}`;
}
function parseWorkId(){
  const wid = localStorage.getItem(WORK_KEY)||'CLIENT|'+currentService()+'|'+new Date().toISOString().slice(0,10);
  const [client, service, date] = wid.split('|');
  return {client, service, date};
}
function bindWork(){
  const id = currentWorkId();
  localStorage.setItem(WORK_KEY, id);
  document.getElementById('workIdHdr').textContent = id;
  document.getElementById('workBindState').textContent = 'li√© ‚úî';
}

/* ====== BOOT R√âGLAGES ====== */
(function bootCfg(){
  document.getElementById('GAS_URL').value = gasUrl();
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('workDate').value = today;
  const wid = localStorage.getItem(WORK_KEY)||'‚Äî';
  document.getElementById('workIdHdr').textContent = wid;

  // GH cfg
  gh_owner.value  = localStorage.getItem(GH_OWNER)||'';
  gh_repo.value   = localStorage.getItem(GH_REPO)||'';
  gh_branch.value = localStorage.getItem(GH_BRANCH)||'main';
  gh_base.value   = localStorage.getItem(GH_BASE)||'clients';
  gh_token.value  = localStorage.getItem(GH_TOKEN)||'';
  gh_msg.value    = gh_msg.value || `feat: audit ${currentService()} ${today}`;
})();
btnSaveCfg.onclick = ()=>{ setGasUrl(document.getElementById('GAS_URL').value); alert('R√©glages sauvegard√©s.'); };
btnTestProxy.onclick = async ()=>{
  const u=gasUrl(); if(!u) return alert('Renseigne le DEPLOY URL.');
  try{
    const r1=await fetch(u+'?route=echo'); const j1=await r1.json();
    const r2=await fetch(u,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({route:'echo',hello:'world'})}); const j2=await r2.json();
    proxyState.textContent = (j1.ok&&j2.ok)?'OK ‚úî':'Partiel';
  }catch(e){ proxyState.textContent='Erreur'; }
};
btnBindWork.onclick = bindWork;

/* ====== GH helpers ====== */
btnSaveGh.onclick = ()=>{
  localStorage.setItem(GH_OWNER, gh_owner.value.trim());
  localStorage.setItem(GH_REPO, gh_repo.value.trim());
  localStorage.setItem(GH_BRANCH, gh_branch.value.trim()||'main');
  localStorage.setItem(GH_BASE, gh_base.value.trim()||'clients');
  localStorage.setItem(GH_TOKEN, gh_token.value.trim());
  ghState.textContent='Sauv√© ‚úî';
};
function utf8ToBase64(str){ return btoa(unescape(encodeURIComponent(str))); }
async function ghGetSHA(path){
  const u = `${GH_API}/repos/${gh_owner.value}/${gh_repo.value}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(gh_branch.value)}`;
  const r = await fetch(u,{headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${gh_token.value}` }});
  if(r.status===200){ const j=await r.json(); return j.sha||null; }
  return null;
}
async function ghPutFile(path, content, message){
  const sha = await ghGetSHA(path);
  const u = `${GH_API}/repos/${gh_owner.value}/${gh_repo.value}/contents/${encodeURIComponent(path)}`;
  const body = {
    message: message||'update',
    content: utf8ToBase64(content),
    branch: gh_branch.value
  };
  if(sha) body.sha = sha;
  const r = await fetch(u,{
    method:'PUT',
    headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${gh_token.value}`,'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if(!r.ok){ const t=await r.text(); throw new Error(`GitHub ${r.status}: ${t}`); }
  return r.json();
}
btnPushGh.onclick = async ()=>{
  try{
    ghState.textContent='Push‚Ä¶';
    const {client, service, date} = parseWorkId();
    const base = `${gh_base.value}/${client}/${service}/${date}`;
    const s = svc();
    // JSON snapshot
    const json = JSON.stringify(s,null,2);
    const md   = makeMarkdown(service, s);
    await ghPutFile(`${base}/state.json`, json, gh_msg.value||`feat: ${service} ${date} snapshot`);
    await ghPutFile(`${base}/audit_${service}_${date}.md`, md, gh_msg.value||`feat: ${service} ${date} md`);
    ghState.textContent='OK ‚úî';
  }catch(e){ ghState.textContent='Erreur'; alert(e.message); }
};

/* ====== LOAD / SAVE (Apps Script) ====== */
btnLoad.onclick = async ()=>{
  const u=gasUrl(); if(!u) return alert('Proxy non configur√©.');
  const service=currentService();
  const r = await fetch(`${u}?route=load&service=${encodeURIComponent(service)}`);
  const j = await r.json();
  if(j?.ok && j.data){
    db.services[service]=j.data;
    saveDB(); hydrateCharter(); gsState.textContent='Charg√© ‚úî';
  }else alert('Rien √† charger.');
};
btnSave.onclick = async ()=>{
  const u=gasUrl(); if(!u) return alert('Proxy non configur√©.');
  const service=currentService();
  const body={route:'save', service, data: db.services[service]||{charter:{},items:[],decisions:[],scenarios:[]} };
  const r=await fetch(u,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(body)});
  const j=await r.json(); gsState.textContent = j.ok ? 'Sauv√© ‚úî' : 'Erreur';
};

/* ====== DUMP / CLEAR ====== */
btnDump.onclick = ()=>{ dump.textContent = JSON.stringify(db,null,2); };
btnClear.onclick = ()=>{ if(confirm('Effacer l‚Äô√©tat local ?')){ localStorage.removeItem(DB_KEY); loadDB(); dump.textContent='‚Äî'; alert('R√©initialis√©.'); } };

/* ====== CHARTER ====== */
function hydrateCharter(){
  const ch = (svc().charter||{});
  ch_obj.value = ch.objectifs||''; ch_ctx.value=ch.contexte||''; ch_scope.value=ch.perimetre||'';
  ch_hard.value = ch.contraintes||''; ch_pains.value=ch.douleurs||''; ch_kpi.value=ch.kpis||'';
  ch_tools.value=ch.outils||''; ch_roles.value=ch.roles||''; ch_budget.value=ch.budget||'';
  charterState.textContent='Charg√© ‚úî';
}
btnCharterFromState.onclick = hydrateCharter;
btnCharterToState.onclick = ()=>{
  const s=svc();
  s.charter = {
    objectifs: ch_obj.value.trim(), contexte: ch_ctx.value.trim(), perimetre: ch_scope.value.trim(),
    contraintes: ch_hard.value.trim(), douleurs: ch_pains.value.trim(), kpis: ch_kpi.value.trim(),
    outils: ch_tools.value.trim(), roles: ch_roles.value.trim(), budget: ch_budget.value.trim()
  };
  saveDB(); charterState.textContent='Sauv√© ‚úî';
};

/* ====== DICT√âE (anti-duplication) ====== */
(function setupMic(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ micStatus.textContent='(non support√©e)'; return; }
  const rec=new SR();
  rec.lang='fr-FR';
  rec.continuous=true;
  rec.interimResults=false; // ‚¨ÖÔ∏è cl√©: pas de r√©sultats interm√©diaires

  let on=false;
  btnMic.onclick=()=>{
    if(!on){ rec.start(); on=true; micStatus.textContent='√âcoute‚Ä¶'; btnMic.textContent='‚ñ† Stop'; }
    else { rec.stop();  on=false; micStatus.textContent='‚Äî';       btnMic.textContent='üéôÔ∏è Dicter'; }
  };

  rec.onresult=(e)=>{
    // on n‚Äôajoute QUE les segments finals
    for (let i = e.resultIndex; i < e.results.length; i++){
      const res = e.results[i];
      if (res.isFinal){
        const txt = res[0].transcript.trim();
        // anti-r√©p√©tition courte (si le m√™me segment a d√©j√† √©t√© ajout√© en fin)
        if (!note.value.trim().endsWith(txt)) {
          note.value = (note.value + ' ' + txt).trim();
        }
      }
    }
  };
  rec.onend=()=>{ if(on) rec.start(); else { micStatus.textContent='‚Äî'; btnMic.textContent='üéôÔ∏è Dicter'; } };
})();


/* ====== ANALYSE (Apps Script -> OpenAI) ====== */
btnAnalyze.onclick = async ()=>{
  const u=gasUrl(); if(!u) return alert('Proxy non configur√©.');
  const s=svc();
  const payload={ route:'analyze', model:MODEL, service_key: currentService(), charter: s.charter, note: note.value||'' };
  aiState.textContent='Analyse‚Ä¶';
  try{
    const r=await fetch(u,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)});
    const j=await r.json();
    if(!j.ok) throw new Error(j.error||'analyse KO');
    const item=j.data;

    // normalisation
    item.id = item.id || ('I'+((s.items?.length||0)+1));
    item.title = item.title || (item.reformulation ? item.reformulation.slice(0,80) : 'Sujet √† pr√©ciser');
    (item.propositions||[]).forEach((p,i)=>{
      p.pid = p.pid || ('P'+(i+1));
      p.decision = p.decision || { status:'a_preciser', comment:'' };
    });
    item.pipeline = item.pipeline || 'pret_projecteur';
    item.priority = item.priority || 'P2';

    s.items.push(item);
    saveDB();
    analysis.textContent = JSON.stringify(item,null,2);
    aiState.textContent='OK ‚úî';
    localStorage.setItem('paria_touch', String(Date.now()));
  }catch(e){
    aiState.textContent='Erreur';
    alert('Analyse √©chou√©e: '+e.message);
  }
};

function recomputePipelineForItem(it){
  const statuses = (it.propositions||[]).map(p=> (p.decision?.status)||'a_preciser');
  const hasAny = statuses.some(s => s==='valide' || s==='refuse');
  const allFinal = statuses.length>0 && statuses.every(s => s==='valide' || s==='refuse');
  if (allFinal) return 'bouclee';
  if (hasAny)   return 'en_validation';
  return 'pret_projecteur';
}

/* ====== D√âCISIONS ====== */
function renderLastItem(){
  const s=svc();
  const it = (s.items||[])[(s.items||[]).length-1];
  if(!it){ lastItem.textContent='‚Äî'; return; }
  lastItem.textContent = JSON.stringify({
    id: it.id, title: it.title||it.reformulation||'', paria: it.paria||{}, propositions: it.propositions||[], questions: it.questions||[]
  },null,2);
}
document.querySelectorAll('.decide').forEach(b=>{
  b.onclick=()=>{
    const s=svc(); const it=(s.items||[])[(s.items||[]).length-1]; if(!it) return;
    (s.decisions||(s.decisions=[])).push({ ts:Date.now(), status:b.dataset.status, item:{ id:it.id, reformulation: it.reformulation||it.title||'' }});
    saveDB(); renderDecisions(); decState.textContent='Not√© ‚úî';
    localStorage.setItem('paria_touch', String(Date.now()));
  };
});
function renderDecisions(){
  const s=svc(), el=document.getElementById('decisions');
  if(!s.decisions?.length){ el.innerHTML='<em>Aucune d√©cision.</em>'; return; }
  el.innerHTML = s.decisions.slice().reverse().map(d=>{
    const txt = d.item?.reformulation || d.note || '';
    const st  = d.status || d.type || '';
    return `<div class="pill">${new Date(d.ts).toLocaleString()} ‚Äî <b>${st}</b> ‚Äî ${txt}</div>`;
  }).join('');
}

/* ====== EXPORTS ====== */
btnExportMd.onclick=()=>{
  const key=currentService(); const s=svc();
  const md = makeMarkdown(key,s);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([md],{type:'text/markdown'}));
  a.download=`audit_${key}_${new Date().toISOString().slice(0,10)}.md`; a.click();
  expState.textContent='Export√© ‚úî';
};
function makeMarkdown(key,s){
  const L=[]; L.push(`# Audit ${key} ‚Äî PARIA`,'','## Service Charter');
  for(const [k,v] of Object.entries(s.charter||{})) L.push(`- **${k}**: ${v||'-'}`);
  L.push('','## Analyses');
  (s.items||[]).forEach((it,i)=>{
    L.push(`### Item #${i+1} (${it.id})`);
    if(it.reformulation) L.push(`Reformulation: ${it.reformulation}`);
    const b=it.paria||{};
    for(const k of ['problemes','ameliorations','reconfigurations','integration_ia','actions']){
      if(b[k]?.length){ L.push(`- **${k}**:`); b[k].forEach(x=>L.push(`  - ${x}`)); }
    }
    if(it.questions?.length){ L.push(`- **Questions**:`); it.questions.forEach(q=>L.push(`  - ${q}`)); }
    if(it.propositions?.length){
      L.push(`- **Propositions**:`); it.propositions.forEach(p=>L.push(`  - ${p.pid||''} ${p.label} ‚Äî ${p.type} [${p.indicateurs?.cout||'-'}/${p.indicateurs?.complexite||'-'}]`));
    }
    L.push('');
  });
  L.push('## D√©cisions');
  (s.decisions||[]).forEach(d=>L.push(`- ${new Date(d.ts).toLocaleString()} ‚Äî **${d.status||d.type||''}** ‚Äî ${d.item?.reformulation||d.note||''}`));
  return L.join('\n');
}

/* ====== Export HTML client + Import JSON ====== */
btnExportClientHtml.onclick = ()=>{
  const s = svc();
  const pack = { service: currentService(), charter: s.charter, items: s.items };
  const html = makeClientHtml(pack);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([html],{type:'text/html'}));
  a.download = `form_client_${currentService()}_${new Date().toISOString().slice(0,10)}.html`;
  a.click();
};

btnImportClientJson.onclick = ()=> clientJsonFile.click();
clientJsonFile.onchange = async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  let obj; try{ obj=JSON.parse(await f.text()); }catch{ return alert('JSON invalide'); }
  const s=svc(); let n=0;
  (obj?.responses||[]).forEach(r=>{
    const it = (s.items||[]).find(x=>x.id===r.card_id); if(!it) return;
    const p  = (it.propositions||[]).find(y=>y.pid===r.pid); if(!p) return;
    p.decision = { status:r.decision, comment:r.comment||'', source:'client', ts: Date.now() };
    it.pipeline = recomputePipelineForItem(it);
    n++;
    (s.decisions||(s.decisions=[])).push({ ts:Date.now(), type:'client_import', status:r.decision, item:{ id:it.id, reformulation: it.reformulation||it.title||'' }, note:`${r.pid} ${r.decision}${r.comment? ' ('+r.comment+')':''}` });
  });
  saveDB(); localStorage.setItem('paria_touch', String(Date.now()));
  renderDecisions();
  alert(`R√©ponses client int√©gr√©es (${n}).`);
};

// G√©n√®re une page autonome que le client peut remplir (puis T√©l√©charger JSON)
// G√©n√®re une page autonome que le client peut remplir (puis T√©l√©charger JSON)
function makeClientHtml(pack){
  const safe = x=> String(x||'').replace(/[&<>]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;'})[s]);
  const rows = (pack.items||[]).map(it=>{
    const props = (it.propositions||[]).map(p=>`
      <tr>
        <td>${safe(p.pid)}</td>
        <td>${safe(p.label)}</td>
        <td>
          <select data-pid="${safe(p.pid)}" data-card="${safe(it.id)}">
            <option value="valide">Valider</option>
            <option value="a_preciser" selected>√Ä pr√©ciser</option>
            <option value="refuse">Refuser</option>
          </select>
        </td>
        <td><input type="text" data-cmt="1" data-pid="${safe(p.pid)}" data-card="${safe(it.id)}" placeholder="Commentaire"></td>
      </tr>`).join('');
    return `
      <section style="margin:12px 0;padding:10px;border:1px solid #eee;border-radius:8px">
        <h3>${safe(it.title||it.reformulation||'(sujet)')}</h3>
        <table border="1" cellpadding="6" style="border-collapse:collapse;width:100%">
          <thead><tr><th>PID</th><th>Proposition</th><th>D√©cision</th><th>Commentaire</th></tr></thead>
          <tbody>${props}</tbody>
        </table>
      </section>`;
  }).join('');

  return `<!doctype html><meta charset="utf-8"><title>Formulaire client ‚Äî ${safe(pack.service)}</title>
  <h2>Validation ‚Äî ${safe(pack.service)}</h2>
  <p>Choisissez une d√©cision pour chaque proposition, ajoutez un commentaire si besoin, puis <b>T√©l√©charger les r√©ponses</b> (ou Imprimer ‚Üí PDF).</p>
  ${rows}
  <button id="dl">T√©l√©charger les r√©ponses (JSON)</button>
  <button onclick="window.print()">Imprimer/PDF</button>
  <script>
    document.getElementById('dl').onclick = ()=>{
      const picks = [];
      document.querySelectorAll('select[data-pid]').forEach(sel=>{
        const pid=sel.getAttribute('data-pid');
        const cid=sel.getAttribute('data-card');
        const decision=sel.value;
        const cmt = (document.querySelector('input[data-cmt][data-pid="'+pid+'"][data-card="'+cid+'"]')||{}).value||'';
        picks.push({card_id:cid,pid,decision,comment:cmt});
      });
      const blob = new Blob([JSON.stringify({ responses:picks },null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'reponses_client.json';
      a.click();
    };
  <\/script>`;
}


/* ====== PROJECTEUR : inline ====== */
function chip(t){ return `<span style="border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin-right:6px">${t}</span>`; }
function stateBadge(p){ const map={discovery:'#A8B0B9',pret_projecteur:'#2463EB',en_validation:'#F59E0B',bouclee:'#10B981'}; const c=map[p]||'#A8B0B9'; return `<span style="background:${c};color:#fff;border-radius:6px;padding:2px 8px">${p||'‚Äî'}</span>`; }

function renderProjectorInline(){
  const s=svc();
  const it=(s.items||[])[(s.items||[]).length-1];
  const list=document.getElementById('projAgendaList');
  const card=document.getElementById('projCard');
  if(!it){
    list.innerHTML = '<li>‚Äî</li>';
    card.innerHTML='<em>Aucun item.</em>'; return;
  }
  const chips = (s.charter?.contraintes||'').split(/[;,‚Ä¢\n]/).map(x=>x.trim()).filter(Boolean).slice(0,4).map(chip).join(' ') || chip('‚Äî');
  function pill(dec){ 
    const st=(dec?.status)||'a_preciser';
    const src = dec?.source==='client' ? ' <span style="border:1px solid #60a5fa;border-radius:6px;padding:1px 6px;margin-left:6px">client</span>' : '';
    return `<span class="status-pill"><span class="dot ${st}"></span>${st.replace('_',' ')}</span>`;
  }
  list.innerHTML = `<li><a href="#" onclick="return false;">${it.title||it.reformulation||''}</a></li>`;
  const props = (it.propositions||[]).map((p,i)=>{
    const st = (p.decision?.status)||'a_preciser';
    const is = s=> (st===s ? 'class="pact active"' : 'class="pact"');
    return `
    <div style="border:1px solid #eee;border-radius:8px;padding:10px;margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${p.pid||('P'+(i+1))}</strong> ¬∑ ${p.label||''} &nbsp; ${pill(p.decision)}</div>
        <div>
          <button ${is('valide')}     data-act="valide"     data-c="${it.id}" data-p="${p.pid||('P'+(i+1))}" style="margin-right:6px">Valider</button>
          <button ${is('a_preciser')} data-act="a_preciser" data-c="${it.id}" data-p="${p.pid||('P'+(i+1))}" style="margin-right:6px">√Ä pr√©ciser</button>
          <button ${is('refuse')}     data-act="refuse"     data-c="${it.id}" data-p="${p.pid||('P'+(i+1))}">Refuser</button>
        </div>
      </div>
      <div style="opacity:.8;margin:4px 0">co√ªt:${p.indicateurs?.cout||'‚Äî'} ¬∑ complexit√©:${p.indicateurs?.complexite||'‚Äî'} ¬∑ embauche:${p.indicateurs?.embauche||'‚Äî'}</div>
      <label style="font-size:.9em;opacity:.8">Commentaire</label>
      <input type="text" class="pcmt" data-c="${it.id}" data-p="${p.pid||('P'+(i+1))}" value="${p.decision?.comment||''}" style="width:100%">
    </div>`;
  }).join('');
  card.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div>
        <div style="font-size:18px;font-weight:700">${it.title||it.reformulation||'(sujet √† nommer)'}</div>
        <div style="opacity:.8">${chip('Objectif: '+(it.objectif||'‚Äî'))} ${chip('Question: '+(it.question||'‚Äî'))}</div>
      </div>
      <div>${stateBadge(it.pipeline||'discovery')}</div>
    </div>
    <div style="margin:6px 0">${chips}</div>
    <div style="margin-top:10px;border-top:1px dashed #ddd;padding-top:8px">
      ${block('Probl√®mes', it.paria?.problemes)}
      ${block('Am√©liorations', it.paria?.ameliorations)}
      ${block('Reconfigurations', it.paria?.reconfigurations)}
      ${block('Int√©gration IA', it.paria?.integration_ia)}
      ${block('Actions (brouillon)', it.paria?.actions)}
    </div>
    <h4 style="margin-top:10px">Propositions</h4>
    ${props}`;
  function block(label,arr){ if(!Array.isArray(arr)||!arr.length) return ''; return `<div><strong>${label}</strong><ul style="margin:6px 0 12px 20px">${arr.slice(0,4).map(x=>`<li>${x}</li>`).join('')}</ul></div>`; }

  // Listeners
  card.querySelectorAll('.pact').forEach(b=>{
    b.onclick=()=>{
      const act=b.dataset.act, c=b.dataset.c, p=b.dataset.p;
      const s=svc(); const it=s.items.find(x=>x.id===c); if(!it) return;
      const prop=(it.propositions||[]).find(x=>x.pid===p); if(!prop) return;
      prop.decision = prop.decision || {status:'a_preciser',comment:''};
      prop.decision.status=act;
      const all=(it.propositions||[]).every(x=>x.decision && x.decision.status && x.decision.status!=='pending');
      it.pipeline = recomputePipelineForItem(it);
      saveDB(); localStorage.setItem('paria_touch', String(Date.now()));
      renderProjectorInline();
    };
  });
  card.querySelectorAll('.pcmt').forEach(inp=>{
    inp.onchange=()=>{
      const c=inp.dataset.c, p=inp.dataset.p;
      const s=svc(); const it=s.items.find(x=>x.id===c); if(!it) return;
      const prop=(it.propositions||[]).find(x=>x.pid===p); if(!prop) return;
      prop.decision = prop.decision || {status:'a_preciser',comment:''};
      prop.decision.comment = inp.value;
      saveDB(); localStorage.setItem('paria_touch', String(Date.now()));
    };
  });
}
btnOpenProjector.onclick = ()=>{
  const url = new URL(location.href);
  url.searchParams.set('projecteur','1');
  window.open(url.toString(),'projecteur_'+(localStorage.getItem(WORK_KEY)||''), 'noopener');
};

/* ====== SC√âNARIOS ====== */
btnForkScenario.onclick = ()=>{
  const s=svc();
  (s.scenarios||(s.scenarios=[]));
  const id = 'S'+((s.scenarios.length||0)+1);
  s.scenarios.push({ id, snapshot: JSON.parse(JSON.stringify(s)) , ts: Date.now() });
  saveDB(); renderScList(); alert(`Sc√©nario ${id} cr√©√©.`);
};
btnPromoteScenario.onclick = ()=>{
  const s=svc(); if(!s.scenarios?.length) return alert('Aucun sc√©nario.');
  const chosen = s.scenarios[s.scenarios.length-1];
  const snap = chosen.snapshot || {};
  s.items     = snap.items||s.items||[];
  s.decisions = snap.decisions||s.decisions||[];
  saveDB(); renderScList(); alert('Sc√©nario promu.');
};
function renderScList(){
  const s=svc(); const el=document.getElementById('scList');
  if(!s.scenarios?.length){ el.innerHTML='<em>Aucun sc√©nario.</em>'; return; }
  el.innerHTML = s.scenarios.map(sc=>`<div class="pill">${sc.id} ‚Äî ${new Date(sc.ts).toLocaleString()}</div>`).join(' ');
}

/* ====== BOOT ====== */
loadDB(); hydrateCharter(); renderDecisions(); renderLastItem();

/* ====== Projecteur standalone interactif (plein √©cran) ====== */
(function maybeStandaloneProjector(){
  const params = new URL(location.href).searchParams;
  if(params.get('projecteur')!=='1') return;

  function loadLocal(){ try{ return JSON.parse(localStorage.getItem(DB_KEY)||'{"services":{}}'); }catch(e){ return {services:{}}; } }
  function saveLocal(x){ localStorage.setItem(DB_KEY, JSON.stringify(x)); localStorage.setItem('paria_touch', String(Date.now())); }

  document.body.innerHTML = `
    <div class="full" style="font-size:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><strong>Projecteur</strong> ‚Äî <span id="p_hdr">‚Äî</span></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="p_prev">‚óÄ</button>
          <button id="p_next">‚ñ∂</button>
          <button id="p_big">A+</button>
          <button id="p_small">A‚àí</button>
          <button id="p_toggle_agenda">Afficher/Masquer Agenda</button>
          <small style="opacity:.7">F11 plein √©cran ¬∑ ‚Üê/‚Üí naviguer ¬∑ 1/2/3 d√©cider</small>
        </div>
      </div>
      <div id="p_grid" class="gridProj">
        <aside id="p_agenda" style="border:1px solid #ddd;border-radius:10px;padding:10px;max-height:74vh;overflow:auto"></aside>
        <main id="p_card" style="border:1px solid #ddd;border-radius:10px;padding:16px;min-height:70vh;background:#fff"></main>
      </div>
    </div>
  `;

  const hdr   = document.getElementById('p_hdr');
  const grid  = document.getElementById('p_grid');
  const agenda= document.getElementById('p_agenda');
  const card  = document.getElementById('p_card');
  const btnPrev = document.getElementById('p_prev');
  const btnNext = document.getElementById('p_next');
  const btnBig  = document.getElementById('p_big');
  const btnSmall= document.getElementById('p_small');
  const btnTogA = document.getElementById('p_toggle_agenda');

  function chip(t){ return `<span style="border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin-right:6px">${t}</span>`; }
  function stateBadge(p){ const map={discovery:'#A8B0B9',pret_projecteur:'#2463EB',en_validation:'#F59E0B',bouclee:'#10B981'}; const c=map[p]||'#A8B0B9'; return `<span style="background:${c};color:#fff;border-radius:6px;padding:2px 8px">${p||'‚Äî'}</span>`; }
  function block(label,arr){ if(!Array.isArray(arr)||!arr.length) return ''; return `<div><strong>${label}</strong><ul style="margin:6px 0 12px 22px">${arr.slice(0,6).map(x=>`<li>${x}</li>`).join('')}</ul></div>`; }

  let state = { db: loadLocal(), svcKey: null, svc: null, agendaIds: [], idx: 0 };

  function deriveService(){
    const wid = localStorage.getItem(WORK_KEY)||'';
    const parts = wid.split('|');
    return parts[1] || Object.keys(state.db.services||{})[0] || 'Compta';
  }
  function computeAgenda(){
    const items = state.svc.items||[];
    const ag = Array.isArray(state.svc.agenda)&&state.svc.agenda.length ? state.svc.agenda.slice() : items.map(x=>x.id);
    return ag.filter(id => items.some(x=>x.id===id));
  }
  function renderAgenda(){
    const items = state.svc.items||[];
    const html = state.agendaIds.map((cid,i)=>{
      const it = items.find(x=>x.id===cid);
      const cur = (i===state.idx) ? 'font-weight:700;text-decoration:underline;' : '';
      const label = (it?.title || it?.reformulation || '‚Äî'); /* fix label */ 
      return `<li style="margin:6px 0"><a href="#" data-i="${i}" style="${cur}">${label}</a></li>`;
    }).join('');
    agenda.innerHTML = `<h4 style="margin:0 0 8px 0">Agenda</h4><ol style="margin:0;padding-left:18px">${html||'<li>‚Äî</li>'}</ol>`;
    agenda.querySelectorAll('a[data-i]').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault(); state.idx=parseInt(a.dataset.i,10)||0; renderCard(); };
    });
  }
  function decide(cardId, pid, status, comment){
    const items = state.svc.items||[];
    const it = items.find(x=>x.id===cardId); if(!it) return;
    const p  = (it.propositions||[]).find(pp=>pp.pid===pid); if(!p) return;
    p.decision = p.decision || {status:'a_preciser', comment:''};
    if(status) p.decision.status = status;
    if(comment!==undefined) p.decision.comment = comment;
    const all = (it.propositions||[]).every(x=>x.decision && x.decision.status && x.decision.status!=='pending');
    it.pipeline = recomputePipelineForItem(it);
    (it.history||(it.history=[])).push({ts:Date.now(), who:'client', what:`${pid}=${p.decision.status}${p.decision.comment?' ('+p.decision.comment+')':''}`});
    saveLocal(state.db); renderCard();
  }
  function renderCard(){
    const items = state.svc.items||[];
    if(!state.agendaIds.length){ card.innerHTML = '<em>Aucun item.</em>'; return; }
    if(state.idx<0) state.idx=0; if(state.idx>=state.agendaIds.length) state.idx = state.agendaIds.length-1;
    const cid = state.agendaIds[state.idx];
    const it  = items.find(x=>x.id===cid);
    if(!it){ card.innerHTML='<em>Item introuvable.</em>'; return; }
    const chips = (state.svc.charter?.contraintes||'').split(/[;,‚Ä¢\n]/).map(x=>x.trim()).filter(Boolean).slice(0,4).map(chip).join(' ') || chip('‚Äî');
    const props = (it.propositions||[]).map((p,i)=>{
      const st=(p.decision?.status)||'a_preciser';
      const is = s=> (st===s ? 'class="pact active"' : 'class="pact"');
      return `
      <div style="border:1px solid #eee;border-radius:8px;padding:10px;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${p.pid||('P'+(i+1))}</strong> ¬∑ ${p.label||''}</div>
          <div>
            <button ${is('valide')}      data-c="${it.id}" data-p="${p.pid}" data-act="valide" style="margin-right:6px">Valider</button>
            <button ${is('a_preciser')}  data-c="${it.id}" data-p="${p.pid}" data-act="a_preciser" style="margin-right:6px">√Ä pr√©ciser</button>
            <button ${is('refuse')}      data-c="${it.id}" data-p="${p.pid}" data-act="refuse">Refuser</button>
          </div>
        </div>
        <div style="opacity:.8;margin:4px 0">co√ªt:${p.indicateurs?.cout||'‚Äî'} ¬∑ complexit√©:${p.indicateurs?.complexite||'‚Äî'} ¬∑ embauche:${p.indicateurs?.embauche||'‚Äî'} ¬∑ donn√©es:${p.indicateurs?.donnees||'‚Äî'}</div>
        <label style="font-size:.9em;opacity:.8">Commentaire</label>
        <input type="text" class="pcmt" data-c="${it.id}" data-p="${p.pid}" value="${p.decision?.comment||''}" style="width:100%">
      </div>`;
    }).join('');
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div style="font-size:22px;font-weight:700">${it.title||it.reformulation||'(sujet √† nommer)'}</div>
          <div style="opacity:.8">${chip('Objectif: '+(it.objectif||'‚Äî'))} ${chip('Question: '+(it.question||'‚Äî'))}</div>
        </div>
        <div>${stateBadge(it.pipeline||'discovery')}</div>
      </div>
      <div style="margin:6px 0">${chips}</div>
      <div style="margin-top:10px;border-top:1px dashed #ddd;padding-top:8px">
        ${block('Probl√®mes', it.paria?.problemes)}
        ${block('Am√©liorations', it.paria?.ameliorations)}
        ${block('Reconfigurations', it.paria?.reconfigurations)}
        ${block('Int√©gration IA', it.paria?.integration_ia)}
        ${block('Actions (brouillon)', it.paria?.actions)}
      </div>
      <h3 style="margin-top:10px">Propositions</h3>
      ${props}
      <div style="display:flex;justify-content:space-between;margin-top:8px">
        <button id="p_prev2">‚óÄ Pr√©c√©dent</button>
        <div>${state.idx+1}/${state.agendaIds.length}</div>
        <button id="p_next2">Suivant ‚ñ∂</button>
      </div>`;
    card.querySelectorAll('.pact').forEach(b=>{ b.onclick = ()=> decide(b.dataset.c, b.dataset.p, b.dataset.act); });
    card.querySelectorAll('.pcmt').forEach(inp=>{ inp.onchange = ()=> decide(inp.dataset.c, inp.dataset.p, null, inp.value); });
    document.getElementById('p_prev2').onclick = ()=> { state.idx=Math.max(0,state.idx-1); renderCard(); };
    document.getElementById('p_next2').onclick = ()=> { state.idx=Math.min(state.agendaIds.length-1,state.idx+1); renderCard(); };
  }
  function renderAll(){
    state.db = loadLocal();
    state.svcKey = deriveService();
    state.svc    = state.db.services[state.svcKey] || {charter:{},items:[],agenda:[]};
    state.agendaIds = computeAgenda();
    if(state.idx>=state.agendaIds.length) state.idx = 0;
    const wid = localStorage.getItem(WORK_KEY)||(`‚Äî | ${state.svcKey} | ‚Äî`);
    hdr.textContent = wid;
    renderAgenda(); renderCard();
  }
  renderAll();

  // sync via storage et contr√¥les
  window.addEventListener('storage', (e)=>{ if(e.key===DB_KEY || e.key==='paria_touch' || e.key===WORK_KEY) renderAll(); });
  btnPrev.onclick = ()=>{ state.idx=Math.max(0,state.idx-1); renderCard(); };
  btnNext.onclick = ()=>{ state.idx=Math.min(state.agendaIds.length-1,state.idx+1); renderCard(); };
  btnBig.onclick  = ()=>{ document.querySelector('.full').style.fontSize='18px'; };
  btnSmall.onclick= ()=>{ document.querySelector('.full').style.fontSize='15px'; };
  btnTogA.onclick = ()=>{ const hidden = agenda.style.display === 'none'; agenda.style.display = hidden ? 'block' : 'none'; grid.classList.toggle('no-agenda', !hidden); };
  window.addEventListener('keydown', (ev)=>{
    if(ev.key==='ArrowLeft'){ btnPrev.click(); ev.preventDefault(); }
    if(ev.key==='ArrowRight'){ btnNext.click(); ev.preventDefault(); }
    if(['1','2','3'].includes(ev.key)){
      const first = card.querySelector('.pact[data-act]'); if(!first) return;
      const c = first.getAttribute('data-c'); const p = first.getAttribute('data-p'); const map = { '1':'valide', '2':'a_preciser', '3':'refuse' };
      decide(c,p,map[ev.key]); ev.preventDefault();
    }
  });
})();
</script>
</body>
</html>


