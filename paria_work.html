<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PARIA ‚Äî Workbench</title>
<style>
  :root{--line:#e6e6e6;--bg:#f7f7f8;--ink:#222}
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--ink)}
  header{display:flex;align-items:center;gap:12px;padding:10px 12px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tabs button{background:#fff;border:1px solid var(--line);padding:8px 12px;border-radius:10px;cursor:pointer}
  .tabs button.active{background:#222;color:#fff;border-color:#222}
  .spacer{flex:1}
  .ctx{font-size:12px;opacity:.8}
  main{padding:12px;display:grid;gap:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  label{display:block;font-size:12px;color:#555;margin:6px 0 4px}
  input,textarea,button,select{font-size:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .hide{display:none}
  /* petits blocs */
  #projAgenda{border:1px solid #ddd;border-radius:10px;padding:10px;max-height:70vh;overflow:auto}
  #projCard{border:1px solid #ddd;border-radius:10px;padding:16px;min-height:60vh}
  #previewFrame{width:100%;height:520px;border:1px solid #eee;border-radius:8px;background:#fff}
</style>
</head>
<body>

<header>
  <div class="tabs" id="tabbar">
    <button class="tabbtn active" data-tab="reglages">R√©glages</button>
    <button class="tabbtn" data-tab="capture">Capture</button>
    <button class="tabbtn" data-tab="board">Board</button>
    <button class="tabbtn" data-tab="projecteur">Projecteur</button>
    <button class="tabbtn" data-tab="exports">Exports</button>
    <button class="tabbtn" data-tab="scenarios">Sc√©narios</button>
  </div>
  <div class="spacer"></div>
  <div class="ctx">
    Work ID: <span id="projWorkIdHdr">‚Äî</span>
  </div>
</header>

<main>

  <!-- R√âGLAGES -->
  <section id="tab-reglages" class="card">
    <h3>R√©glages GitHub & Proxy</h3>
    <div class="row">
      <div>
        <label>Owner</label><input id="gh_owner" placeholder="jeromejouve-lab">
        <label>Repo</label><input id="gh_repo" placeholder="paria-audits">
        <label>Branche</label><input id="gh_branch" placeholder="acme">
        <label>Root</label><input id="gh_root" placeholder="clients/acme">
      </div>
      <div>
        <label>Token GitHub (github_pat_‚Ä¶)</label><input id="gh_token" type="password" placeholder="github_pat_...">
        <label>PROXY_URL (Apps Script)</label><input id="proxy_url" placeholder="https://script.google.com/macros/s/.../exec">
        <label>Service courant</label>
        <select id="serviceKeyGit">
          <option>Direction</option><option>RH</option><option selected>Compta</option>
          <option>IT</option><option>Marketing</option><option>Ventes</option>
        </select>
        <label>Date (AAAA-MM-JJ)</label><input id="gh_date_git" type="date">
      </div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnSave">Sauver r√©glages</button>
      <span id="saveState" style="color:#2d7">‚Äî</span>
      <button id="btnProxyTest">Tester le proxy</button>
      <span id="proxyState" style="color:#555"></span>
      <button id="btnYesterday">Hier</button>
    </div>

    <hr style="margin:16px 0">
    <h3>Git ‚Äî Lister & Importer</h3>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button id="btnGhList">Lister dossier</button>
      <button id="btnGhImport">Importer s√©lection (.json)</button>
    </div>
    <div id="gh_list" style="margin-top:8px;font-size:14px"></div>

    <h4 style="margin-top:12px">Aper√ßu du fichier import√©</h4>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
      <button id="btnAdopt">Adopter comme √©tat de travail</button>
      <button id="btnPushJson">Push .json du jour ‚Üí GitHub</button>
      <span id="gitStatus" style="color:#2d7"></span>
    </div>
    <pre id="gh_preview" style="max-height:260px;overflow:auto;background:#fafafa;padding:8px;border:1px solid #eee;border-radius:8px">‚Äî</pre>

    <h4>R√©sum√© (√©tat de travail)</h4>
    <div id="workSummary">‚Äî</div>
  </section>

  <!-- CAPTURE -->
  <section id="tab-capture" class="card hide">
    <h3>Charter (Service)</h3>
    <div class="row">
      <div>
        <label>Objectifs</label><textarea id="ed_obj"></textarea>
        <label>Contexte</label><textarea id="ed_ctx"></textarea>
        <label>Contraintes strictes</label><textarea id="ed_hard"></textarea>
        <label>P√©rim√®tre</label><textarea id="ed_scope"></textarea>
        <label>Douleurs</label><textarea id="ed_pains"></textarea>
      </div>
      <div>
        <label>KPI</label><textarea id="ed_kpi"></textarea>
        <label>Outils</label><textarea id="ed_tools"></textarea>
        <label>R√¥les & charge</label><textarea id="ed_roles"></textarea>
        <label>Budget & fen√™tre</label><textarea id="ed_budget"></textarea>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnCharterLoad">Charger depuis l‚Äô√©tat</button>
          <button id="btnCharterSave">Sauver dans l‚Äô√©tat</button>
          <span id="charterState" style="color:#2d7"></span>
        </div>
      </div>
    </div>

    <hr style="margin:16px 0">
    <h3>Analyse IA (note ‚Üí card)</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <label for="noteInput"><strong>Note √† analyser</strong></label>
      <button id="btnMic">üéôÔ∏è Dicter</button>
      <span id="micState" style="opacity:.7"></span>
    </div>
    <textarea id="noteInput" rows="6" placeholder="Parle ou tape ici‚Ä¶"></textarea>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnIaAnalyze">Analyser (IA)</button>
      <button id="btnIaAdopt">Ajouter au Board</button>
      <span id="iaStatus" style="color:#2d7"></span>
    </div>
    <h4>R√©sultat</h4>
    <pre id="iaResult" style="max-height:280px;overflow:auto;background:#fafafa;padding:8px;border:1px solid #eee;border-radius:8px">‚Äî</pre>
  </section>

  <!-- BOARD -->
  <section id="tab-board" class="card hide">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div><strong>Board ‚Äî</strong> Service: <span id="boardService">‚Äî</span></div>
      <div style="display:flex;gap:8px">
        <button id="boardRefresh">Rafra√Æchir</button>
        <button id="boardAddToAgenda">Ajouter √† l‚ÄôAgenda (s√©lection)</button>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
      <div><h4>Discovery</h4><div id="col_discovery"></div></div>
      <div><h4>Pr√™t projecteur</h4><div id="col_pret"></div></div>
      <div><h4>En validation</h4><div id="col_valid"></div></div>
      <div><h4>Boucl√©e</h4><div id="col_done"></div></div>
    </div>
  </section>

  <!-- PROJECTEUR -->
  <section id="tab-projecteur" class="card hide">
    <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <strong>Projecteur ‚Äî Service:</strong>
        <span id="projServiceBadge">‚Äî</span>
        <span id="projWorkId" style="opacity:.7"></span>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <label><input type="checkbox" id="projMode"> Mode Pr√©sentation</label>
        <button id="projSync">Sync</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:260px 1fr;gap:16px;margin-top:12px">
      <aside id="projAgenda">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <strong>Agenda</strong>
          <button id="projAgendaRefresh" title="Recharger agenda">‚Üª</button>
        </div>
        <ol id="projAgendaList" style="margin:0;padding-left:18px"></ol>
      </aside>

      <div id="projCard"><em>Ajoute des cards √† l‚ÄôAgenda dans le Board.</em></div>
    </div>
  </section>

  <!-- EXPORTS -->
  <section id="tab-exports" class="card hide">
    <h3>Exports ‚Äî .md & rapport .html</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button id="btnPreviewMd">Pr√©visualiser Markdown</button>
      <button id="btnPushMd">Push .md ‚Üí GitHub</button>
      <button id="btnPreviewHtml">Pr√©visualiser HTML</button>
      <button id="btnPushHtml">Push rapport .html ‚Üí GitHub</button>
      <button id="btnPreviewHtmlLive">Aper√ßu HTML (live)</button>
      <button id="btnOpenHtmlTab">Ouvrir dans un onglet</button>
      <span id="exportStatus" style="color:#2d7"></span>
    </div>
    <h4>Preview</h4>
    <pre id="previewBox" style="max-height:280px;overflow:auto;background:#fafafa;padding:8px;border:1px solid #eee;border-radius:8px">‚Äî</pre>

    <div id="frameWrap" style="margin-top:8px">
      <h4>Aper√ßu live</h4>
      <iframe id="previewFrame"></iframe>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Formulaire client (HTML autonome)</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnGenClientForm">G√©n√©rer Formulaire (Agenda)</button>
        <button id="btnImportClientJSON">Importer r√©ponses client (JSON)</button>
        <input type="file" id="fileClientJSON" accept="application/json" style="display:none">
        <span id="clientFormState"></span>
      </div>
    </div>
  </section>

  <!-- SC√âNARIOS -->
  <section id="tab-scenarios" class="card hide">
    <h3>Sc√©narios (MVP)</h3>
    <p>√Ä venir : cr√©er S1/S2, inclure/exclure des cards, contraintes (no-hire, budget), Promote.</p>
  </section>

</main>

<script>
(function(){
  /* ------------------ TABS ------------------ */
  const tabs = ["reglages","capture","board","projecteur","exports","scenarios"];
  function showTab(tab){
    tabs.forEach(id=>{
      const el = document.getElementById("tab-"+id);
      if(el) el.classList.toggle("hide", id!==tab);
    });
    // onTabEnter
    if(tab==="board") renderBoard();
    if(tab==="projecteur") renderProjector();
    if(tab==="capture")  loadCharterToEditor();
    // header context
    document.getElementById("projWorkIdHdr").textContent = (localStorage.getItem("paria_work_id")||"‚Äî");
  }
  document.querySelectorAll(".tabbtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      showTab(btn.getAttribute("data-tab"));
    });
  });

  /* ------------------ CFG ------------------ */
  function loadCfg(){
    try{
      const saved = localStorage.getItem("paria_github");
      if(saved){
        const gh = JSON.parse(saved);
        gh_owner.value  = gh.owner||"";
        gh_repo.value   = gh.repo||"";
        gh_branch.value = gh.branch||"";
        gh_root.value   = gh.root||"";
        gh_token.value  = gh.token||"";
      }
      proxy_url.value = localStorage.getItem("paria_proxy_url")||"";
      gh_date_git.value = localStorage.getItem("paria_gh_date") || new Date().toISOString().slice(0,10);
      serviceKeyGit.value = "Compta";
    }catch(e){}
  }
  loadCfg();

  btnSave.addEventListener("click", ()=>{
    const gh = {
      owner:  gh_owner.value.trim(),
      repo:   gh_repo.value.trim(),
      branch: gh_branch.value.trim(),
      root:   gh_root.value.trim().replace(/\/+$/,""),
      token:  gh_token.value.trim()
    };
    localStorage.setItem("paria_github", JSON.stringify(gh));
    localStorage.setItem("paria_proxy_url", proxy_url.value.trim());
    localStorage.setItem("paria_gh_date", gh_date_git.value);
    saveState.textContent = "R√©glages sauvegard√©s ‚úî";
  });

  btnYesterday.addEventListener("click", ()=>{
    const d = new Date(); d.setDate(d.getDate()-1);
    gh_date_git.value = d.toISOString().slice(0,10);
  });

  /* ------------------ GITHUB LISTER/IMPORT ------------------ */
  const API = "https://api.github.com";
  function loadGhCfg(){ try{ return JSON.parse(localStorage.getItem("paria_github")||"{}"); }catch(e){ return {}; } }
  function ghHeaders(token){ return {"Accept":"application/vnd.github+json","Authorization":"Bearer "+token,"X-GitHub-Api-Version":"2022-11-28"}; }
  function ghUrl(owner,repo,path,ref){ return API+"/repos/"+encodeURIComponent(owner)+"/"+encodeURIComponent(repo)+"/contents/"+encodeURIComponent(path)+(ref?("?ref="+encodeURIComponent(ref)):""); }
  function ymd(d){ const y=d.getFullYear(), m=("0"+(d.getMonth()+1)).slice(-2), dd=("0"+d.getDate()).slice(-2); return y+"-"+m+"-"+dd; }
  function yyyy(d){ return String(d.getFullYear()); }

  function renderGhList(items, basePath){
    if(!Array.isArray(items)){ gh_list.innerHTML = "<em>Rien</em>"; return; }
    gh_list.innerHTML = items.map(it=>{
      const isJson = (it.name||"").toLowerCase().endsWith(".json");
      return `<div><label><input type="checkbox" class="gh_ck" data-path="${basePath+'/'+it.name}" data-json="${isJson?'1':'0'}"> ${it.type} ‚Äî ${it.name}</label></div>`;
    }).join("");
  }

  btnGhList.addEventListener("click", async ()=>{
    try{
      const gh = loadGhCfg();
      if(!gh.owner||!gh.repo||!gh.root||!gh.branch||!gh.token){ alert("Compl√®te les r√©glages GitHub puis Sauver."); return; }
      const svc = serviceKeyGit.value;
      const dstr = gh_date_git.value || new Date().toISOString().slice(0,10);
      const d=new Date(dstr+"T12:00:00"), day=ymd(d), year=yyyy(d);
      const dir = gh.root.replace(/\/+$/,"")+"/"+svc+"/"+year+"/"+day;
      const r = await fetch(ghUrl(gh.owner,gh.repo,dir,gh.branch), {headers:ghHeaders(gh.token)});
      if(!r.ok){ gh_list.innerHTML = `<span style="color:#a00">${r.status} ${r.statusText}</span>`; return; }
      renderGhList(await r.json(), dir);
    }catch(e){ gh_list.innerHTML = `<span style="color:#a00">${String(e)}</span>`; }
  });

  async function ghGetFile(path){
    const gh = loadGhCfg();
    const r = await fetch(ghUrl(gh.owner,gh.repo,path,gh.branch),{headers:ghHeaders(gh.token)});
    if(!r.ok) throw new Error("GET "+path+" "+r.status);
    const j = await r.json(); return atob((j.content||"").replace(/\n/g,""));
  }

  btnGhImport.addEventListener("click", async ()=>{
    try{
      const boxes = [...document.querySelectorAll(".gh_ck:checked")];
      if(!boxes.length) return alert("Coche un .json √† importer.");
      const first = boxes.find(x=>x.dataset.json==="1")||boxes[0];
      const txt = await ghGetFile(first.dataset.path);
      let obj; try{ obj=JSON.parse(txt); }catch(e){ return alert("JSON invalide"); }
      gh_preview.textContent = JSON.stringify(obj,null,2);
      localStorage.setItem("paria_last_import", txt);
      alert("Import OK.");
    }catch(e){ alert("Erreur import: "+String(e)); }
  });

  // adopt & push json
  function renderWorkSummary(){
    const raw = localStorage.getItem("paria_db"); if(!raw){ workSummary.textContent="‚Äî"; return; }
    let db; try{ db=JSON.parse(raw); }catch(e){ workSummary.textContent="‚Äî"; return; }
    const svcKey = serviceKeyGit.value || "Compta";
    const s = db.services && db.services[svcKey] || null;
    if(!s){ workSummary.textContent = `Aucun √©tat pour ¬´ ${svcKey} ¬ª.`; return; }
    const ch = s.charter || {};
    let html = '<ul style="margin:0;padding-left:18px">';
    html += `<li><b>Objectifs</b> : ${ch.objectifs||'‚Äî'}</li>`;
    html += `<li><b>Contexte</b> : ${ch.contexte||'‚Äî'}</li>`;
    html += `<li><b>Contraintes strictes</b> : ${ch.contraintes||'‚Äî'}</li>`;
    html += `<li><b>P√©rim√®tre</b> : ${ch.perimetre||'‚Äî'}</li>`;
    html += `<li><b>Douleurs</b> : ${ch.douleurs||'‚Äî'}</li>`;
    html += `<li><b>KPI</b> : ${ch.kpis||'‚Äî'}</li>`;
    html += `<li><b>Outils</b> : ${ch.outils||'‚Äî'}</li>`;
    html += `<li><b>R√¥les & charge</b> : ${ch.roles||'‚Äî'}</li>`;
    html += `<li><b>Budget & fen√™tre</b> : ${ch.budget||'‚Äî'}</li>`;
    html += '</ul>';
    const nItems = Array.isArray(s.items)? s.items.length : 0;
    html += `<p style="margin-top:8px">Items : <b>${nItems}</b></p>`;
    workSummary.innerHTML = html;
  }

  btnAdopt.addEventListener("click", ()=>{
    const txt = localStorage.getItem("paria_last_import");
    if(!txt) return alert("Importe d'abord un .json.");
    let obj; try{ obj=JSON.parse(txt); }catch(e){ return alert("JSON invalide."); }
    const svcKey = serviceKeyGit.value || "Compta";
    let db={services:{}}; try{ db=JSON.parse(localStorage.getItem("paria_db")||"{}"); }catch(e){}
    if(!db.services) db.services={};
    db.services[svcKey] = obj.services && obj.services[svcKey] ? obj.services[svcKey] : obj;
    localStorage.setItem("paria_db", JSON.stringify(db));
    renderWorkSummary();
    gitStatus.textContent = "√âtat adopt√© ‚úî";
  });

  function utf8ToB64(str){ const enc=new TextEncoder().encode(str); let bin=''; for(let b of enc) bin+=String.fromCharCode(b); return btoa(bin); }
  async function ghGetFileWithSha(path){
    const gh = loadGhCfg();
    const r = await fetch(ghUrl(gh.owner,gh.repo,path,gh.branch),{headers:ghHeaders(gh.token)});
    if(!r.ok) throw new Error("GET "+path+" "+r.status);
    const j = await r.json(); return j.sha||null;
  }
  async function ghUpsertJson(path,jsonText,message){
    const gh = loadGhCfg();
    let sha=null; try{ sha=await ghGetFileWithSha(path); }catch(e){}
    const body={message:message||("update "+path),content:utf8ToB64(jsonText),branch:gh.branch};
    if(sha) body.sha=sha;
    const r = await fetch(ghUrl(gh.owner,gh.repo,path),{method:"PUT",headers:ghHeaders(gh.token),body:JSON.stringify(body)});
    if(!r.ok) throw new Error("PUT "+path+" "+r.status);
    return r.json();
  }

  btnPushJson.addEventListener("click", async ()=>{
    try{
      const gh = loadGhCfg(); if(!gh.owner||!gh.repo||!gh.root||!gh.branch||!gh.token) return alert("R√©glages GitHub incomplets.");
      const raw = localStorage.getItem("paria_db"); if(!raw) return alert("Aucun √©tat de travail.");
      let db; try{ db=JSON.parse(raw); }catch(e){ return alert("√âtat local invalide."); }
      const svcKey = serviceKeyGit.value || "Compta";
      const s = db.services && db.services[svcKey]; if(!s) return alert("√âtat absent pour ¬´ "+svcKey+" ¬ª.");
      const dstr = gh_date_git.value || new Date().toISOString().slice(0,10);
      const d = new Date(dstr+"T12:00:00"); const year=String(d.getFullYear()); const day=d.toISOString().slice(0,10);
      const base = gh.root.replace(/\/+$/,"")+"/"+svcKey+"/"+year+"/"+day;
      const path = base+"/audit_"+svcKey+"_"+day+".json";
      gitStatus.textContent = "Push en cours‚Ä¶";
      const res = await ghUpsertJson(path, JSON.stringify(s,null,2), "feat: audit "+svcKey+" "+day+" (.json)");
      gitStatus.textContent = "Push OK ‚úî ("+res.content.path+")";
      alert("Push JSON OK.");
    }catch(e){ gitStatus.textContent="Erreur push"; alert("Erreur push: "+String(e)); }
  });

  renderWorkSummary();

  /* ------------------ EXPORTS ------------------ */
  async function ghUpsertText(path,text,message){
    const gh = loadGhCfg(); let sha=null; try{ sha=await ghGetFileWithSha(path);}catch(e){}
    const body={message:message||("update "+path),content:utf8ToB64(text),branch:gh.branch};
    if(sha) body.sha=sha;
    const r=await fetch(ghUrl(gh.owner,gh.repo,path),{method:"PUT",headers:ghHeaders(gh.token),body:JSON.stringify(body)});
    if(!r.ok) throw new Error("PUT "+path+" "+r.status);
    return r.json();
  }
  function getWorkForService(){
    const svcKey = serviceKeyGit.value || "Compta";
    const raw = localStorage.getItem("paria_db"); if(!raw) return {key:svcKey, s:null};
    let db; try{ db=JSON.parse(raw); }catch(e){ return {key:svcKey, s:null}; }
    const s = db.services && db.services[svcKey] || null;
    return {key:svcKey, s};
  }
  function clientSlugFromRoot(){ const gh=loadGhCfg(); const parts=(gh.root||'').split('/').filter(Boolean); return parts.length? parts[parts.length-1]:'client'; }
  function makeMarkdown(svcKey,s){
    const L=[]; L.push("# Audit "+svcKey+" ‚Äî PARIA","", "## Service Charter");
    const ch=s.charter||{}; ["objectifs","contexte","contraintes","perimetre","douleurs","kpis","outils","roles","budget"].forEach(k=>L.push("- **"+k+"**: "+(ch[k]||"-")));
    L.push("", "## Analyses");
    (s.items||[]).forEach((it,i)=>{
      L.push("### Item #"+(i+1)+" ("+(it._priority_tag||"P3")+")");
      if(it.reformulation) L.push("Reformulation: "+it.reformulation);
      const b=it.paria||{};
      ["problemes","ameliorations","reconfigurations","integration_ia","actions"].forEach(key=>{
        const arr=b[key]||[]; if(arr.length){ L.push("- **"+key+"**:"); arr.forEach(x=>L.push("  - "+x)); }
      });
      if (it.questions?.length){ L.push("- **Questions**:"); it.questions.forEach(q=>L.push("  - "+q)); }
      L.push("");
    });
    L.push("## D√©cisions");
    (s.decisions||[]).forEach(d=>L.push("- "+ new Date(d.ts).toLocaleString() +" ‚Äî **"+d.status+"** ‚Äî "+(d.item?.reformulation||'')+" ("+(d.tag||'P3')+")"));
    return L.join("\n");
  }
  function esc(x){ return (x||"").replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }
  function buildReportHtml(ctx){
    const {service, charter:ch={}, items=[], decisions:decs=[], brand={}}=ctx;
    const rows = items.map((it,i)=>{
      const props = (it.propositions||[]).map(p=>"<li>"+esc(p.label||"")+" ‚Äî "+esc(p.type||"")+"</li>").join("");
      const qs = (it.questions||[]).map(q=>"<li>"+esc(q)+"</li>").join("");
      const b=it.paria||{};
      function block(label,arr){ return (arr&&arr.length)? "<li><b>"+label+"</b><ul><li>"+arr.map(esc).join("</li><li>")+"</li></ul></li>":""; }
      const paria = "<ul>"+block("Probl√®mes",b.problemes)+block("Am√©liorations",b.ameliorations)+block("Reconfigurations",b.reconfigurations)+block("Int√©gration IA",b.integration_ia)+block("Actions",b.actions)+"</ul>";
      return `<section style="margin:12px 0"><h3>Item #${i+1} <span style="border:1px solid #ccc;border-radius:12px;padding:2px 8px">${esc(it._priority_tag||"P3")}</span></h3><p>${esc(it.reformulation||"")}</p>${paria}${qs? "<p><b>Questions</b><ul>"+qs+"</ul></p>": ""}${props? "<p><b>Propositions</b><ul>"+props+"</ul></p>": ""}</section>`;
    }).join("");
    const decList = decs.map(d=>"<li>"+new Date(d.ts).toLocaleString()+" ‚Äî <b>"+esc(d.status)+"</b> ‚Äî "+esc(d.item?.reformulation||"")+" ("+esc(d.tag||"P3")+")</li>").join("");
    return '<!doctype html><html><head><meta charset="utf-8"><title>Rapport ‚Äî '+esc(brand.client_name||'Client')+' ‚Äî '+esc(service)+'</title>'+
      '<style>body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px}header{display:flex;align-items:center;gap:16px;margin-bottom:16px}header img{height:48px}.hdr{margin-left:auto;text-align:right;font-size:12px;color:#666}h1{margin:0 0 4px}</style></head><body>'+
      '<header>'+ (brand.logo_self? '<img src="'+brand.logo_self+'">': '') +
      '<div><h1>Rapport d\'audit ‚Äî '+esc(service)+'</h1><small>'+new Date().toLocaleString()+'</small></div>'+
      '<div class="hdr">'+esc(brand.header||'')+'</div>'+ (brand.logo_client? '<img src="'+brand.logo_client+'">': '') +'</header>'+
      '<section><h2>Contexte (Charter)</h2><ul>'+
      '<li><b>Objectifs</b> : '+esc(ch.objectifs||"-")+'</li>'+
      '<li><b>Contexte & contraintes</b> : '+esc(ch.contexte||"-")+'</li>'+
      '<li><b>Contraintes strictes</b> : '+esc(ch.contraintes||"-")+'</li>'+
      '<li><b>P√©rim√®tre</b> : '+esc(ch.perimetre||"-")+'</li>'+
      '<li><b>Douleurs</b> : '+esc(ch.douleurs||"-")+'</li>'+
      '<li><b>KPI</b> : '+esc(ch.kpis||"-")+'</li>'+
      '<li><b>Outils</b> : '+esc(ch.outils||"-")+'</li>'+
      '<li><b>R√¥les & charge</b> : '+esc(ch.roles||"-")+'</li>'+
      '<li><b>Budget & fen√™tre</b> : '+esc(ch.budget||"-")+'</li>'+
      '</ul></section>'+
      '<section><h2>Synth√®se & strat√©gie</h2><p>Prioriser <b>P1</b> (quick wins), planifier <b>P2</b>, cadrer <b>P3</b>.</p></section>'+
      '<section><h2>Analyses</h2>'+ (rows||'<em>Aucun item.</em>') +'</section>'+
      '<section><h2>D√©cisions</h2><ul>'+ (decList||'<li>‚Äî</li>') +'</ul></section>'+
      '</body></html>';
  }
  function computePathsForToday(){
    const gh=loadGhCfg();
    const svcKey = serviceKeyGit.value || "Compta";
    const dstr = gh_date_git.value || new Date().toISOString().slice(0,10);
    const d = new Date(dstr+"T12:00:00"); const year=String(d.getFullYear()); const day=d.toISOString().slice(0,10);
    const base = gh.root.replace(/\/+$/,"")+"/"+svcKey+"/"+year+"/"+day;
    const client = clientSlugFromRoot();
    return { mdPath: base+"/audit_"+svcKey+"_"+day+".md", htmlPath: base+"/rapport_"+client+"_"+svcKey+"_"+day+".html", svcKey, day, client };
  }

  btnPreviewMd.addEventListener("click", ()=>{
    const w=getWorkForService(); if(!w.s) return alert("Aucun √©tat de travail.");
    previewBox.textContent = makeMarkdown(w.key,w.s);
  });
  btnPushMd.addEventListener("click", async ()=>{
    try{
      const w=getWorkForService(); if(!w.s) return alert("Aucun √©tat de travail.");
      const p=computePathsForToday();
      exportStatus.textContent="Push .md en cours‚Ä¶";
      const res=await ghUpsertText(p.mdPath, makeMarkdown(w.key,w.s), "feat: audit "+w.key+" "+p.day+" (.md)");
      exportStatus.textContent="Push .md OK ‚úî ("+res.content.path+")";
    }catch(e){ exportStatus.textContent="Erreur push .md"; alert("Erreur push .md: "+String(e)); }
  });
  btnPreviewHtml.addEventListener("click", ()=>{
    const w=getWorkForService(); if(!w.s) return alert("Aucun √©tat de travail.");
    const p=computePathsForToday();
    const html=buildReportHtml({service:w.key,charter:w.s.charter||{},items:w.s.items||[],decisions:w.s.decisions||[],brand:{header:"",logo_self:"",client_name:p.client,logo_client:""}});
    previewBox.textContent = html.replace(/></g,'>\n<');
  });
  btnPreviewHtmlLive.addEventListener("click", ()=>{
    const w=getWorkForService(); if(!w.s) return alert("Aucun √©tat de travail.");
    const p=computePathsForToday();
    const html=buildReportHtml({service:w.key,charter:w.s.charter||{},items:w.s.items||[],decisions:w.s.decisions||[],brand:{header:"",logo_self:"",client_name:p.client,logo_client:""}});
    previewFrame.srcdoc = html;
  });
  btnOpenHtmlTab.addEventListener("click", ()=>{
    const w=getWorkForService(); if(!w.s) return alert("Aucun √©tat de travail.");
    const p=computePathsForToday();
    const html=buildReportHtml({service:w.key,charter:w.s.charter||{},items:w.s.items||[],decisions:w.s.decisions||[],brand:{header:"",logo_self:"",client_name:p.client,logo_client:""}});
    const url = URL.createObjectURL(new Blob([html],{type:"text/html"})); window.open(url,"_blank");
  });
  btnPushHtml.addEventListener("click", async ()=>{
    try{
      const w=getWorkForService(); if(!w.s) return alert("Aucun √©tat de travail.");
      const p=computePathsForToday();
      const html=buildReportHtml({service:w.key,charter:w.s.charter||{},items:w.s.items||[],decisions:w.s.decisions||[],brand:{header:"",logo_self:"",client_name:p.client,logo_client:""}});
      exportStatus.textContent="Push .html en cours‚Ä¶";
      const res=await ghUpsertText(p.htmlPath, html, "feat: audit "+w.key+" "+p.day+" (rapport .html)");
      exportStatus.textContent="Push .html OK ‚úî ("+res.content.path+")";
    }catch(e){ exportStatus.textContent="Erreur push .html"; alert("Erreur push .html: "+String(e)); }
  });

  // Formulaire client (export/import)
  function download(name,content,mime){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type:mime||'text/plain'})); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500); }
  btnGenClientForm.onclick = ()=>{
    const {key,s}=svc(); if(!s.agenda?.length) return alert('Agenda vide.');
    const dateStr=(localStorage.getItem('paria_work_id')||'').split('|')[2] || new Date().toISOString().slice(0,10);
    download(`client_form_${key}_${dateStr}.html`, genClientFormHTML(key,dateStr,s), 'text/html');
    clientFormState.textContent='Formulaire g√©n√©r√©';
  };
  function genClientFormHTML(service,dateStr,s){
    const cards=(s.agenda||[]).map(cid=>s.items.find(x=>x.id===cid)).filter(Boolean);
    function propBlock(c){ return (c.propositions||[]).map((p,ix)=>`
      <div style="border:1px solid #eee;border-radius:8px;padding:10px;margin-bottom:12px">
        <div><strong>${p.pid||('P'+(ix+1))}</strong> ¬∑ ${p.label||''}</div>
        <div>
          <label><input type="radio" name="${c.id}_${p.pid}" value="valider"> Valider</label>
          <label style="margin-left:12px"><input type="radio" name="${c.id}_${p.pid}" value="a_preciser"> √Ä pr√©ciser</label>
          <label style="margin-left:12px"><input type="radio" name="${c.id}_${p.pid}" value="refuse"> Refuser</label>
        </div>
        <div><em>co√ªt:${p.indicateurs?.cout||'‚Äî'} ¬∑ complexit√©:${p.indicateurs?.complexite||'‚Äî'} ¬∑ embauche:${p.indicateurs?.embauche||'‚Äî'}</em></div>
        <div>Commentaire: <input type="text" id="cmt_${c.id}_${p.pid}" style="width:100%"></div>
      </div>`).join(''); }
    const pages = cards.map((c,i)=>`
      <section class="page" data-c="${c.id}" style="display:${i===0?'block':'none'}">
        <h2>${c.id} ¬∑ ${c.title||''}</h2>
        <div style="opacity:.8;margin-bottom:6px">Service: ${service} ¬∑ Date: ${dateStr}</div>
        <h3>Propositions</h3>
        ${propBlock(c)}
        <div style="display:flex;justify-content:space-between;margin-top:8px">
          <button onclick="nav(-1)">${i===0?'':'‚óÄ Pr√©c√©dent'}</button>
          <div>${i+1}/${cards.length}</div>
          <button onclick="nav(1)">${i===cards.length-1?'Terminer':'Suivant ‚ñ∂'}</button>
        </div>
      </section>`).join('');
    return `<!doctype html><meta charset="utf-8">
      <title>Formulaire client ‚Äî ${service} ${dateStr}</title>
      <style>body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;max-width:900px;margin:24px auto;padding:0 12px}</style>
      <h1>Validation des propositions ‚Äî ${service}</h1>
      <p>Pour chaque proposition, choisissez une option et ajoutez un commentaire si utile. √Ä la fin, cliquez ‚ÄúExporter r√©ponses (JSON)‚Äù et renvoyez le fichier.</p>
      ${pages}
      <div style="margin-top:16px"><button onclick="exportJSON()">Exporter r√©ponses (JSON)</button> <span id="state"></span></div>
      <script>
        function nav(dir){ const pages=[...document.querySelectorAll('.page')]; const cur=pages.findIndex(p=>p.style.display!=='none'); const next=Math.min(pages.length-1,Math.max(0,cur+dir)); pages[cur].style.display='none'; pages[next].style.display='block'; }
        function exportJSON(){
          const decisions=[];
          document.querySelectorAll('.page').forEach(sec=>{
            const cid=sec.getAttribute('data-c');
            sec.querySelectorAll('input[type=radio]:checked').forEach(r=>{
              const name=r.name, val=r.value;
              const pid=name.split('_').slice(1).join('_').replace(cid+'_','');
              const cmt=(document.getElementById('cmt_'+cid+'_'+pid)?.value||'').trim();
              decisions.push({ cardId: cid, pid: pid, decision: val, comment: cmt });
            });
          });
          const payload={ service:"${service}", date:"${dateStr}", decisions };
          const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'})); a.download='client_responses_${service}_${dateStr}.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500);
          document.getElementById('state').textContent='Export√© ‚úî';
        }
      </script>`;
  }
  btnImportClientJSON.onclick = ()=> fileClientJSON.click();
  fileClientJSON.onchange = async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    let obj={}; try{ obj=JSON.parse(await f.text()); }catch(e){ return alert('JSON invalide'); }
    const {db,s}=svc(); const map=new Map((s.items||[]).map(c=>[c.id,c]));
    (obj.decisions||[]).forEach(d=>{
      const card=map.get(d.cardId); if(!card) return;
      const prop=(card.propositions||[]).find(p=>p.pid===d.pid); if(!prop) return;
      if(!prop.decision) prop.decision={status:'pending',comment:''};
      if(d.decision) prop.decision.status=d.decision;
      if(typeof d.comment==='string') prop.decision.comment=d.comment;
      (card.history||(card.history=[])).push({ts:Date.now(),who:'client(import)',what:`${d.pid}=${prop.decision.status}${prop.decision.comment?' ('+prop.decision.comment+')':''}`});
      const all=(card.propositions||[]).every(x=>x.decision && x.decision.status && x.decision.status!=='pending');
      card.pipeline = all ? 'bouclee' : 'en_validation';
    });
    saveDB(db);
    clientFormState.textContent='R√©ponses import√©es ‚úî';
    if(document.getElementById('tab-projecteur') && !document.getElementById('tab-projecteur').classList.contains('hide')) renderProjector();
  };

  /* ------------------ PROXY TEST ------------------ */
  btnProxyTest.addEventListener("click", async ()=>{
    const url=(localStorage.getItem("paria_proxy_url")||"").trim(); if(!url){ alert("Renseigne PROXY_URL puis Sauver."); return; }
    proxyState.style.color="#555"; proxyState.textContent="Test‚Ä¶";
    try{
      const r1=await fetch(url); const j1=await r1.json(); const ok1=j1?.ok===true;
      const r2=await fetch(url,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({route:"echo",hello:"ping"})}); const j2=await r2.json(); const ok2=j2?.ok===true;
      proxyState.style.color = (ok1&&ok2) ? "#2d7" : "#a60";
      proxyState.textContent = (ok1&&ok2) ? "Proxy OK ‚úî" : `Proxy partiel (${ok1?"GET ok":"GET ko"}/${ok2?"POST ok":"POST ko"})`;
    }catch(e){ proxyState.style.color="#a00"; proxyState.textContent="Erreur"; alert("Proxy KO : "+String(e)); }
  });

  /* ------------------ IA (note -> card) ------------------ */
  async function iaAnalyze(){
    const svcKey = serviceKeyGit.value || "Compta";
    let charter={}; try{ const db=JSON.parse(localStorage.getItem("paria_db")||"{}"); charter = db.services?.[svcKey]?.charter || {}; }catch(e){}
    const PROXY_URL=(localStorage.getItem("paria_proxy_url")||"").trim(); if(!PROXY_URL){ alert("Renseigne PROXY_URL."); return; }
    const payload={ route:"analyze", model:"gpt-4o-mini", service_key:svcKey, charter, note: (noteInput.value||"") };
    iaStatus.textContent="Analyse en cours‚Ä¶";
    try{
      const r=await fetch(PROXY_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(payload)});
      const j=await r.json();
      if(!j.ok){ iaStatus.textContent="Erreur"; iaResult.textContent=JSON.stringify(j,null,2); alert("Analyse √©chou√©e : "+(j.error||"")); return; }
      iaStatus.textContent="OK ‚úî"; iaResult.textContent=JSON.stringify(j.data,null,2);
      localStorage.setItem("paria_last_ai", JSON.stringify(j.data));
    }catch(err){ iaStatus.textContent="Erreur r√©seau"; alert("Erreur appel proxy : "+String(err)); }
  }
  btnIaAnalyze.addEventListener("click", iaAnalyze);
  btnIaAdopt.addEventListener("click", ()=>{
    const raw=localStorage.getItem("paria_last_ai"); if(!raw) return alert("Fais d'abord ¬´ Analyser (IA) ¬ª.");
    let obj; try{ obj=JSON.parse(raw); }catch(e){ return alert("R√©sultat IA invalide."); }
    const svcKey = serviceKeyGit.value || "Compta";
    let db={services:{}}; try{ db=JSON.parse(localStorage.getItem("paria_db")||"{}"); }catch(e){}
    if(!db.services) db.services={};
    if(!db.services[svcKey]) db.services[svcKey]={ charter:{}, items:[], decisions:[], agenda:[] };
    // id/pid/pipeline minimum
    const s=db.services[svcKey];
    obj.id = obj.id || ("I"+( (s.items?.length||0)+1 ));
    (obj.propositions||[]).forEach((p,i)=> p.pid = p.pid || ("P"+(i+1)));
    obj.pipeline = obj.pipeline || "discovery";
    obj.priority = obj.priority || ( (obj.propositions?.length||0)>=3? "P1" : (obj.propositions?.length===2? "P2":"P3") );
    s.items = s.items||[]; s.items.push(obj);
    localStorage.setItem("paria_db", JSON.stringify(db));
    alert("Card ajout√©e au Board ‚úî");
  });

  /* ------------------ Dict√©e ------------------ */
  (function setupMic(){
    const btn = document.getElementById('btnMic'); if(!btn) return;
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ micState.textContent='(dict√©e non support√©e)'; btn.disabled=true; return; }
    const rec = new SR(); rec.lang='fr-FR'; rec.interimResults=true; rec.continuous=true;
    let listening=false;
    btn.onclick = ()=>{
      if(!listening){ rec.start(); listening=true; btn.textContent='‚ñ† Stop'; micState.textContent='√©coute‚Ä¶'; }
      else { rec.stop(); listening=false; btn.textContent='üéôÔ∏è Dicter'; micState.textContent=''; }
    };
    rec.onresult = (e)=>{ let txt=''; for(let i=e.resultIndex;i<e.results.length;i++){ txt += e.results[i][0].transcript; } noteInput.value = (noteInput.value+' '+txt).trim(); };
    rec.onend = ()=>{ if(listening){ rec.start(); } else { micState.textContent=''; btn.textContent='üéôÔ∏è Dicter'; } };
  })();

  /* ------------------ Board ------------------ */
  function svc(){
    const key = serviceKeyGit.value || "Compta";
    let db={}; try{ db=JSON.parse(localStorage.getItem("paria_db")||"{}"); }catch(e){}
    if(!db.services) db.services={};
    if(!db.services[key]) db.services[key]={ charter:{}, items:[], agenda:[] };
    return { key, db, s: db.services[key] };
  }
  function saveDB(db){ localStorage.setItem("paria_db", JSON.stringify(db)); }
  function renderBoard(){
    const {key,db,s}=svc();
    boardService.textContent = key;
    const cols={ discovery:col_discovery, pret_projecteur:col_pret, en_validation:col_valid, bouclee:col_done };
    Object.values(cols).forEach(c=>c.innerHTML='');
    (s.items||[]).forEach(card=>{
      const div=document.createElement('div');
      div.style.cssText='border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px;background:#fff';
      div.innerHTML=`
        <div style="display:flex;justify-content:space-between;align-items:center">
          <label><input type="checkbox" data-sel="${card.id}"> ${card.id} ¬∑ ${card.title||''}</label>
          <span style="opacity:.7">${card.priority||''}</span>
        </div>
        <div style="font-size:.9em;opacity:.8;margin:4px 0">‚úÖ ${['problemes','ameliorations','reconfigurations','integration_ia','actions'].map(k=>Array.isArray(card.paria?.[k])&&card.paria[k].length?'‚úì':'‚Ä¢').join(' ')}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button data-mv="left" data-c="${card.id}">‚óÄ</button>
          <button data-mv="right" data-c="${card.id}">‚ñ∂</button>
          <button data-ag="${card.id}">+ Agenda</button>
        </div>`;
      (cols[card.pipeline||'discovery']||cols.discovery).appendChild(div);
    });
    document.querySelectorAll('button[data-mv]').forEach(b=>{
      b.onclick=()=>{ const dir=b.getAttribute('data-mv'); moveCardPipeline(b.getAttribute('data-c'), dir==='left'?-1:1); renderBoard(); };
    });
    document.querySelectorAll('button[data-ag]').forEach(b=>{
      b.onclick=()=>{ addToAgenda(b.getAttribute('data-ag')); renderBoard(); };
    });
  }
  function moveCardPipeline(id,delta){
    const order=['discovery','pret_projecteur','en_validation','bouclee'];
    const {db,s}=svc();
    const c=s.items.find(x=>x.id===id); if(!c) return;
    const i=Math.max(0,Math.min(order.length-1,(order.indexOf(c.pipeline||'discovery')+delta)));
    c.pipeline=order[i]; saveDB(db);
  }
  function addToAgenda(id){
    const {db,s}=svc(); s.agenda=s.agenda||[]; if(!s.agenda.includes(id)) s.agenda.push(id); saveDB(db);
  }
  boardRefresh.onclick = renderBoard;
  boardAddToAgenda.onclick = ()=>{
    const {db,s}=svc(); s.agenda=s.agenda||[];
    document.querySelectorAll('input[data-sel]:checked').forEach(ch=>{ const id=ch.getAttribute('data-sel'); if(!s.agenda.includes(id)) s.agenda.push(id); });
    saveDB(db); alert('Ajout√© √† l‚ÄôAgenda.');
  };

  /* ------------------ Projecteur ------------------ */
  function chip(text){ return `<span style="border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin-right:6px">${text}</span>`; }
  function stateBadge(pipeline){ const map={discovery:'#A8B0B9',pret_projecteur:'#2463EB',en_validation:'#F59E0B',bouclee:'#10B981'}; const col=map[pipeline]||'#A8B0B9'; return `<span style="background:${col};color:#fff;border-radius:6px;padding:2px 8px">${pipeline||'‚Äî'}</span>`; }
  function renderProjector(){
    const {key,db,s}=svc();
    projServiceBadge.textContent = key;
    projWorkId.textContent = (localStorage.getItem('paria_work_id')||"");
    projWorkIdHdr.textContent = (localStorage.getItem('paria_work_id')||"‚Äî");
    projAgendaList.innerHTML='';
    (s.agenda||[]).forEach(cid=>{
      const item=s.items.find(x=>x.id===cid);
      const li=document.createElement('li'); li.style.margin='6px 0';
      li.innerHTML=`<a href="#" data-c="${cid}">${cid} ¬∑ ${(item?.title||'‚Äî')}</a><span style="float:right;opacity:.7">${item?.priority||''}</span>`;
      li.querySelector('a').onclick=(e)=>{ e.preventDefault(); showCard(cid); };
      projAgendaList.appendChild(li);
    });
    if(s.agenda?.length) showCard(s.agenda[0]); else projCard.innerHTML='<em>Ajoute des cards √† l‚ÄôAgenda dans le Board.</em>';
  }
  function showCard(cid){
    const {s}=svc();
    const card=s.items.find(x=>x.id===cid);
    if(!card){ projCard.innerHTML = `<em>Card ${cid} introuvable.</em>`; return; }
    const cc=(s.charter?.contraintes||'').trim();
    const chips = cc ? cc.split(/[;,‚Ä¢\n]/).map(x=>x.trim()).filter(Boolean).slice(0,4).map(chip).join(' ') : chip('‚Äî');
    function bl(label,arr){ if(!Array.isArray(arr)||!arr.length) return ''; return `<div><strong>${label}</strong><ul style="margin:6px 0 12px 20px">${arr.slice(0,4).map(x=>`<li>${x}</li>`).join('')}</ul></div>`; }
    const propsHTML=(card.propositions||[]).map((p,ix)=>{
      if(!p.pid) p.pid="P"+(ix+1);
      const d=p.decision||{status:'pending',comment:''};
      function btn(name,label){ const act=d.status===name?'font-weight:700;text-decoration:underline;':''; return `<button data-act="${name}" data-c="${card.id}" data-p="${p.pid}" style="margin-right:6px;${act}">${label}</button>`; }
      return `<div style="border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${p.pid}</strong> ¬∑ ${p.label||''}</div>
          <div>${btn('valide','Valider')}${btn('a_preciser','√Ä pr√©ciser')}${btn('refuse','Refuser')}</div>
        </div>
        <div style="opacity:.8;margin:4px 0">co√ªt:${p.indicateurs?.cout||'‚Äî'} ¬∑ complexit√©:${p.indicateurs?.complexite||'‚Äî'} ¬∑ formation:${p.indicateurs?.formation||'‚Äî'} ¬∑ embauche:${p.indicateurs?.embauche||'‚Äî'} ¬∑ donn√©es:${p.indicateurs?.donnees||'‚Äî'}</div>
        <label style="font-size:.9em;opacity:.8">Commentaire</label>
        <input type="text" data-comm="1" data-c="${card.id}" data-p="${p.pid}" value="${d.comment||''}" style="width:100%">
      </div>`;
    }).join('');
    projCard.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div style="font-size:18px;font-weight:700">${card.title||'(sujet √† nommer)'}</div>
          <div style="opacity:.8">${chip('Objectif: '+(card.objectif||'‚Äî'))} ${chip('Question: '+(card.question||'‚Äî'))}</div>
        </div>
        <div>${stateBadge(card.pipeline||'discovery')}</div>
      </div>
      <div style="margin:6px 0">${chips}</div>
      <div style="margin-top:10px;border-top:1px dashed #ddd;padding-top:8px">
        ${bl('Probl√®mes',card.paria?.problemes)}
        ${bl('Am√©liorations',card.paria?.ameliorations)}
        ${bl('Reconfigurations',card.paria?.reconfigurations)}
        ${bl('Int√©gration IA',card.paria?.integration_ia)}
        ${bl('Actions (brouillon)',card.paria?.actions)}
      </div>
      <h4 style="margin-top:10px">Propositions</h4>
      ${propsHTML}
      <div style="display:flex;justify-content:space-between;margin-top:8px">
        <button id="projPrev">‚óÄ Pr√©c√©dent</button>
        <button id="projNext">Suivant ‚ñ∂</button>
      </div>`;
    document.querySelectorAll('#projCard button[data-act]').forEach(btn=>{
      btn.onclick=()=>{ applyDecision(btn.getAttribute('data-c'), btn.getAttribute('data-p'), btn.getAttribute('data-act'), null); showCard(card.id); };
    });
    document.querySelectorAll('#projCard input[data-comm]').forEach(inp=>{
      inp.onchange=()=>{ applyDecision(inp.getAttribute('data-c'), inp.getAttribute('data-p'), null, inp.value); };
    });
    projPrev.onclick = ()=>{
      const idx=(s.agenda||[]).indexOf(card.id); if(idx>0) showCard(s.agenda[idx-1]);
    };
    projNext.onclick = ()=>{
      const idx=(s.agenda||[]).indexOf(card.id); if(idx>=0 && idx<s.agenda.length-1) showCard(s.agenda[idx+1]);
    };
  }
  function applyDecision(cardId,pid,statusOrNull,commentOrNull){
    const {db,s}=svc();
    const card=s.items.find(x=>x.id===cardId); if(!card) return;
    const p=(card.propositions||[]).find(x=>x.pid===pid); if(!p) return;
    if(!p.decision) p.decision={status:'pending',comment:''};
    if(statusOrNull) p.decision.status=statusOrNull;
    if(commentOrNull!==null) p.decision.comment=commentOrNull;
    const all=(card.propositions||[]).every(x=>x.decision && x.decision.status && x.decision.status!=='pending');
    card.pipeline = all ? 'bouclee' : 'en_validation';
    (card.history||(card.history=[])).push({ts:Date.now(),who:'client',what:`${pid}=${p.decision.status}${p.decision.comment?' ('+p.decision.comment+')':''}`});
    saveDB(db);
  }
  projAgendaRefresh.onclick = renderProjector;
  projSync.onclick = renderProjector;
  projMode.onchange = function(){ const on=this.checked; document.body.style.background = on ? '#fff': ''; projCard.style.fontSize = on ? '18px' : ''; };

  /* ------------------ Charter load/save ------------------ */
  function getSvcKey(){ return serviceKeyGit.value || "Compta"; }
  function loadCharterToEditor(){
    const svc=getSvcKey();
    let s=null; try{ const db=JSON.parse(localStorage.getItem("paria_db")||"{}"); s=db.services?.[svc]||null; }catch(e){}
    const ch = (s&&s.charter) ? s.charter : {};
    ed_obj.value=ch.objectifs||""; ed_ctx.value=ch.contexte||""; ed_hard.value=ch.contraintes||"";
    ed_scope.value=ch.perimetre||""; ed_pains.value=ch.douleurs||""; ed_kpi.value=ch.kpis||"";
    ed_tools.value=ch.outils||""; ed_roles.value=ch.roles||""; ed_budget.value=ch.budget||"";
    charterState.textContent="Charg√© ‚úî";
  }
  function saveEditorToCharter(){
    const svc=getSvcKey();
    let db={services:{}}; try{ db=JSON.parse(localStorage.getItem("paria_db")||"{}"); }catch(e){}
    if(!db.services) db.services={};
    if(!db.services[svc]) db.services[svc]={ charter:{}, items:[], decisions:[], agenda:[] };
    db.services[svc].charter = {
      objectifs: ed_obj.value.trim(), contexte: ed_ctx.value.trim(), contraintes: ed_hard.value.trim(),
      perimetre: ed_scope.value.trim(), douleurs: ed_pains.value.trim(), kpis: ed_kpi.value.trim(),
      outils: ed_tools.value.trim(), roles: ed_roles.value.trim(), budget: ed_budget.value.trim()
    };
    localStorage.setItem("paria_db", JSON.stringify(db));
    renderWorkSummary();
    charterState.textContent="Sauvegard√© ‚úî (pense √† Push .json)";
  }
  btnCharterLoad.addEventListener("click", loadCharterToEditor);
  btnCharterSave.addEventListener("click", saveEditorToCharter);

  /* ------------------ Proxy Ping ------------------ */
  // (d√©j√† c√¢bl√© via btnProxyTest)

  // Default tab
  showTab("reglages");
})();
</script>
</body>
</html>
