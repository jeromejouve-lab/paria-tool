<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PARIA ‚Äî Workbench</title>
<style>
  :root{--line:#e6e6e6;--bg:#f7f7f8;--ink:#222}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  header{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}

  .status-pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:12px}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.pending{background:#9aa3af}
  .dot.a_preciser{background:#f59e0b}
  .dot.valide{background:#10b981}
  .dot.refuse{background:#ef4444}

  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tabs button{background:#fff;border:1px solid var(--line);padding:8px 12px;border-radius:10px;cursor:pointer}
  .tabs button.active{background:#222;color:#fff;border-color:#222}
  .spacer{flex:1}
  .ctx{font-size:12px;opacity:.75}
  main{padding:12px;display:grid;gap:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .row{display:grid;gap:12px}
  @media(min-width:960px){ .row{grid-template-columns:1fr 1fr} }
  label{display:block;font-size:12px;color:#555;margin:6px 0 4px}
  textarea,input,select,button{font-size:14px}
  textarea{width:100%;min-height:100px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid #ddd;background:#fafafa}
  .hide{display:none}
  /* Projecteur dans l‚Äôonglet */
  #projAgenda{border:1px solid #ddd;border-radius:10px;padding:10px;max-height:70vh;overflow:auto}
  #projCard{border:1px solid #ddd;border-radius:10px;padding:16px;min-height:60vh;background:#fff}
  /* Projecteur en standalone */
  .full{max-width:1100px;margin:0 auto;padding:16px}
</style>
</head>
<body>

<header>
  <div class="tabs" id="tabbar">
    <button class="tabbtn active" data-tab="reglages">R√©glages</button>
    <button class="tabbtn" data-tab="capture">Capture</button>
    <button class="tabbtn" data-tab="analyse">Analyse</button>
    <button class="tabbtn" data-tab="projecteur">Projecteur</button>
  </div>
  <div class="spacer"></div>
  <div class="ctx">Service: 
    <select id="serviceKey">
      <option>Direction</option><option>RH</option><option selected>Compta</option>
      <option>IT</option><option>Marketing</option><option>Ventes</option>
    </select>
    &nbsp;|&nbsp; Work ID: <span id="workIdHdr">‚Äî</span>
  </div>
</header>

<main>
  <!-- R√âGLAGES -->
  <section id="tab-reglages" class="card">
    <h3>R√©glages / Persistance</h3>
    <div class="row">
      <div class="card">
        <h4>Google Apps Script (proxy)</h4>
        <label>DEPLOY URL</label>
        <input id="GAS_URL" placeholder="https://script.google.com/macros/s/AKfycb.../exec">
        <div class="actions">
          <button id="btnSaveCfg">Sauver</button>
          <button id="btnTestProxy">Tester</button>
          <span id="proxyState" class="pill">‚Äî</span>
        </div>
        <small>Le proxy g√®re : <code>route=analyze|save|load|echo</code>.</small>
      </div>
      <div class="card">
        <h4>Work ID (Client ¬∑ Service ¬∑ Date)</h4>
        <label>Client</label><input id="workClient" placeholder="ACME">
        <label>Date</label><input id="workDate" type="date">
        <div class="actions">
          <button id="btnBindWork">Lier ce Work ID</button>
          <span id="workBindState" class="pill">‚Äî</span>
        </div>
        <small>Le Work ID est m√©moris√© et visible en haut. Il permet de r√©-ouvrir la m√™me s√©ance.</small>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h4>Charger / Sauver (Apps Script)</h4>
        <div class="actions">
          <button id="btnLoad">Charger depuis Google</button>
          <button id="btnSave">Sauver vers Google</button>
          <span id="gsState" class="pill">‚Äî</span>
        </div>
      </div>
      <div class="card">
        <h4>√âtat local</h4>
        <div class="actions">
          <button id="btnDump">Voir JSON</button>
          <button id="btnClear">R√©initialiser local</button>
        </div>
        <pre id="dump" style="max-height:240px;overflow:auto;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:8px"></pre>
      </div>
    </div>
  </section>

  <!-- CAPTURE -->
  <section id="tab-capture" class="card hide">
    <div class="row">
      <div class="card">
        <h3>Service Charter</h3>
        <label>Objectifs</label><textarea id="ch_obj"></textarea>
        <label>Contexte & contraintes</label><textarea id="ch_ctx"></textarea>
        <label>P√©rim√®tre</label><textarea id="ch_scope"></textarea>
        <label>Contraintes strictes</label><textarea id="ch_hard"></textarea>
        <label>Douleurs (top 3)</label><textarea id="ch_pains"></textarea>
        <label>KPI</label><textarea id="ch_kpi"></textarea>
        <label>Outils</label><textarea id="ch_tools"></textarea>
        <label>R√¥les & charge</label><textarea id="ch_roles"></textarea>
        <label>Budget & fen√™tre</label><textarea id="ch_budget"></textarea>
        <div class="actions">
          <button id="btnCharterToState">Sauver dans l‚Äô√©tat</button>
          <button id="btnCharterFromState">Charger de l‚Äô√©tat</button>
          <span id="charterState" class="pill">‚Äî</span>
        </div>
      </div>

      <div class="card">
        <h3>Note ‚Üí Analyse IA</h3>
        <div class="actions">
          <button id="btnMic">üéôÔ∏è Dicter</button>
          <span id="micStatus" class="pill">‚Äî</span>
        </div>
        <textarea id="note" placeholder="Parle ou tape ici‚Ä¶"></textarea>
        <div class="actions">
          <button id="btnAnalyze">Analyser (AI)</button>
          <span id="aiState" class="pill">‚Äî</span>
        </div>
        <h4>R√©sultat</h4>
        <pre id="analysis" style="white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:8px;max-height:260px;overflow:auto">‚Äî</pre>
      </div>
    </div>
  </section>

  <!-- ANALYSE / D√âCISIONS -->
  <section id="tab-analyse" class="card hide">
    <div class="row">
      <div class="card">
        <h3>Dernier item (r√©formulation & PARIA)</h3>
        <pre id="lastItem" style="white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:8px;max-height:300px;overflow:auto">‚Äî</pre>
        <div class="actions">
          <button data-status="valide"  class="decide">Valider</button>
          <button data-status="a_preciser" class="decide">√Ä pr√©ciser</button>
          <button data-status="refuse" class="decide">Refuser</button>
          <span id="decState" class="pill">‚Äî</span>
        </div>
      </div>

      <div class="card">
        <h3>D√©cisions (journal)</h3>
        <div id="decisions"></div>
        <div class="actions" style="margin-top:8px">
          <button id="btnExportMd">Exporter Markdown</button>
          <span id="expState" class="pill">‚Äî</span>
        </div>
      </div>
    </div>
  </section>

  <!-- PROJECTEUR (dans la page) -->
  <section id="tab-projecteur" class="card hide">
    <div class="actions" style="justify-content:space-between">
      <div>
        <strong>Projecteur (pr√©visualisation)</strong>
      </div>
      <div class="actions">
        <button id="btnOpenProjector">Ouvrir le Projecteur (nouvel onglet)</button>
      </div>
    </div>

    <div class="row">
      <aside id="projAgenda" class="card">
        <h4>Agenda (simpliÔ¨Å√© : dernier item)</h4>
        <ol id="projAgendaList"></ol>
      </aside>

      <div id="projCard" class="card">
        <em>Analyse un item dans ‚ÄúCapture‚Äù pour l‚Äôafficher ici, ou ouvre le Projecteur.</em>
      </div>
    </div>
  </section>
</main>

<script>
/* ====== CONFIG ====== */
const MODEL = 'gpt-4o-mini';
const GAS_KEY = 'paria_gas_url';
const DB_KEY  = 'paria_db';
const WORK_KEY = 'paria_work_id'; // "ACME|Compta|2025-08-28"

function gasUrl(){ return (localStorage.getItem(GAS_KEY)||'').trim(); }
function setGasUrl(u){ localStorage.setItem(GAS_KEY,u.trim()); }

/* ====== √âTAT LOCAL ====== */
let db = { services:{} }; // services[key]={ charter:{}, items:[], decisions:[] }
function currentService(){ return document.getElementById('serviceKey').value; }
function svc(){
  const k=currentService();
  if(!db.services[k]) db.services[k]={ charter:{}, items:[], decisions:[] };
  return db.services[k];
}
function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function loadDB(){ try{ db = JSON.parse(localStorage.getItem(DB_KEY)||'{"services":{}}'); }catch(e){ db={services:{}}; } }

/* ====== ONGLETING ====== */
const tabs = ['reglages','capture','analyse','projecteur'];
function showTab(id){
  tabs.forEach(t=>{
    document.getElementById('tab-'+t).classList.toggle('hide', t!==id);
  });
  document.querySelectorAll('.tabbtn').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  // Render hooks
  if(id==='analyse') renderLastItem();
  if(id==='projecteur') renderProjectorInline();
}
document.querySelectorAll('.tabbtn').forEach(b=>b.onclick=()=>showTab(b.dataset.tab));

/* ====== WORK ID ====== */
function currentWorkId(){
  const c = (document.getElementById('workClient').value||'').trim() || 'CLIENT';
  const s = currentService();
  const d = (document.getElementById('workDate').value||'').trim() || new Date().toISOString().slice(0,10);
  return `${c}|${s}|${d}`;
}
function bindWork(){
  const id = currentWorkId();
  localStorage.setItem(WORK_KEY, id);
  document.getElementById('workIdHdr').textContent = id;
  document.getElementById('workBindState').textContent = 'li√© ‚úî';
}

/* ====== R√âGLAGES UI ====== */
(function bootCfg(){
  document.getElementById('GAS_URL').value = gasUrl();
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('workDate').value = today;
  const wid = localStorage.getItem(WORK_KEY)||'‚Äî';
  document.getElementById('workIdHdr').textContent = wid;
})();
document.getElementById('btnSaveCfg').onclick = ()=>{
  setGasUrl(document.getElementById('GAS_URL').value);
  alert('R√©glages sauvegard√©s.');
};
document.getElementById('btnTestProxy').onclick = async ()=>{
  const u=gasUrl(); if(!u) return alert('Renseigne le DEPLOY URL.');
  try{
    const r1=await fetch(u+'?route=echo'); const j1=await r1.json();
    const r2=await fetch(u,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({route:'echo',hello:'world'})}); const j2=await r2.json();
    document.getElementById('proxyState').textContent = (j1.ok&&j2.ok)?'OK ‚úî':'Partiel';
  }catch(e){ document.getElementById('proxyState').textContent='Erreur'; }
};
document.getElementById('btnBindWork').onclick = bindWork;

/* ====== LOAD / SAVE (Apps Script) ====== */
document.getElementById('btnLoad').onclick = async ()=>{
  const u=gasUrl(); if(!u) return alert('Proxy non configur√©.');
  const service=currentService();
  const r = await fetch(`${u}?route=load&service=${encodeURIComponent(service)}`);
  const j = await r.json();
  if(j?.ok && j.data){
    db.services[service]=j.data;
    saveDB();
    hydrateCharter();
    document.getElementById('gsState').textContent='Charg√© ‚úî';
  }else alert('Rien √† charger.');
};
document.getElementById('btnSave').onclick = async ()=>{
  const u=gasUrl(); if(!u) return alert('Proxy non configur√©.');
  const service=currentService();
  const body={route:'save', service, data: db.services[service]||{charter:{},items:[],decisions:[]}};
  const r=await fetch(u,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(body)});
  const j=await r.json();
  document.getElementById('gsState').textContent = j.ok ? 'Sauv√© ‚úî' : 'Erreur';
};

/* ====== DUMP / CLEAR ====== */
document.getElementById('btnDump').onclick = ()=>{
  document.getElementById('dump').textContent = JSON.stringify(db,null,2);
};
document.getElementById('btnClear').onclick = ()=>{
  if(confirm('Effacer l‚Äô√©tat local ?')){ localStorage.removeItem(DB_KEY); loadDB(); document.getElementById('dump').textContent='‚Äî'; alert('R√©initialis√©.'); }
};

/* ====== CHARTER ====== */
function hydrateCharter(){
  const ch = (svc().charter||{});
  ch_obj.value = ch.objectifs||''; ch_ctx.value=ch.contexte||''; ch_scope.value=ch.perimetre||'';
  ch_hard.value = ch.contraintes||''; ch_pains.value=ch.douleurs||''; ch_kpi.value=ch.kpis||'';
  ch_tools.value=ch.outils||''; ch_roles.value=ch.roles||''; ch_budget.value=ch.budget||'';
  document.getElementById('charterState').textContent='Charg√© ‚úî';
}
document.getElementById('btnCharterFromState').onclick = hydrateCharter;
document.getElementById('btnCharterToState').onclick = ()=>{
  const s=svc();
  s.charter = {
    objectifs: ch_obj.value.trim(), contexte: ch_ctx.value.trim(), perimetre: ch_scope.value.trim(),
    contraintes: ch_hard.value.trim(), douleurs: ch_pains.value.trim(), kpis: ch_kpi.value.trim(),
    outils: ch_tools.value.trim(), roles: ch_roles.value.trim(), budget: ch_budget.value.trim()
  };
  saveDB();
  document.getElementById('charterState').textContent='Sauv√© ‚úî';
};

/* ====== DICT√âE ====== */
(function setupMic(){
  const btn = document.getElementById('btnMic');
  const st  = document.getElementById('micStatus');
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ st.textContent='(non support√©e)'; return; }
  const rec=new SR(); rec.lang='fr-FR'; rec.interimResults=true; rec.continuous=true;
  let on=false;
  btn.onclick=()=>{
    if(!on){ rec.start(); on=true; st.textContent='√âcoute‚Ä¶'; btn.textContent='‚ñ† Stop'; }
    else { rec.stop(); on=false; st.textContent='‚Äî'; btn.textContent='üéôÔ∏è Dicter'; }
  };
  rec.onresult=(e)=>{ let txt=''; for(let i=e.resultIndex;i<e.results.length;i++){ txt+=e.results[i][0].transcript; } note.value=(note.value+' '+txt).trim(); };
  rec.onend=()=>{ if(on) rec.start(); else { st.textContent='‚Äî'; btn.textContent='üéôÔ∏è Dicter'; } };
})();

/* ====== ANALYSE (Apps Script -> OpenAI) ====== */
document.getElementById('btnAnalyze').onclick = async ()=>{
  const u=gasUrl(); if(!u) return alert('Proxy non configur√©.');
  const s=svc();
  const payload={ route:'analyze', model:MODEL, service_key: currentService(), charter: s.charter, note: note.value||'' };
  document.getElementById('aiState').textContent='Analyse‚Ä¶';
  try{
    const r=await fetch(u,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)});
    const j=await r.json();
    if(!j.ok) throw new Error(j.error||'analyse KO');
    const item=j.data;
    const s=svc();
    item.id = item.id || ('I'+((s.items?.length||0)+1));
    item.title = item.title || (item.reformulation ? item.reformulation.slice(0,80) : 'Sujet √† pr√©ciser');
    (item.propositions||[]).forEach((p,i)=>{
      p.pid = p.pid || ('P'+(i+1));
      p.decision = p.decision || { status:'a_preciser', comment:'' };
    });
    item.pipeline = item.pipeline || 'pret_projecteur'; // pr√™t √† projeter direct
    item.priority = item.priority || 'P2';
    
    // 2) push + save
    s.items.push(item);
    saveDB();
    
    // 3) UI
    analysis.textContent = JSON.stringify(item,null,2);
    aiState.textContent='OK ‚úî';
    localStorage.setItem('paria_touch', String(Date.now()));
  }catch(e){
    document.getElementById('aiState').textContent='Erreur';
    alert('Analyse √©chou√©e: '+e.message);
  }
};

/* ====== D√âCISIONS ====== */
function renderLastItem(){
  const s=svc();
  const it = (s.items||[])[(s.items||[]).length-1];
  const el=document.getElementById('lastItem');
  if(!it){ el.textContent='‚Äî'; return; }
  el.textContent = JSON.stringify({
    id: it.id, title: it.title||it.reformulation||'', paria: it.paria||{}, propositions: it.propositions||[], questions: it.questions||[]
  },null,2);
}
document.querySelectorAll('.decide').forEach(b=>{
  b.onclick=()=>{
    const s=svc(); const it=(s.items||[])[(s.items||[]).length-1]; if(!it) return;
    (s.decisions||(s.decisions=[])).push({ ts:Date.now(), status:b.dataset.status, item:{ id:it.id, reformulation: it.reformulation||it.title||'' }});
    saveDB(); renderDecisions(); document.getElementById('decState').textContent='Not√© ‚úî';
    localStorage.setItem('paria_touch', String(Date.now()));
  };
});
function renderDecisions(){
  const s=svc(), el=document.getElementById('decisions');
  if(!s.decisions?.length){ el.innerHTML='<em>Aucune d√©cision.</em>'; return; }
  el.innerHTML = s.decisions.slice().reverse().map(d=>{
    return `<div class="pill">${new Date(d.ts).toLocaleString()} ‚Äî <b>${d.status}</b> ‚Äî ${d.item?.reformulation||''}</div>`;
  }).join('');
}
document.getElementById('btnExportMd').onclick=()=>{
  const key=currentService(); const s=svc();
  const md = makeMarkdown(key,s);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([md],{type:'text/markdown'}));
  a.download=`audit_${key}_${new Date().toISOString().slice(0,10)}.md`; a.click();
  document.getElementById('expState').textContent='Export√© ‚úî';
};
function makeMarkdown(key,s){
  const L=[]; L.push(`# Audit ${key} ‚Äî PARIA`,'','## Service Charter');
  for(const [k,v] of Object.entries(s.charter||{})) L.push(`- **${k}**: ${v||'-'}`);
  L.push('','## Analyses');
  (s.items||[]).forEach((it,i)=>{
    L.push(`### Item #${i+1} (${it.id})`);
    if(it.reformulation) L.push(`Reformulation: ${it.reformulation}`);
    const b=it.paria||{};
    for(const k of ['problemes','ameliorations','reconfigurations','integration_ia','actions']){
      if(b[k]?.length){ L.push(`- **${k}**:`); b[k].forEach(x=>L.push(`  - ${x}`)); }
    }
    if(it.questions?.length){ L.push(`- **Questions**:`); it.questions.forEach(q=>L.push(`  - ${q}`)); }
    if(it.propositions?.length){
      L.push(`- **Propositions**:`); it.propositions.forEach(p=>L.push(`  - ${p.pid||''} ${p.label} ‚Äî ${p.type} [${p.indicateurs?.cout||'-'}/${p.indicateurs?.complexite||'-'}]`));
    }
    L.push('');
  });
  L.push('## D√©cisions');
  (s.decisions||[]).forEach(d=>L.push(`- ${new Date(d.ts).toLocaleString()} ‚Äî **${d.status}** ‚Äî ${d.item?.reformulation||''}`));
  return L.join('\n');
}

/* ====== PROJECTEUR : inline + nouvel onglet ====== */
function chip(t){ return `<span style="border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin-right:6px">${t}</span>`; }
function stateBadge(p){ const map={discovery:'#A8B0B9',pret_projecteur:'#2463EB',en_validation:'#F59E0B',bouclee:'#10B981'}; const c=map[p]||'#A8B0B9'; return `<span style="background:${c};color:#fff;border-radius:6px;padding:2px 8px">${p||'‚Äî'}</span>`; }

function renderProjectorInline(){
  const s=svc();
  const it=(s.items||[])[(s.items||[]).length-1];
  const list=document.getElementById('projAgendaList');
  const card=document.getElementById('projCard');
  list.innerHTML = it ? `<li><a href="#" onclick="return false;">${it.id} ¬∑ ${it.title||it.reformulation||''}</a></li>` : '<li>‚Äî</li>';
  if(!it){ card.innerHTML='<em>Aucun item.</em>'; return; }
  const chips = (s.charter?.contraintes||'').split(/[;,‚Ä¢\n]/).map(x=>x.trim()).filter(Boolean).slice(0,4).map(chip).join(' ') || chip('‚Äî');
  function pill(dec){ const st=(dec?.status)||'pending';
    return `<span class="status-pill"><span class="dot ${st}"></span>${st.replace('_',' ')}</span>`;
  }
  
  const props = (it.propositions||[]).map((p,i)=>`
    <div style="border:1px solid #eee;border-radius:8px;padding:10px;margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${p.pid||('P'+(i+1))}</strong> ¬∑ ${p.label||''} &nbsp; ${pill(p.decision)}</div>
        <div>
          <button class="pact" data-act="valide" data-c="${it.id}" data-p="${p.pid||('P'+(i+1))}" style="margin-right:6px">Valider</button>
          <button class="pact" data-act="a_preciser" data-c="${it.id}" data-p="${p.pid||('P'+(i+1))}" style="margin-right:6px">√Ä pr√©ciser</button>
          <button class="pact" data-act="refuse" data-c="${it.id}" data-p="${p.pid||('P'+(i+1))}">Refuser</button>
        </div>
      </div>
      <div style="opacity:.8;margin:4px 0">co√ªt:${p.indicateurs?.cout||'‚Äî'} ¬∑ complexit√©:${p.indicateurs?.complexite||'‚Äî'} ¬∑ embauche:${p.indicateurs?.embauche||'‚Äî'}</div>
      <label style="font-size:.9em;opacity:.8">Commentaire</label>
      <input type="text" class="pcmt" data-c="${it.id}" data-p="${p.pid||('P'+(i+1))}" value="${p.decision?.comment||''}" style="width:100%">
    </div>`).join('');
  
  // Listeners
  card.querySelectorAll('.pact').forEach(b=>{
    b.onclick=()=>{
      const act=b.dataset.act, c=b.dataset.c, p=b.dataset.p;
      const s=svc(); const it=s.items.find(x=>x.id===c); if(!it) return;
      const prop=(it.propositions||[]).find(x=>x.pid===p); if(!prop) return;
      prop.decision = prop.decision || {status:'a_preciser',comment:''};
      prop.decision.status=act;
      const all=(it.propositions||[]).every(x=>x.decision && x.decision.status && x.decision.status!=='pending');
      it.pipeline = all ? 'bouclee' : 'en_validation';
      saveDB(); localStorage.setItem('paria_touch', String(Date.now()));
      renderProjectorInline();
    };
  });
  card.querySelectorAll('.pcmt').forEach(inp=>{
    inp.onchange=()=>{
      const c=inp.dataset.c, p=inp.dataset.p;
      const s=svc(); const it=s.items.find(x=>x.id===c); if(!it) return;
      const prop=(it.propositions||[]).find(x=>x.pid===p); if(!prop) return;
      prop.decision = prop.decision || {status:'a_preciser',comment:''};
      prop.decision.comment = inp.value;
      saveDB(); localStorage.setItem('paria_touch', String(Date.now()));
    };
  });

  function block(label,arr){ if(!Array.isArray(arr)||!arr.length) return ''; return `<div><strong>${label}</strong><ul style="margin:6px 0 12px 20px">${arr.slice(0,4).map(x=>`<li>${x}</li>`).join('')}</ul></div>`; }
}

document.getElementById('btnOpenProjector').onclick = ()=>{
  const url = new URL(location.href);
  url.searchParams.set('projecteur','1');
  window.open(url.toString(),'projecteur_'+(localStorage.getItem(WORK_KEY)||''), 'noopener');
};

/* ====== BOOT ====== */
loadDB();
hydrateCharter();
renderDecisions();
renderLastItem();

/* ====== ROUTAGE : Projecteur en nouvel onglet ======
   Si on ouvre la page avec ?projecteur=1, on affiche uniquement le projecteur (plein √©cran),
   on lit le m√™me localStorage et on √©coute les √©v√©nements 'storage' pour rafra√Æchir. */

/* ====== Projecteur standalone interactif ====== */
(function maybeStandaloneProjector(){
  const params = new URL(location.href).searchParams;
  if(params.get('projecteur')!=='1') return;

  const DB_KEY   = 'paria_db';
  const WORK_KEY = 'paria_work_id';

  // Helpers localStorage
  function loadDB(){ try{ return JSON.parse(localStorage.getItem(DB_KEY)||'{"services":{}}'); }catch(e){ return {services:{}}; } }
  function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); localStorage.setItem('paria_touch', String(Date.now())); }

  // UI minimal plein √©cran
  document.body.innerHTML = `
    <div class="full" style="max-width:1200px;margin:0 auto;padding:16px;font-size:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><strong>Projecteur</strong> ‚Äî <span id="p_hdr">‚Äî</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="p_prev">‚óÄ</button>
          <button id="p_next">‚ñ∂</button>
          <button id="p_big">A+</button>
          <button id="p_small">A‚àí</button>
          <button id="p_toggle_agenda">Afficher/Masquer Agenda</button>
          <small style="opacity:.7">Astuce: F11 plein √©cran ¬∑ ‚Üê/‚Üí navigate ¬∑ 1/2/3 d√©cider</small>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:280px 1fr;gap:16px">
        <aside id="p_agenda" style="border:1px solid #ddd;border-radius:10px;padding:10px;max-height:74vh;overflow:auto"></aside>
        <main id="p_card" style="border:1px solid #ddd;border-radius:10px;padding:16px;min-height:70vh;background:#fff"></main>
      </div>
    </div>
  `;

  const hdr   = document.getElementById('p_hdr');
  const agenda= document.getElementById('p_agenda');
  const card  = document.getElementById('p_card');
  const btnPrev = document.getElementById('p_prev');
  const btnNext = document.getElementById('p_next');
  const btnBig  = document.getElementById('p_big');
  const btnSmall= document.getElementById('p_small');
  const btnTogA = document.getElementById('p_toggle_agenda');

  function chip(t){ return `<span style="border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin-right:6px">${t}</span>`; }
  function stateBadge(p){ const map={discovery:'#A8B0B9',pret_projecteur:'#2463EB',en_validation:'#F59E0B',bouclee:'#10B981'}; const c=map[p]||'#A8B0B9'; return `<span style="background:${c};color:#fff;border-radius:6px;padding:2px 8px">${p||'‚Äî'}</span>`; }
  function block(label,arr){ if(!Array.isArray(arr)||!arr.length) return ''; return `<div><strong>${label}</strong><ul style="margin:6px 0 12px 22px">${arr.slice(0,6).map(x=>`<li>${x}</li>`).join('')}</ul></div>`; }

  let state = { db: loadDB(), svcKey: null, svc: null, agendaIds: [], idx: 0 };

  function deriveServiceFromWorkId(){
    const wid = localStorage.getItem(WORK_KEY)||'';
    const parts = wid.split('|');
    return parts[1] || Object.keys(state.db.services||{})[0] || 'Compta';
  }

  function computeAgenda(){
    const items = state.svc.items||[];
    const ag = Array.isArray(state.svc.agenda)&&state.svc.agenda.length ? state.svc.agenda.slice() : items.map(x=>x.id);
    return ag.filter(id => items.some(x=>x.id===id));
  }

  function renderAgenda(){
    const items = state.svc.items||[];
    agenda.innerHTML = `<h4 style="margin:0 0 8px 0">Agenda</h4>` +
      `<ol style="margin:0;padding-left:18px">` +
      state.agendaIds.map((cid,i)=>{
        const it = items.find(x=>x.id===cid);
        const cur = (i===state.idx) ? 'font-weight:700;text-decoration:underline;' : '';
        return `<li style="margin:6px 0"><a href="#" data-i="${i}" style="${cur}">const label = (it?.title || it?.reformulation || '‚Äî');</a></li>`;
      }).join('') + `</ol>`;
    agenda.querySelectorAll('a[data-i]').forEach(a=>{
      a.onclick = (e)=>{ e.preventDefault(); state.idx = parseInt(a.dataset.i,10)||0; renderCard(); };
    });
  }

  function decide(cardId, pid, status, comment){
    const items = state.svc.items||[];
    const it = items.find(x=>x.id===cardId); if(!it) return;
    const p  = (it.propositions||[]).find(pp=>pp.pid===pid); if(!p) return;
    p.decision = p.decision || {status:'pending', comment:''};
    if(status) p.decision.status = status;
    if(comment!==undefined) p.decision.comment = comment;
    const all = (it.propositions||[]).every(x=>x.decision && x.decision.status && x.decision.status!=='pending');
    it.pipeline = all ? 'bouclee' : 'en_validation';
    // historisation light (facultatif)
    (it.history||(it.history=[])).push({ts:Date.now(), who:'client', what:`${pid}=${p.decision.status}${p.decision.comment?' ('+p.decision.comment+')':''}`});
    saveDB(state.db);
    renderCard(); // refresh local
  }

  function renderCard(){
    const items = state.svc.items||[];
    if(!state.agendaIds.length){ card.innerHTML = '<em>Aucun item.</em>'; return; }
    if(state.idx<0) state.idx=0;
    if(state.idx>=state.agendaIds.length) state.idx = state.agendaIds.length-1;

    const cid = state.agendaIds[state.idx];
    const it  = items.find(x=>x.id===cid);
    if(!it){ card.innerHTML='<em>Item introuvable.</em>'; return; }

    const chips = (state.svc.charter?.contraintes||'').split(/[;,‚Ä¢\n]/).map(x=>x.trim()).filter(Boolean).slice(0,4).map(chip).join(' ') || chip('‚Äî');

    const props = (it.propositions||[]).map((p,i)=>`
      <div style="border:1px solid #eee;border-radius:8px;padding:10px;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${p.pid||('P'+(i+1))}</strong> ¬∑ ${p.label||''}</div>
          <div>
            <button class="pact" data-c="${it.id}" data-p="${p.pid}" data-act="valide" style="margin-right:6px">Valider</button>
            <button class="pact" data-c="${it.id}" data-p="${p.pid}" data-act="a_preciser" style="margin-right:6px">√Ä pr√©ciser</button>
            <button class="pact" data-c="${it.id}" data-p="${p.pid}" data-act="refuse">Refuser</button>
          </div>
        </div>
        <div style="opacity:.8;margin:4px 0">co√ªt:${p.indicateurs?.cout||'‚Äî'} ¬∑ complexit√©:${p.indicateurs?.complexite||'‚Äî'} ¬∑ embauche:${p.indicateurs?.embauche||'‚Äî'} ¬∑ donn√©es:${p.indicateurs?.donnees||'‚Äî'}</div>
        <label style="font-size:.9em;opacity:.8">Commentaire</label>
        <input type="text" class="pcmt" data-c="${it.id}" data-p="${p.pid}" value="${p.decision?.comment||''}" style="width:100%">
      </div>
    `).join('');

    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div style="font-size:22px;font-weight:700">${it.title||it.reformulation||'(sujet √† nommer)'}</div>
          <div style="opacity:.8">${chip('Objectif: '+(it.objectif||'‚Äî'))} ${chip('Question: '+(it.question||'‚Äî'))}</div>
        </div>
        <div>${stateBadge(it.pipeline||'discovery')}</div>
      </div>
      <div style="margin:6px 0">${chips}</div>
      <div style="margin-top:10px;border-top:1px dashed #ddd;padding-top:8px">
        ${block('Probl√®mes', it.paria?.problemes)}
        ${block('Am√©liorations', it.paria?.ameliorations)}
        ${block('Reconfigurations', it.paria?.reconfigurations)}
        ${block('Int√©gration IA', it.paria?.integration_ia)}
        ${block('Actions (brouillon)', it.paria?.actions)}
      </div>
      <h3 style="margin-top:10px">Propositions</h3>
      ${props}
      <div style="display:flex;justify-content:space-between;margin-top:8px">
        <button id="p_prev2">‚óÄ Pr√©c√©dent</button>
        <div>${state.idx+1}/${state.agendaIds.length}</div>
        <button id="p_next2">Suivant ‚ñ∂</button>
      </div>
    `;

    // Actions
    card.querySelectorAll('.pact').forEach(b=>{
      b.onclick = ()=> decide(b.dataset.c, b.dataset.p, b.dataset.act);
    });
    card.querySelectorAll('.pcmt').forEach(inp=>{
      inp.onchange = ()=> decide(inp.dataset.c, inp.dataset.p, null, inp.value);
    });
    document.getElementById('p_prev2').onclick = ()=> { state.idx=Math.max(0,state.idx-1); renderCard(); };
    document.getElementById('p_next2').onclick = ()=> { state.idx=Math.min(state.agendaIds.length-1,state.idx+1); renderCard(); };
  }

  function renderAll(){
    state.db = loadDB();
    state.svcKey = deriveServiceFromWorkId();
    state.svc    = state.db.services[state.svcKey] || {charter:{},items:[],agenda:[]};
    state.agendaIds = computeAgenda();
    if(state.idx>=state.agendaIds.length) state.idx = 0;
    const wid = localStorage.getItem(WORK_KEY)||('‚Äî | '+state.svcKey+' | ‚Äî');
    hdr.textContent = wid;
    renderAgenda();
    renderCard();
  }

  // Boot + refresh quand l‚Äôautre onglet modifie le storage
  renderAll();
  window.addEventListener('storage', (e)=>{
    if(e.key===DB_KEY || e.key==='paria_touch' || e.key===WORK_KEY) renderAll();
  });

  // Boutons barre du haut
  btnPrev.onclick = ()=>{ state.idx=Math.max(0,state.idx-1); renderCard(); };
  btnNext.onclick = ()=>{ state.idx=Math.min(state.agendaIds.length-1,state.idx+1); renderCard(); };
  btnBig.onclick  = ()=>{ document.querySelector('.full').style.fontSize='18px'; };
  btnSmall.onclick= ()=>{ document.querySelector('.full').style.fontSize='15px'; };
  btnTogA.onclick = ()=>{ agenda.style.display = (agenda.style.display==='none'?'block':'none'); };

  // Raccourcis clavier (‚Üê/‚Üí pour naviguer ; 1/2/3 pour d√©cider sur la 1·µâ proposition visible)
  window.addEventListener('keydown', (ev)=>{
    if(ev.key==='ArrowLeft'){ btnPrev.click(); ev.preventDefault(); }
    if(ev.key==='ArrowRight'){ btnNext.click(); ev.preventDefault(); }
    if(['1','2','3'].includes(ev.key)){
      // applique sur la 1√®re proposition visible
      const first = card.querySelector('.pact[data-act]');
      if(!first) return;
      const c = first.getAttribute('data-c');
      const p = first.getAttribute('data-p');
      const map = { '1':'valide', '2':'a_preciser', '3':'refuse' };
      decide(c,p,map[ev.key]);
      ev.preventDefault();
    }
  });
})();
</script>
</body>
</html>


