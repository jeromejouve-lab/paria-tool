<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PARIA ‚Äî Workbench</title>
<style>
  :root{--line:#e6e6e6;--bg:#f7f7f8;--ink:#222}
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--ink)}
  header{display:flex;align-items:center;gap:12px;padding:10px 12px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tabs button{background:#fff;border:1px solid var(--line);padding:8px 12px;border-radius:10px;cursor:pointer}
  .tabs button.active{background:#222;color:#fff;border-color:#222}
  .spacer{flex:1}
  .ctx{font-size:12px;opacity:.8}
  main{padding:12px;display:grid;gap:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  label{display:block;font-size:12px;color:#555;margin:6px 0 4px}
  input,textarea,button,select{font-size:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .hide{display:none}
  /* petits blocs */
  #projAgenda{border:1px solid #ddd;border-radius:10px;padding:10px;max-height:70vh;overflow:auto}
  #projCard{border:1px solid #ddd;border-radius:10px;padding:16px;min-height:60vh}
  #previewFrame{width:100%;height:520px;border:1px solid #eee;border-radius:8px;background:#fff}
</style>
</head>
<body>

<header>
  <div class="tabs" id="tabbar">
    <button class="tabbtn active" data-tab="reglages">R√©glages</button>
    <button class="tabbtn" data-tab="capture">Capture</button>
    <button class="tabbtn" data-tab="board">Board</button>
    <button class="tabbtn" data-tab="projecteur">Projecteur</button>
    <button class="tabbtn" data-tab="exports">Exports</button>
    <button class="tabbtn" data-tab="scenarios">Sc√©narios</button>
  </div>
  <div class="spacer"></div>
  <div class="ctx">
    Work ID: <span id="projWorkIdHdr">‚Äî</span>
  </div>
</header>

<main>

  <!-- R√âGLAGES -->
  <section id="tab-reglages" class="card">
    <h3>R√©glages GitHub & Proxy</h3>
    <div class="row">
      <div>
        <label>Owner</label><input id="gh_owner" placeholder="jeromejouve-lab">
        <label>Repo</label><input id="gh_repo" placeholder="paria-audits">
        <label>Branche</label><input id="gh_branch" placeholder="acme">
        <label>Root</label><input id="gh_root" placeholder="clients/acme">
      </div>
      <div>
        <label>Token GitHub (github_pat_‚Ä¶)</label><input id="gh_token" type="password" placeholder="github_pat_...">
        <label>PROXY_URL (Apps Script)</label><input id="proxy_url" placeholder="https://script.google.com/macros/s/.../exec">
        <label>Service courant</label>
        <select id="serviceKeyGit">
          <option>Direction</option><option>RH</option><option selected>Compta</option>
          <option>IT</option><option>Marketing</option><option>Ventes</option>
        </select>
        <label>Date (AAAA-MM-JJ)</label><input id="gh_date_git" type="date">
      </div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnSave">Sauver r√©glages</button>
      <span id="saveState" style="color:#2d7">‚Äî</span>
      <button id="btnProxyTest">Tester le proxy</button>
      <span id="proxyState" style="color:#555"></span>
      <button id="btnYesterday">Hier</button>
    </div>

    <hr style="margin:16px 0">
    <h3>Git ‚Äî Lister & Importer</h3>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button id="btnGhList">Lister dossier</button>
      <button id="btnGhImport">Importer s√©lection (.json)</button>
    </div>
    <div id="gh_list" style="margin-top:8px;font-size:14px"></div>

    <h4 style="margin-top:12px">Aper√ßu du fichier import√©</h4>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
      <button id="btnAdopt">Adopter comme √©tat de travail</button>
      <button id="btnPushJson">Push .json du jour ‚Üí GitHub</button>
      <span id="gitStatus" style="color:#2d7"></span>
    </div>
    <pre id="gh_preview" style="max-height:260px;overflow:auto;background:#fafafa;padding:8px;border:1px solid #eee;border-radius:8px">‚Äî</pre>

    <h4>R√©sum√© (√©tat de travail)</h4>
    <div id="workSummary">‚Äî</div>
  </section>

  <!-- CAPTURE -->
  <section id="tab-capture" class="card hide">
    <h3>Charter (Service)</h3>
    <div class="row">
      <div>
        <label>Objectifs</label><textarea id="ed_obj"></textarea>
        <label>Contexte</label><textarea id="ed_ctx"></textarea>
        <label>Contraintes strictes</label><textarea id="ed_hard"></textarea>
        <label>P√©rim√®tre</label><textarea id="ed_scope"></textarea>
        <label>Douleurs</label><textarea id="ed_pains"></textarea>
      </div>
      <div>
        <label>KPI</label><textarea id="ed_kpi"></textarea>
        <label>Outils</label><textarea id="ed_tools"></textarea>
        <label>R√¥les & charge</label><textarea id="ed_roles"></textarea>
        <label>Budget & fen√™tre</label><textarea id="ed_budget"></textarea>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnCharterLoad">Charger depuis l‚Äô√©tat</button>
          <button id="btnCharterSave">Sauver dans l‚Äô√©tat</button>
          <span id="charterState" style="color:#2d7"></span>
        </div>
      </div>
    </div>

    <hr style="margin:16px 0">
    <h3>Analyse IA (note ‚Üí card)</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <label for="noteInput"><strong>Note √† analyser</strong></label>
      <button id="btnMic">üéôÔ∏è Dicter</button>
      <span id="micState" style="opacity:.7"></span>
    </div>
    <textarea id="noteInput" rows="6" placeholder="Parle ou tape ici‚Ä¶"></textarea>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnIaAnalyze">Analyser (IA)</button>
      <button id="btnIaAdopt">Ajouter au Board</button>
      <span id="iaStatus" style="color:#2d7"></span>
    </div>
    <h4>R√©sultat</h4>
    <pre id="iaResult" style="max-height:280px;overflow:auto;background:#fafafa;padding:8px;border:1px solid #eee;border-radius:8px">‚Äî</pre>
  </section>

  <!-- BOARD -->
  <section id="tab-board" class="card hide">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div><strong>Board ‚Äî</strong> Service: <span id="boardService">‚Äî</span></div>
      <div style="display:flex;gap:8px">
        <button id="boardRefresh">Rafra√Æchir</button>
        <button id="boardAddToAgenda">Ajouter √† l‚ÄôAgenda (s√©lection)</button>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
      <div><h4>Discovery</h4><div id="col_discovery"></div></div>
      <div><h4>Pr√™t projecteur</h4><div id="col_pret"></div></div>
      <div><h4>En validation</h4><div id="col_valid"></div></div>
      <div><h4>Boucl√©e</h4><div id="col_done"></div></div>
    </div>
  </section>

  <!-- PROJECTEUR -->
  <section id="tab-projecteur" class="card hide">
    <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <strong>Projecteur ‚Äî Service:</strong>
        <span id="projServiceBadge">‚Äî</span>
        <span id="projWorkId" style="opacity:.7"></span>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <label><input type="checkbox" id="projMode"> Mode Pr√©sentation</label>
        <button id="projSync">Sync</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:260px 1fr;gap:16px;margin-top:12px">
      <aside id="projAgenda">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <strong>Agenda</strong>
          <button id="projAgendaRefresh" title="Recharger agenda">‚Üª</button>
        </div>
        <ol id="projAgendaList" style="margin:0;padding-left:18px"></ol>
      </aside>

      <div id="projCard"><em>Ajoute des cards √† l‚ÄôAgenda dans le Board.</em></div>
    </div>
  </section>

  <!-- EXPORTS -->
  <section id="tab-exports" class="card hide">
    <h3>Exports ‚Äî .md & rapport .html</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button id="btnPreviewMd">Pr√©visualiser Markdown</button>
      <button id="btnPushMd">Push .md ‚Üí GitHub</button>
      <button id="btnPreviewHtml">Pr√©visualiser HTML</button>
      <button id="btnPushHtml">Push rapport .html ‚Üí GitHub</button>
      <button id="btnPreviewHtmlLive">Aper√ßu HTML (live)</button>
      <button id="btnOpenHtmlTab">Ouvrir dans un onglet</button>
      <span id="exportStatus" style="color:#2d7"></span>
    </div>
    <h4>Preview</h4>
    <pre id="previewBox" style="max-height:280px;overflow:auto;background:#fafafa;padding:8px;border:1px solid #eee;border-radius:8px">‚Äî</pre>

    <div id="frameWrap" style="margin-top:8px">
      <h4>Aper√ßu live</h4>
      <iframe id="previewFrame"></iframe>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Formulaire client (HTML autonome)</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnGenClientForm">G√©n√©rer Formulaire (Agenda)</button>
        <button id="btnImportClientJSON">Importer r√©ponses client (JSON)</button>
        <input type="file" id="fileClientJSON" accept="application/json" style="display:none">
        <span id="clientFormState"></span>
      </div>
    </div>
  </section>

  <!-- SC√âNARIOS -->
  <section id="tab-scenarios" class="card hide">
    <h3>Sc√©narios (MVP)</h3>
    <p>√Ä venir : cr√©er S1/S2, inclure/exclure des cards, contraintes (no-hire, budget), Promote.</p>
  </section>

</main>

<script>
(function(){
  /* ------------------ TABS ------------------ */
  const tabs = ["reglages","capture","board","projecteur","exports","scenarios"];
  function showTab(tab){
    tabs.forEach(id=>{
      const el = document.getElementById("tab-"+id);
      if(el) el.classList.toggle("hide", id!==tab);
    });
    // onTabEnter
    if(tab==="board") renderBoard();
    if(tab==="projecteur") renderProjector();
    if(tab==="capture")  loadCharterToEditor();
    // header context
    document.getElementById("projWorkIdHdr").textContent = (localStorage.getItem("paria_work_id")||"‚Äî");
  }
  document.querySelectorAll(".tabbtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      showTab(btn.getAttribute("data-tab"));
    });
  });

  /* ------------------ CFG ------------------ */
  function loadCfg(){
    try{
      const saved = localStorage.getItem("paria_github");
      if(saved){
        const gh = JSON.parse(saved);
        gh_owner.value  = gh.owner||"";
        gh_repo.value   = gh.repo||"";
        gh_branch.value = gh.branch||"";
        gh_root.value   = gh.root||"";
        gh_token.value  = gh.token||"";
      }
      proxy_url.value = localStorage.getItem("paria_proxy_url")||"";
      gh_date_git.value = localStorage.getItem("paria_gh_date") || new Date().toISOString().slice(0,10);
      serviceKeyGit.value = "Compta";
    }catch(e){}
  }
  loadCfg();

  btnSave.addEventListener("click", ()=>{
    const gh = {
      owner:  gh_owner.value.trim(),
      repo:   gh_repo.value.trim(),
      branch: gh_branch.value.trim(),
      root:   gh_root.value.trim().replace(/\/+$/,""),
      token:  gh_token.value.trim()
    };
    localStorage.setItem("paria_github", JSON.stringify(gh));
    localStorage.setItem("paria_proxy_url", proxy_url.value.trim());
    localStorage.setItem("paria_gh_date", gh_date_git.value);
    saveState.textContent = "R√©glages sauvegard√©s ‚úî";
  });

  btnYesterday.addEventListener("click", ()=>{
    const d = new Date(); d.setDate(d.getDate()-1);
    gh_date_git.value = d.toISOString().slice(0,10);
  });

  /* ------------------ GITHUB LISTER/IMPORT ------------------ */
  const API = "https://api.github.com";
  function loadGhCfg(){ try{ return JSON.parse(localStorage.getItem("paria_github")||"{}"); }catch(e){ return {}; } }
  function ghHeaders(token){ return {"Accept":"application/vnd.github+json","Authorization":"Bearer "+token,"X-GitHub-Api-Version":"2022-11-28"}; }
  function ghUrl(owner,repo,path,ref){ return API+"/repos/"+encodeURIComponent(owner)+"/"+encodeURIComponent(repo)+"/contents/"+encodeURIComponent(path)+(ref?("?ref="+encodeURIComponent(ref)):""); }
  function ymd(d){ const y=d.getFullYear(), m=("0"+(d.getMonth()+1)).slice(-2), dd=("0"+d.getDate()).slice(-2); return y+"-"+m+"-"+dd; }
  function yyyy(d){ return String(d.getFullYear()); }

  function renderGhList(items, basePath){
    if(!Array.isArray(items)){ gh_list.innerHTML = "<em>Rien</em>"; return; }
    gh_list.innerHTML = items.map(it=>{
      const isJson = (it.name||"").toLowerCase().endsWith(".json");
      return `<div><label><input type="checkbox" class="gh_ck" data-path="${basePath+'/'+it.name}" data-json="${isJson?'1':'0'}"> ${it.type} ‚Äî ${it.name}</label></div>`;
    }).join("");
  }

  btnGhList.addEventListener("click", async ()=>{
    try{
      const gh = loadGhCfg();
      if(!gh.owner||!gh.repo||!gh.root||!gh.branch||!gh.token){ alert("Compl√®te les r√©glages GitHub puis Sauver."); return; }
      const svc = serviceKeyGit.value;
      const dstr = gh_date_git.value || new Date().toISOString().slice(0,10);
      const d=new Date(dstr+"T12:00:00"), day=ymd(d), year=yyyy(d);
      const dir = gh.root.replace(/\/+$/,"")+"/"+svc+"/"+year+"/"+day;
      const r = await fetch(ghUrl(gh.owner,gh.repo,dir,gh.branch), {headers:ghHeaders(gh.token)});
      if(!r.ok){ gh_list.innerHTML = `<span style="color:#a00">${r.status} ${r.statusText}</span>`; return; }
      renderGhList(await r.json(), dir);
    }catch(e){ gh_list.innerHTML = `<span style="color:#a00">${String(e)}</span>`; }
  });

  async function ghGetFile(path){
    const gh = loadGhCfg();
    const r = await fetch(ghUrl(gh.owner,gh.repo,path,gh.branch),{headers:ghHeaders(gh.token)});
    if(!r.ok) throw new Error("GET "+path+" "+r.status);
    const j = await r.json(); return atob((j.content||"").replace(/\n/g,""));
  }

  btnGhImport.addEventListener("click", async ()=>{
    try{
      const boxes = [...document.querySelectorAll(".gh_ck:checked")];
      if(!boxes.length) return alert("Coche un .json √† importer.");
      const first = boxes.find(x=>x.dataset.json==="1")||boxes[0];
      const txt = await ghGetFile(first.dataset.path);
      let obj; try{ obj=JSON.parse(txt); }catch(e){ return alert("JSON invalide"); }
      gh_preview.textContent = JSON.stringify(obj,null,2);
      localStorage.setItem("paria_last_import", txt);
      alert("Import OK.");
    }catch(e){ alert("Erreur import: "+String(e)); }
  });

  // adopt & push json
  function renderWorkSummary(){
    const raw = localStorage.getItem("paria_db"); if(!raw){ workSummary.textContent="‚Äî"; return; }
    let db; try{ db=JSON.parse(raw); }catch(e){ workSummary.textContent="‚Äî"; return; }
    const svcKey = serviceKeyGit.value || "Compta";
    const s = db.services && db.services[svcKey] || null;
    if(!s){ workSummary.textContent = `Aucun √©tat pour ¬´ ${svcKey} ¬ª.`; return; }
    const ch = s.charter || {};
    let html = '<ul style="margin:0;padding-left:18px">';
    html += `<li><b>Objectifs</b> : ${ch.objectifs||'‚Äî'}</li>`;
    html += `<li><b>Contexte</b> : ${ch.contexte||'‚Äî'}</li>`;
    html += `<li><b>Contraintes strictes</b> : ${ch.contraintes||'‚Äî'}</li>`;
    html += `<li><b>P√©rim√®tre</b> : ${ch.perimetre||'‚Äî'}</li>`;
    html += `<li><b>Douleurs</b> : ${ch.douleurs||'‚Äî'}</li>`;
    html += `<li><b>KPI</b> : ${ch.kpis||'‚Äî'}</li>`;
    html += `<li><b>Outils</b> : ${ch.outils||'‚Äî'}</li>`;
    html += `<li><b>R√¥les & charge</b> : ${ch.roles||'‚Äî'}</li>`;
    html += `<li><b>Budget & fen√™tre</b> : ${ch.budget||'‚Äî'}</li>`;
    html += '</ul>';
    const nItems = Array.isArray(s.items)? s.items.length : 0;
    html += `<p style="margin-top:8px">Items : <b>${nItems}</b></p>`;
    workSummary.innerHTML = html;
  }

  btnAdopt.addEventListener("click", ()=>{
    const txt = localStorage.getItem("paria_last_import");
    if(!txt) return alert("Importe d'abord un .json.");
    let obj; try{ obj=JSON.parse(txt); }catch(e){ return alert("JSON invalide."); }
    const svcKey = serviceKeyGit.value || "Compta";
    let db={services:{}}; try{ db=JSON.parse(localStorage.getItem("paria_db")||"{}"); }catch(e){}
    if(!db.services) db.services={};
    db.services[svcKey] = obj.services && obj.services[svcKey] ? obj.services[svcKey] : obj;
    localStorage.setItem("paria_db", JSON.stringify(db));
    renderWorkSummary();
    gitStatus.textContent = "√âtat adopt√© ‚úî";
  });

  function utf8ToB64(str){ const enc=new TextEncoder().encode(str); let bin=''; for(let b of enc) bin+=String.fromCharCode(b); return btoa(bin); }
  async function ghGetFileWithSha(path){
    const gh = loadGhCfg();
    const r = await fetch(ghUrl(gh.owner,gh.repo,path,gh.branch),{headers:ghHeaders(gh.token)});
    if(!r.ok) throw new Error("GET "+path+" "+r.status);
    const j = await r.json(); return j.sha||null;
  }
  async function ghUpsertJson(path,jsonText,message){
    const gh = loadGhCfg();
    let sha=null; try{ sha=await ghGetFileWithSha(path); }catch(e){}
    const body={message:message||("update "+path),content:utf8ToB64(jsonText),branch:gh.branch};
    if(sha) body.sha=sha;
    const r = await fetch(ghUrl(gh.owner,gh.repo,path),{method:"PUT",headers:ghHeaders(gh.token),body:JSON.stringify(body)});
    if(!r.ok) throw new Error("PUT "+path+" "+r.status);
    return r.json();
  }

  btnPushJson.addEventListener("click", async ()=>{
    try{
      const gh = loadGhCfg(); if(!gh.owner||!gh.repo||!gh.root||!gh.branch||!gh.token) return alert("R√©glages GitHub incomplets.");
      const raw = localStorage.getItem("paria_db"); if(!raw) return alert("Aucun √©tat de travail.");
      let db; try{ db=JSON.parse(raw); }catch(e){ return alert("√âtat local invalide."); }
      const svcKey = serviceKeyGit.value || "Compta";
      const s = db.services && db.services[svcKey]; if(!s) return alert("√âtat absent pour ¬´ "+svcKey+" ¬ª.");
      const dstr = gh_date_git.value || new Date().toISOString().slice(0,10);
      const d = new Date(dstr+"T12:00:00"); const year=String(d.getFullYear()); const day=d.toISOString().slice(0,10);
      const base = gh.root.replace(/\/+$/,"")+"/"+svcKey+"/"+year+"/"+day;
      const path = base+"/audit_"+svcKey+"_"+day+".json";
      gitStatus.textContent = "Push en cours‚Ä¶";
      const res = await ghUpsertJson(path, JSON.stringify(s,null,2), "feat: audit "+svcKey+" "+day+" (.json)");
      gitStatus.textContent = "Push OK ‚úî ("+res.content.path+")";
      alert("Push JSON OK.");
    }catch(e){ gitStatus.textContent="Erreur push"; alert("Erreur push: "+String(e)); }
  });

  renderWorkSummary();

  /* ------------------ EXPORTS ------------------ */
  async function ghUpsertText(path,text,message){
    const gh = loadGhCfg(); let sha=null; try{ sha=await ghGetFileWithSha(path);}catch(e){}
    const body={message:message||("update "+path),content:utf8ToB64(text),branch:gh.branch};
    if(sha) body.sha=sha;
    const r=await fetch(ghUrl(gh.owner,gh.repo,path),{method:"PUT",headers:ghHeaders(gh.token),body:JSON.stringify(body)});
    if(!r.ok) throw new Error("PUT "+path+" "+r.status);
    return r.json();
  }
  function getWorkForService(){
    const svcKey = serviceKeyGit.value || "Compta";
    const raw = localStorage.getItem("paria_db"); if(!raw) return {key:svcKey, s:null};
    let db; try{ db=JSON.parse(raw); }catch(e){ return {key:svcKey, s:null}; }
    const s = db.services && db.services[svcKey] || null;
    return {key:svcKey, s};
  }
  function clientSlugFromRoot(){ const gh=loadGhCfg(); const parts=(gh.root||'').split('/').filter(Boolean); return parts.length? parts[parts.length-1]:'client'; }
  function makeMarkdown(svcKey,s){
    const L=[]; L.push("# Audit "+svcKey+" ‚Äî PARIA","", "## Service Charter");
    const ch=s.charter||{}; ["objectifs","contexte","contraintes","perimetre","douleurs","kpis","outils","roles","budget"].forEach(k=>L.push("- **"+k+"**: "+(ch[k]||"-")));
    L.push("", "## Analyses");
    (s.items||[]).forEach((it,i)=>{
      L.push("### Item #"+(i+1)+" ("+(it._priority_tag||"P3")+")");
      if(it.reformulation) L.push("Reformulation: "+it.reformulation);
      const b=it.paria||{};
      ["problemes","ameliorations","reconfigurations","integration_ia","actions"].forEach(key=>{
        const arr=b[key]||[]; if(arr.length){ L.push("- **"+key+"**:"); arr.forEach(x=>L.push("  - "+x)); }
      });
      if (it.questions?.length){ L.push("- **Questions**:"); it.questions.forEach(q=>L.push("  - "+q)); }
      L.push("");
    });
    L.push("## D√©cisions");
    (s.decisions||[]).forEach(d=>L.push("- "+ new Date(d.ts).toLocaleString() +" ‚Äî **"+d.status+"** ‚Äî "+(d.item?.reformul
