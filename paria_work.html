<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Audit PARIA ‚Äî Capture & Analyse</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0}
    header,footer{padding:12px 16px;background:#f5f5f5}
    main{display:grid;gap:12px;padding:12px}
    .row{display:grid;gap:12px}
    .card{border:1px solid #e6e6e6;border-radius:12px;padding:12px;background:#fff}
    label{display:block;font-size:12px;color:#555;margin-bottom:4px}
    textarea,input,select,button{font-size:14px}
    textarea{width:100%;min-height:90px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid #ddd;background:#fafafa}
    .projector{position:fixed;inset:0;background:#fff;z-index:9999;display:none;padding:16px;overflow:auto}
    .projector.show{display:block}
  </style>
</head>
<body>
<header>
  <strong>Audit PARIA</strong>
  <span style="margin-left:12px">Service:</span>
  <select id="serviceKey">
    <option>Direction</option><option>RH</option><option>Compta</option>
    <option>IT</option><option>Marketing</option><option>Ventes</option>
  </select>
  <button id="btnLoad">Charger</button>
  <button id="btnSave">Sauver</button>
  <button id="btnProjector">Projector Mode</button>
</header>

<main>
  <section class="row">
    <div class="card">
      <h3>Service Charter</h3>
      <div><label>Objectifs</label><textarea id="ch_obj"></textarea></div>
      <div><label>Contexte & contraintes</label><textarea id="ch_ctx"></textarea></div>
      <div><label>P√©rim√®tre</label><textarea id="ch_scope"></textarea></div>
      <div><label>Douleurs prioritaires (3 max)</label><textarea id="ch_pains"></textarea></div>
      <div><label>KPI</label><textarea id="ch_kpi"></textarea></div>
      <div><label>Outils en place</label><textarea id="ch_tools"></textarea></div>
      <div><label>R√¥les & charge</label><textarea id="ch_roles"></textarea></div>
      <div><label>Budget & fen√™tre</label><textarea id="ch_budget"></textarea></div>
      <div class="actions"><button id="btnSaveCharter">Enregistrer ce charter</button></div>
    </div>

    <div class="card">
      <h3>Prise de notes</h3>
      <textarea id="note"></textarea>
      <div class="actions">
        <button id="btnMic">üé§ Dicter</button>
        <button id="btnAnalyze">Analyser</button>
      </div>
      <div id="micStatus" class="pill" style="display:none">√âcoute‚Ä¶</div>
    </div>
  </section>

  <section class="row">
    <div class="card">
      <h3>Analyse IA</h3>
      <pre id="analysis" style="white-space:pre-wrap"></pre>
      <div class="actions">
        <button data-status="a_valider" class="status">‚úÖ Valider</button>
        <button data-status="a_preciser" class="status">‚ùì √Ä pr√©ciser</button>
        <button data-status="refuse" class="status">‚ùå Refuser</button>
      </div>
    </div>

    <div class="card">
      <h3>D√©cisions & Suivi</h3>
      <div id="decisions"></div>
      <div class="actions">
        <button id="btnExportMd">Exporter Markdown</button>
      </div>
    </div>
  </section>
</main>

<div id="projector" class="projector">
  <h2 id="p_title">Propositions & Questions</h2>
  <div id="p_content"></div>
  <div class="actions" style="margin-top:12px">
    <button onclick="toggleProjector()">Fermer</button>
  </div>
</div>

<footer>Local cache non contractuel ‚Äî utilisez ‚ÄúSauver‚Äù pour persister c√¥t√© Google.</footer>

<script>
const GAS_BASE_URL = '<<TON_APPS_SCRIPT_DEPLOY_URL>>'; // ex: https://script.google.com/macros/s/AKfycb.../exec
const MODEL = 'gpt-4o-mini'; // √† ajuster selon ton offre

let db = { // m√©moire locale (miroir)
  services: {} // key => { charter:{...}, notes:[], items:[], decisions:[] }
};

function svc() {
  const key = document.getElementById('serviceKey').value;
  if(!db.services[key]) db.services[key] = { charter:{}, notes:[], items:[], decisions:[] };
  return db.services[key];
}

// --- Charter ---
document.getElementById('btnSaveCharter').onclick = ()=>{
  const s = svc();
  s.charter = {
    objectifs: ch_obj.value.trim(),
    contexte: ch_ctx.value.trim(),
    perimetre: ch_scope.value.trim(),
    douleurs: ch_pains.value.trim(),
    kpis: ch_kpi.value.trim(),
    outils: ch_tools.value.trim(),
    roles: ch_roles.value.trim(),
    budget: ch_budget.value.trim(),
  };
  localStorage.setItem('paria_db', JSON.stringify(db));
  alert('Charter enregistr√© localement.');
};

// --- Projector ---
function toggleProjector() {
  const el = document.getElementById('projector');
  if(!el.classList.contains('show')) {
    const s = svc();
    const html = (s.items||[]).slice(-1).map(it=>{
      const props = (it.propositions||[]).map(p=>`‚Ä¢ ${p.label} ‚Äî ${p.type} [${p.indicateurs?.cout}/${p.indicateurs?.complexite}]`).join('<br/>');
      const qs = (it.questions||[]).map(q=>`? ${q}`).join('<br/>');
      return `<h3>${new Date().toLocaleString()}</h3><div><strong>Propositions</strong><br/>${props || '‚Äî'}</div><div style="margin-top:8px"><strong>Questions</strong><br/>${qs || '‚Äî'}</div>`;
    }).join('');
    document.getElementById('p_content').innerHTML = html || '<em>Pas de contenu analys√©.</em>';
  }
  el.classList.toggle('show');
}
document.getElementById('btnProjector').onclick = toggleProjector;

// --- Load/Save GAS ---
document.getElementById('btnLoad').onclick = async ()=>{
  const key = serviceKey.value;
  const url = `${GAS_BASE_URL}?route=load&service=${encodeURIComponent(key)}`;
  const r = await fetch(url);
  const j = await r.json();
  if(j && j.ok && j.data){
    db.services[key] = j.data;
    localStorage.setItem('paria_db', JSON.stringify(db));
    hydrateForm();
    alert('Charg√© depuis Google.');
  } else alert('Rien √† charger ou erreur.');
};

document.getElementById('btnSave').onclick = async ()=>{
  const key = serviceKey.value;
  const body = { route:'save', service:key, data: db.services[key] };
  const r = await fetch(GAS_BASE_URL, { method:'POST', body: JSON.stringify(body) });
  const j = await r.json();
  if(j.ok) alert('Sauvegard√© sur Google Drive.');
  else alert('Erreur de sauvegarde.');
};

function hydrateForm(){
  const s = svc();
  ch_obj.value = s.charter.objectifs||'';
  ch_ctx.value = s.charter.contexte||'';
  ch_scope.value = s.charter.perimetre||'';
  ch_pains.value = s.charter.douleurs||'';
  ch_kpi.value = s.charter.kpis||'';
  ch_tools.value = s.charter.outils||'';
  ch_roles.value = s.charter.roles||'';
  ch_budget.value = s.charter.budget||'';
  renderDecisions();
}

// --- Dict√©e (webkitSpeechRecognition) ---
let rec; 
document.getElementById('btnMic').onclick = ()=>{
  if(!('webkitSpeechRecognition' in window)){ alert('Dict√©e non support√©e sur ce navigateur.'); return; }
  if(!rec){
    rec = new webkitSpeechRecognition();
    rec.lang = 'fr-FR'; rec.continuous = false; rec.interimResults = false;
    rec.onresult = (e)=>{ note.value = (note.value+' '+e.results[0][0].transcript).trim(); micStatus.style.display='none'; };
    rec.onend = ()=> micStatus.style.display='none';
  }
  micStatus.style.display='inline-block';
  rec.start();
};

// --- Analyse (proxy Apps Script -> OpenAI Responses) ---
document.getElementById('btnAnalyze').onclick = async ()=>{
  const key = serviceKey.value;
  const s = svc();
  const payload = {
    route: 'analyze',
    model: MODEL,
    service_key: key,
    charter: s.charter,
    note: note.value
  };
  const r = await fetch(GAS_BASE_URL, { method:'POST', body: JSON.stringify(payload) });
  const j = await r.json();
  if(!j.ok){ analysis.textContent = 'Erreur analyse.'; return; }

  const item = j.data; // conforme au schema JSON retourn√©
  s.items.push(item);
  analysis.textContent = JSON.stringify(item, null, 2);
  localStorage.setItem('paria_db', JSON.stringify(db));
};

// --- Statuts / D√©cisions ---
document.querySelectorAll('.status').forEach(btn=>{
  btn.onclick = ()=>{
    const s = svc();
    const last = (s.items||[])[(s.items||[]).length-1];
    if(!last) return;
    s.decisions.push({ ts: Date.now(), status: btn.dataset.status, item: last });
    renderDecisions();
    localStorage.setItem('paria_db', JSON.stringify(db));
  };
});

function renderDecisions(){
  const s = svc();
  const el = document.getElementById('decisions');
  if(!s.decisions?.length){ el.innerHTML = '<em>Aucune d√©cision.</em>'; return; }
  el.innerHTML = s.decisions.slice().reverse().map(d=>{
    return `<div class="pill">${new Date(d.ts).toLocaleString()} ‚Äî <strong>${d.status}</strong> ‚Äî ${d.item?.reformulation||''}</div>`;
  }).join('');
}

// --- Export Markdown (client) ---
document.getElementById('btnExportMd').onclick = ()=>{
  const key = serviceKey.value;
  const s = svc();
  const md = makeMarkdown(key, s);
  const blob = new Blob([md], {type:'text/markdown'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `audit_${key}_${new Date().toISOString().slice(0,10)}.md`;
  a.click();
};

function makeMarkdown(key, s){
  const lines = [];
  lines.push(`# Audit ${key} ‚Äî PARIA`);
  lines.push('## Service Charter');
  for(const [k,v] of Object.entries(s.charter||{})) lines.push(`- **${k}**: ${v||'-'}`);
  lines.push('\n## Analyses (derni√®res)');
  (s.items||[]).forEach((it,i)=>{
    lines.push(`### Item #${i+1}`);
    lines.push(`Reformulation: ${it.reformulation}`);
    ['problemes','ameliorations','reconfigurations','integration_ia','actions'].forEach(b=>{
      const arr = it.paria?.[b]||[];
      if(arr.length) lines.push(`- **${b}**:\n  - ${arr.join('\n  - ')}`);
    });
    if(it.questions?.length) lines.push(`- **Questions**:\n  - ${it.questions.join('\n  - ')}`);
    const props = it.propositions||[];
    if(props.length){
      lines.push(`- **Propositions**:`);
      props.forEach(p=>{
        lines.push(`  - ${p.label} ‚Äî ${p.type} [${p.indicateurs?.cout}/${p.indicateurs?.complexite}]`);
      });
    }
  });
  lines.push('\n## D√©cisions');
  (s.decisions||[]).forEach(d=>{
    lines.push(`- ${new Date(d.ts).toLocaleString()} ‚Äî **${d.status}** ‚Äî ${d.item?.reformulation||''}`);
  });
  return lines.join('\n');
}

// --- Boot: recharger cache local ---
try{
  const raw = localStorage.getItem('paria_db');
  if(raw) db = JSON.parse(raw);
  hydrateForm();
}catch(e){}
</script>
</body>
</html>
