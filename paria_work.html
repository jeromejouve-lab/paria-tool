<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PARIA ‚Äî Workbench</title>
<style>
  :root{--line:#e6e6e6;--bg:#f7f7f8;--ink:#222}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  header{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}

  /* Statuts propositions */
  .status-pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:12px}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.pending{background:#9aa3af}
  .dot.a_preciser{background:#f59e0b}
  .dot.valide{background:#10b981}
  .dot.refuse{background:#ef4444}
  .pact{cursor:pointer}
  .pact.active{background:#222;color:#fff;border-color:#222}

  /* Grille Projecteur standalone */
  .gridProj{display:grid;grid-template-columns:280px 1fr;gap:16px}
  .gridProj.no-agenda{grid-template-columns:1fr}

  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tabs button{background:#fff;border:1px solid var(--line);padding:8px 12px;border-radius:10px;cursor:pointer}
  .tabs button.active{background:#222;color:#fff;border-color:#222}
  .spacer{flex:1}
  .ctx{font-size:12px;opacity:.75}
  main{padding:12px;display:grid;gap:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .row{display:grid;gap:12px}
  @media(min-width:960px){ .row{grid-template-columns:1fr 1fr} }
  label{display:block;font-size:12px;color:#555;margin:6px 0 4px}
  textarea,input,select,button{font-size:14px}
  textarea{width:100%;min-height:100px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid #ddd;background:#fafafa}
  .hide{display:none !important}
	.tab-col{display:flex;flex-direction:column}

	/* Forcer 2 colonnes ‚Äúcompactes‚Äù pour Journal & Projecteur, sauf tr√®s petit √©cran */
	#tab-analyse .row, #tab-projecteur .row {
	  grid-template-columns: minmax(280px, 1fr) minmax(380px, 1fr);
	}
	@media (max-width: 720px){
	  #tab-analyse .row, #tab-projecteur .row { grid-template-columns: 1fr; }
	}

  /* Projecteur (onglet) */
	#projAgenda{
	  border:1px solid #ddd;border-radius:10px;padding:10px;
	  max-height:70vh;overflow:auto;position:sticky;top:8px
	}
	#projCard{
	  border:1px solid #ddd;border-radius:10px;padding:16px;
	  min-height:60vh;max-height:70vh;overflow:auto;background:#fff
	}

  /* Projecteur standalone */
  .full{max-width:1200px;margin:0 auto;padding:16px}

	/* container 2 colonnes pour le projecteur inline */
	#projectorInline{
	  display: grid;
	  grid-template-columns: 320px 1fr;
	  gap: 12px;
	  align-items: start;
	}
	
	/* colonne gauche (agenda) sticky et scroll ind√©pendante */
	.proj-left{
	  position: sticky;
	  top: 8px;
	  max-height: calc(100vh - 160px);
	  overflow: auto;
	  border-right: 1px solid #eee;
	  padding-right: 8px;
	}
	
	/* colonne droite scroll ind√©pendante */
	.proj-right{
	  max-height: calc(100vh - 160px);
	  overflow: auto;
	}
	#projAgendaList a, #p_agenda a {
  display: block;
  white-space: normal;
  overflow: visible;
  text-overflow: clip;
  word-break: break-word;
	word-wrap: anywhere;		
}
	
</style>
</head>
<body>

<header>
  <div class="tabs" id="tabbar">
    <button class="tabbtn active" data-tab="reglages">R√©glages</button>
    <button class="tabbtn" data-tab="capture">Charter</button>
    <button class="tabbtn" data-tab="analyse">Journal</button>
    <button class="tabbtn" data-tab="projecteur">Projecteur</button>
    <button class="tabbtn" data-tab="scenarios">Sc√©narios</button>
    <button id="btnStartSess">D√©marrer s√©ance</button>
    <button id="btnCopyGuest" disabled>Copier lien invit√©</button>
    <button id="btnPauseSess" disabled>Pause</button>
    <button id="btnRotateGuest" disabled>Changer lien</button>
    <button id="btnEndSess" disabled>Terminer</button>
    <span id="liveState" class="pill">offline</span>
  </div>
  <div class="spacer"></div>
  <div class="ctx">Service:
    <select id="serviceKey">
      <option>Direction</option><option>RH</option><option selected>Compta</option>
      <option>IT</option><option>Marketing</option><option>Ventes</option>
    </select>
    &nbsp;|&nbsp; Work ID: <span id="workIdHdr">‚Äî</span>
 		&nbsp;¬∑&nbsp; Card #<span id="cardHdr">‚Äî</span>

  </div>
</header>

<main>
  <!-- R√âGLAGES -->
  <section id="tab-reglages" class="card">
    <h3>R√©glages / Persistance</h3>
    <div class="row">
      <div class="card">
        <h4>Google Apps Script (proxy)</h4>
        <label>URL publique (cette page)</label>
        <input id="public_base" placeholder="https://jeromejouve-lab.github.io/paria-tool/paria_work.html">
        <label>DEPLOY URL</label>
        <input id="GAS_URL" placeholder="https://script.google.com/macros/s/AKfycb.../exec" style="width:380px">
		<div class="row" style="margin-top:6px">
		  <label for="PROXY_SECRET" style="min-width:100px;display:inline-block">Proxy secret</label>
		  <input id="PROXY_SECRET" type="password" placeholder="ex: my_secret" style="width:100px">
		</div>
        <div class="actions">
          <button id="btnSaveCfg">Sauver</button>
          <button id="btnTestProxy">Tester</button>
          <span id="proxyState" class="pill">‚Äî</span>
        </div>
        <small>Le proxy g√®re : <code>route=analyze|save|load|echo</code>.</small>
      </div>

      <div class="card">
        <h4>Work ID (Client ¬∑ Service ¬∑ Date)</h4>
        <label>Client</label><input id="workClient" placeholder="ACME">
        <label>Date</label><input id="workDate" type="date">
        <div class="actions">
          <button id="btnBindWork">Lier ce Work ID</button>
          <span id="workBindState" class="pill">‚Äî</span>
        </div>
        <small>Le Work ID est m√©moris√© et visible en haut. Il permet de r√©-ouvrir la m√™me s√©ance.</small>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h4>Charger / Sauver (Apps Script)</h4>
        <div class="actions">
          <button id="btnLoad">Charger depuis Google</button>
          <button id="btnSave">Sauver vers Google</button>
          <span id="gsState" class="pill">‚Äî</span>
        </div>
      </div>

      <div class="card">
        <h4>GitHub (versionning)</h4>
        <label>Owner</label><input id="gh_owner" placeholder="jeromejouve-lab">
        <label>Repo</label><input id="gh_repo" placeholder="paria-audits">
        <label>Branch</label><input id="gh_branch" placeholder="main">
        <label>Base path</label><input id="gh_base" placeholder="clients">
        <label>Token PAT</label><input id="gh_token" type="password" placeholder="ghp_...">
        <label>Message de commit</label><input id="gh_msg" placeholder="feat: audit Compta 2025-08-28">
        <div class="actions">
          <button id="btnSaveGh">Sauver</button>
          <button id="btnPushGh">Pousser snapshot (.json + .md)</button>
          <span id="ghState" class="pill">‚Äî</span>
        </div>
        <small>Le snapshot pousse l‚Äô√©tat du service courant + un Markdown de synth√®se.</small>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h4>√âtat local</h4>
		<div class="actions" style="gap:8px;align-items:center;margin-bottom:8px">
		  <button id="btnDump">Voir JSON</button>
		  <button id="btnClear">R√©initialiser local</button>
		</div>
		<pre id="dump"
		     style="white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:8px;
		            min-height:240px;max-height:70vh;overflow:auto;resize:vertical">‚Äî</pre>
      </div>
    </div>
  </section>

  <!-- CAPTURE -->
  <section id="tab-capture" class="card hide">
    <div class="row">
      <div class="card">
        <h3>Service Charter</h3>
        <label>Objectifs</label><textarea id="ch_obj"></textarea>
        <label>Contexte & contraintes</label><textarea id="ch_ctx"></textarea>
        <label>P√©rim√®tre</label><textarea id="ch_scope"></textarea>
        <label>Contraintes strictes</label><textarea id="ch_hard"></textarea>
        <label>Douleurs (top 3)</label><textarea id="ch_pains"></textarea>
        <label>KPI</label><textarea id="ch_kpi"></textarea>
        <label>Outils</label><textarea id="ch_tools"></textarea>
        <label>R√¥les & charge</label><textarea id="ch_roles"></textarea>
        <label>Budget & fen√™tre</label><textarea id="ch_budget"></textarea>
        <div class="actions">
          <button id="btnCharterToState">Sauver dans l‚Äô√©tat</button>
          <button id="btnCharterFromState">Charger de l‚Äô√©tat</button>
          <span id="charterState" class="pill">‚Äî</span>
        </div>
      </div>

      <div class="card">
        <h3>Note ‚Üí Analyse IA</h3>
        <div class="actions">
          <button id="btnMic">üéôÔ∏è Dicter</button>
          <span id="micStatus" class="pill">‚Äî</span>
        </div>
        <textarea id="note" placeholder="Parle ou tape ici‚Ä¶"></textarea>
        <div class="actions">
          <button id="btnAnalyze">Analyser (AI)</button>
          <span id="aiState" class="pill">‚Äî</span>
        </div>
        <h4>R√©sultat</h4>
        <pre id="analysis" style="white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:8px;max-height:260px;overflow:auto">‚Äî</pre>
      </div>
    </div>
  </section>

  <!-- ANALYSE / D√âCISIONS -->
  <section id="tab-analyse" class="card hide tab-col" style="min-height:calc(100vh - 160px)">
    <div class="row">
      <div class="card">
        <h3>Dernier item (r√©formulation & PARIA)</h3>
        <pre id="lastItem" style="white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:8px;min-height:240px;max-height:calc(100vh - 280px);overflow:auto;resize:vertical">‚Äî</pre>
        <div class="actions">
          <button data-status="valide"  class="decide">Valider</button>
          <button data-status="a_preciser" class="decide">√Ä pr√©ciser</button>
          <button data-status="refuse" class="decide">Refuser</button>
          <span id="decState" class="pill">‚Äî</span>
        </div>
      </div>

      <div class="card">
        <h3>D√©cisions (journal)</h3>
        <div style="max-height:calc(100vh - 280px);overflow:auto">
				  <div id="decisions"></div>
				</div>
        <div class="actions" style="margin-top:8px">
          <button id="btnExportMd">Exporter Markdown</button>
          <button id="btnExportClientHtml">Exporter HTML client</button>
          <button id="btnImportClientJson">Importer r√©ponses client (JSON)</button>
          <input id="clientJsonFile" type="file" accept="application/json" style="display:none">
          <span id="expState" class="pill">‚Äî</span>
        </div>
      </div>
    </div>
  </section>

  <!-- PROJECTEUR (dans la page) -->
  <section id="tab-projecteur" class="card hide">
    <div class="actions" style="justify-content:space-between">
      <div><strong>Projecteur (pr√©visualisation)</strong></div>
      <div class="actions"><button id="btnOpenProjector">Ouvrir le Projecteur (nouvel onglet)</button></div>
    </div>

    <div class="row">
      <aside id="projAgenda" class="card">
        <h4>Agenda (simplifi√©)</h4>
        <ol id="projAgendaList"></ol>
      </aside>

      <div id="projCard" class="card">
        <em>Analyse un item dans ‚ÄúCapture‚Äù pour l‚Äôafficher ici, ou ouvre le Projecteur.</em>
      </div>
    </div>
  </section>

  <!-- SC√âNARIOS -->
  <section id="tab-scenarios" class="card hide">
    <div class="actions">
      <button id="btnForkScenario">Dupliquer depuis l‚Äô√©tat courant</button>
      <button id="btnPromoteScenario">Promouvoir comme version de travail</button>
    </div>
    <div id="scList" style="margin-top:10px"></div>
	<div id="scWork" class="card" style="margin-top:10px"></div>
  </section>
</main>

<script>
/* ====== CONFIG ====== */
const MODEL   = 'gpt-4o-mini';
const GAS_KEY = 'paria_gas_url';
const DB_KEY  = 'paria_db';
const WORK_KEY= 'paria_work_id'; // "ACME|Compta|2025-08-28"

/* ====== GitHub cfg ====== */
const GH_OWNER='paria_gh_owner', GH_REPO='paria_gh_repo', GH_BRANCH='paria_gh_branch',
      GH_BASE='paria_gh_base', GH_TOKEN='paria_gh_token';
const GH_API = 'https://api.github.com';
const DEFAULT_GAS_URL = ''; // optionnel: mets ici ton URL Apps Script pour pr√©remplir au 1er chargement
const PROXY_SECRET_KEY = 'paria_proxy_secret';

function gasUrl(){ return (localStorage.getItem(GAS_KEY)||'').trim(); }
function setGasUrl(u){ localStorage.setItem(GAS_KEY,u.trim()); }
function proxySecret(){ return (localStorage.getItem(PROXY_SECRET_KEY)||'').trim(); }
function setProxySecret(v){ localStorage.setItem(PROXY_SECRET_KEY, (v||'').trim()); }

/* ====== √âTAT LOCAL ====== */
let db = { services:{} }; // services[key]={ charter:{}, items:[], decisions:[], scenarios:[] }
function currentService(){ return document.getElementById('serviceKey').value; }
function svc(){
  const k=currentService();
  if(!db.services[k]) db.services[k]={ charter:{}, items:[], decisions:[], scenarios:[] };
  return db.services[k];
}
function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function loadDB(){ try{ db = JSON.parse(localStorage.getItem(DB_KEY)||'{"services":{}}'); }catch(e){ db={services:{}}; } }

/* ====== ONGLETING ====== */
const tabs = ['reglages','capture','analyse','projecteur','scenarios'];
function showTab(id){
  tabs.forEach(t=>{
    document.getElementById('tab-'+t).classList.toggle('hide', t!==id);
  });
  document.querySelectorAll('.tabbtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.tab===id);
  });
  // Render hooks on show
  if(id==='analyse'){ 
    if (typeof renderLastItem==='function') renderLastItem();
    if (typeof renderDecisions==='function') renderDecisions();
  }
  if(id==='projecteur'){
    if (typeof renderProjectorInline==='function') renderProjectorInline();
  }
	if(id==='scenarios'){
	  if (typeof renderScList==='function') renderScList();
	}
}
	
// --- Si on est en mode Projecteur (invit√©), ne pas booter l'app √† onglets
const __IS_PROJECTOR = new URL(location.href).searchParams.get('projecteur') === '1';
if (__IS_PROJECTOR) {
  // masquer l'UI par d√©faut jusqu'√† ce que le projecteur standalone remplace <body>
  document.body.innerHTML = '<div style="padding:16px;font-size:16px">Chargement du projecteur‚Ä¶</div>';
}

if (!__IS_PROJECTOR) {
  document.querySelectorAll('.tabbtn').forEach(b=>b.onclick=()=>showTab(b.dataset.tab));
  loadDB();
  showTab('reglages');
}

/* ====== WORK ID ====== */
function currentWorkId(){
  const c = (document.getElementById('workClient').value||'').trim() || 'CLIENT';
  const s = currentService();
  const d = (document.getElementById('workDate').value||'').trim() || new Date().toISOString().slice(0,10);
  return `${c}|${s}|${d}`;
}
function parseWorkId(){
  const wid = localStorage.getItem(WORK_KEY)||'CLIENT|'+currentService()+'|'+new Date().toISOString().slice(0,10);
  const [client, service, date] = wid.split('|');
  return {client, service, date};
}
function bindWork(){
  const id = currentWorkId();
  localStorage.setItem(WORK_KEY, id);
  document.getElementById('workIdHdr').textContent = id;
  document.getElementById('workBindState').textContent = 'li√© ‚úî';
}

/* ====== SESSION SYNC ====== */
let sess = { id:null, operator_token:null, guest_token:null, last_seq:0, paused:false };
let poller = null;
function publicBase(){ return (localStorage.getItem('paria_public_base')||'').trim(); }

function selectService(k){ if(document.getElementById('serviceKey')) document.getElementById('serviceKey').value = k; }
const svcSel = document.getElementById('serviceKey');
if (svcSel){
  svcSel.onchange = ()=>{
    // persist current service selection if you already do so:
    // localStorage.setItem('paria_service', svcSel.value);
    if (typeof hydrateCharter==='function') hydrateCharter();
    if (typeof renderLastItem==='function') renderLastItem();
    if (typeof renderDecisions==='function') renderDecisions();
    if (typeof renderProjectorInline==='function') renderProjectorInline();
    if (typeof refreshDump==='function') refreshDump();
  };
}	

async function gasPost(route, payload){
  const u = gasUrl(); if(!u) throw new Error('Proxy non configur√©');
  const body = { route, secret: proxySecret(), ...(payload||{}) };
  const r = await fetch(u,{ method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(body) });
  const j = await r.json(); if(!j.ok) throw new Error(j.error||route+' ko'); return j;
}
async function gasGet(route, qs){
  const u = new URL(gasUrl());
  u.searchParams.set('route', route);
  u.searchParams.set('secret', proxySecret());
  Object.entries(qs||{}).forEach(([k,v])=>u.searchParams.set(k, String(v)));
  const r = await fetch(u.toString());
  const j = await r.json(); if(!j.ok) throw new Error(j.error||route+' ko'); return j;
}

btnStartSess.onclick = async ()=>{
	await saveCloudNow(); // baseline cloud IMMEDIATE avant la s√©ance
  const wid = localStorage.getItem('paria_work_id')||'';
  const j = await gasPost('session_start', {work_id: wid, moderation: false});
  sess.id=j.session_id; sess.operator_token=j.operator_token; sess.guest_token=j.guest_token; sess.last_seq=0; sess.paused=false;
  liveState.textContent='live'; btnCopyGuest.disabled=btnPauseSess.disabled=btnRotateGuest.disabled=btnEndSess.disabled=false;

	// -- construire et m√©moriser le lien invit√© (propre) --
  const base = publicBase() || location.href.split('?')[0];
  const u = new URL(base);
  u.searchParams.set('projecteur','1');
  u.searchParams.set('session', sess.id);
  u.searchParams.set('role','guest');
  u.searchParams.set('token', sess.guest_token);

  const prox = gasUrl();
  if (prox) {
    try { const pu = new URL(prox); pu.search = ''; u.searchParams.set('prox', pu.toString()); }
    catch { u.searchParams.set('prox', prox.split('?')[0]); }
  }
  if (wid) u.searchParams.set('wid', wid);
  const ps  = proxySecret();
  if (ps)  u.searchParams.set('ps', ps);

  window._guest_url = u.toString();      // <- lien pr√™t √† copier
  btnCopyGuest.disabled = false;         // activ√©
  btnCopyGuest.style.background = '#f59e0b'; // orange
  btnCopyGuest.style.color = '#fff';

  startPoll();
};
btnEndSess.onclick = async ()=>{
  if(!sess.id) return;
  await gasPost('session_end', {session_id: sess.id});
  stopPoll(); sess={id:null,operator_token:null,guest_token:null,last_seq:0,paused:false};
  liveState.textContent='offline'; btnCopyGuest.disabled=btnPauseSess.disabled=btnRotateGuest.disabled=btnEndSess.disabled=true;
};
btnPauseSess.onclick = async ()=>{
  if(!sess.id) return;
  const j = await gasPost('session_pause', {session_id: sess.id, paused: !sess.paused});
  sess.paused = j.paused; liveState.textContent = sess.paused? 'paused' : 'live';
};
btnRotateGuest.onclick = async ()=>{
  if(!sess.id) return;
  const j = await gasPost('session_rotate', {session_id: sess.id});
  sess.guest_token = j.guest_token;
  alert('Nouveau lien invit√© g√©n√©r√©.');
};
btnCopyGuest.onclick = async ()=>{
  if (!window._guest_url) return;
  try {
    await navigator.clipboard.writeText(window._guest_url);
  } catch {
    // fallback silencieux (pas d'alert)
    const ta = document.createElement('textarea');
    ta.value = window._guest_url;
    ta.style.position='fixed'; ta.style.opacity='0';
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  }
};

btnPushGh.onclick = async ()=>{
  try{
    ghState.textContent='Push‚Ä¶';
    const wid = localStorage.getItem('paria_work_id')||'';
    const {client, service, date} = parseWorkId();
    const s = svc();
    const state_json = JSON.stringify(s,null,2);
    const md = makeMarkdown(service, s);
    const message = (gh_msg.value||`snapshot: ${service} ${date}`);
    await gasPost('git_snapshot', {work_id: wid, service, date, state_json, md, message});
    ghState.textContent='OK ‚úî';
  }catch(e){ ghState.textContent='Erreur'; alert(e.message); }
};
const dumpEl = document.getElementById('dump');

function refreshDump(){
  try {
    const s = svc(); // ton √©tat courant (service s√©lectionn√©)
    dumpEl.textContent = JSON.stringify(s || {}, null, 2);
  } catch(e) {
    dumpEl.textContent = 'Erreur JSON: ' + e.message;
  }
}

btnDump.onclick = () => {
  const raw = localStorage.getItem('paria_db');
  const obj = raw ? JSON.parse(raw) : (window.db || {});
  const el  = document.getElementById('dump');
  if (!el) { alert('√âl√©ment <pre id="dump"> introuvable.'); return; }
  el.textContent = JSON.stringify(obj, null, 2) || '‚Äî';
  // au cas o√π c‚Äôest masqu√© par un wrapper :
  el.parentElement?.classList?.remove('hide');
  el.style.display = 'block';
};

function startPoll(){
  stopPoll();
  poller = setInterval(async ()=>{
    if(!sess.id) return;
    try{
      const j = await gasGet('events_since', {session_id: sess.id, token: sess.operator_token, after: sess.last_seq});
      sess.paused = j.paused; liveState.textContent = sess.paused? 'paused' : 'live';
      (j.events||[]).forEach(ev=>{ sess.last_seq=Math.max(sess.last_seq, ev.seq||0); applyEvent(ev); });
    }catch(e){ /* ignore qques rat√©s r√©seau */ }
  }, 1500);
}
function stopPoll(){ if(poller){ clearInterval(poller); poller=null; } }

/* Applique un event entrant invited/operator -> sur l‚Äô√©tat */
function applyEvent(ev){
  const e = ev.event||{};
  const s = svc();
  if(e.type==='prop_decision'){
    const it = (s.items||[]).find(x=>x.id===e.card_id); if(!it) return;
    const p = (it.propositions||[]).find(x=>x.pid===e.pid); if(!p) return;
    p.decision = p.decision || {status:'a_preciser', comment:''};
    if(e.status)  p.decision.status  = e.status;
    if(e.comment!==undefined) p.decision.comment = e.comment;
    it.pipeline = recomputePipelineForItem(it);
    touch();
    // si la card affich√©e est celle-ci, re-render
  }
  if(e.type==='comment'){ // commentaire simple (cr√©e un fil de discussions basique)
    const it = (s.items||[]).find(x=>x.id===e.card_id); if(!it) return;
    (it.comments||(it.comments=[])).push({ts:ev.ts, who: ev.role, pid: e.pid, text:e.text});
    touch();
  }
  // plus tard: sim_create (Sx) -> ajouter √† it.propositions[i].sims
  touch();
}

/* Helpers pour pousser un event quand TOI tu agis */
async function pushDecision(card_id, pid, status, comment){
  if(!sess.id) return; // si pas de s√©ance, pas d‚Äôevent (local only)
  try{
    await gasPost('event_push', {session_id: sess.id, token: sess.operator_token, role:'operator', event:{type:'prop_decision', card_id, pid, status, comment}});
  }catch(e){}
}
async function pushComment(card_id, pid, text){
  if(!sess.id) return;
  try{
    await gasPost('event_push', {session_id: sess.id, token: sess.operator_token, role:'operator', event:{type:'comment', card_id, pid, text}});
  }catch(e){}
}

let _saveTimer=null, _lastSaveTs=0;
function autosaveCloud(){
  if(_saveTimer) clearTimeout(_saveTimer);
  _saveTimer = setTimeout(async ()=>{
    try{
      const wid = localStorage.getItem('paria_work_id')||'';
      const service = currentService();
      const state = svc();
      await gasPost('save', {work_id: wid || (`CLIENT|${service}|`+new Date().toISOString().slice(0,10)), state});
      _lastSaveTs = Date.now();
      if (gsState) gsState.textContent = 'Sauv√© ‚úî ' + new Date(_lastSaveTs).toLocaleTimeString();
    }catch(e){}
  }, 1200);
}
async function saveCloudNow(){
  const wid = localStorage.getItem('paria_work_id')||currentWorkId();
  const state = svc();
  await gasPost('save', {work_id: wid, state});
}

// √Ä appeler apr√®s CHAQUE action cl√© :
function touch(){ saveDB(); localStorage.setItem('paria_touch', String(Date.now())); autosaveCloud(); }

/* ====== SNAPSHOT GIT AUTO (10 min) ====== */
let _gitTimer = null, _lastGitTs = 0;
async function snapshotGitAuto(reason='auto-10min'){
  try{
    const wid = localStorage.getItem(WORK_KEY)||'';
    if(!wid) return;
    const {service, date} = parseWorkId();
    const s = svc();
    const state_json = JSON.stringify(s,null,2);
    const md = makeMarkdown(service, s);
    const message = (gh_msg?.value || `snapshot(${reason}): ${service} ${date}`);
    await gasPost('git_snapshot', { work_id: wid, service, date, state_json, md, message });
    _lastGitTs = Date.now();
    if (ghState) ghState.textContent = 'Auto ‚úî ' + new Date(_lastGitTs).toLocaleTimeString();
  }catch(e){
    if (ghState) ghState.textContent = 'Auto: en attente';
    // on n‚Äôinterrompt pas la s√©ance : on retentera au prochain tick
  }
}
function startGitTimer(){
  if(_gitTimer) clearInterval(_gitTimer);
  _gitTimer = setInterval(()=> snapshotGitAuto('auto-10min'), 10*60*1000); // 10 min
}
startGitTimer();
 
/* ====== BOOT R√âGLAGES ====== */
(function bootCfg(){
  document.getElementById('GAS_URL').value = gasUrl();
	document.getElementById('public_base').value = publicBase();
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('workDate').value = today;
  const wid = localStorage.getItem(WORK_KEY)||'‚Äî';
  document.getElementById('workIdHdr').textContent = wid;
	document.getElementById('PROXY_SECRET').value = proxySecret();

  // GH cfg
  gh_owner.value  = localStorage.getItem(GH_OWNER)||'';
  gh_repo.value   = localStorage.getItem(GH_REPO)||'';
  gh_branch.value = localStorage.getItem(GH_BRANCH)||'main';
  gh_base.value   = localStorage.getItem(GH_BASE)||'clients';
  gh_token.value  = localStorage.getItem(GH_TOKEN)||'';
  gh_msg.value    = gh_msg.value || `feat: audit ${currentService()} ${today}`;
})();
	
btnSaveCfg.onclick = ()=>{
  setGasUrl(document.getElementById('GAS_URL').value);
  localStorage.setItem('paria_public_base', document.getElementById('public_base').value.trim());
  localStorage.setItem(PROXY_SECRET_KEY, document.getElementById('PROXY_SECRET').value.trim());
  alert('R√©glages sauvegard√©s.');
};

btnTestProxy.onclick = async ()=>{
  const u = gasUrl(); if(!u) return alert('Renseigne le DEPLOY URL.');
  try{
    const pong = await fetch(gasUrl()+`?route=ping&secret=${encodeURIComponent(proxySecret())}`); // <-- ton PROXY_SECRET
    const j = await pong.json();
    proxyState.textContent = j.ok ? 'OK ‚úî' : 'Erreur';
  }catch(e){
    proxyState.textContent = 'Erreur';
  }
};

btnBindWork.onclick = bindWork;

/* ====== LOAD / SAVE (Apps Script) ====== */
btnLoad.onclick = async ()=>{
  const u = gasUrl(); if(!u) return alert('Proxy non configur√©.');
  const wid = localStorage.getItem(WORK_KEY) || currentWorkId();      // ex: ACME|Compta|2025-08-30
  const svcKey = (wid.split('|')[1] || '').trim() || currentService();// <- cl√© service depuis WID
  gsState.textContent = 'Chargement‚Ä¶';
  try{
    const r = await fetch(`${u}?route=load&secret=${encodeURIComponent(proxySecret())}&work_id=${encodeURIComponent(wid)}`);
    const j = await r.json();
    if(j.ok && j.data){
      // normalise si besoin (au cas o√π le JSON n‚Äôa pas la structure attendue)
      const data = j.data && j.data.charter ? j.data
                   : { charter:{}, items:[], decisions:[], scenarios:[], ...j.data };
      db.services = db.services || {};
      db.services[svcKey] = data;     // <- range au bon endroit
      saveDB();
      // option: bascule l‚ÄôUI sur ce service
      if (typeof selectService === 'function') selectService(svcKey);
      gsState.textContent='Charg√© ‚úî';
    } else if(j.ok && !j.data){
      gsState.textContent='Aucune donn√©e';
    } else {
      gsState.textContent='Erreur'; alert('LOAD: '+(j.error||'inconnu'));
    }
  }catch(e){ gsState.textContent='Erreur'; alert('LOAD exception: '+e.message); }
};


btnSave.onclick = async ()=>{
  const u=gasUrl(); if(!u) return alert('Proxy non configur√©.');
  const wid = localStorage.getItem(WORK_KEY)||currentWorkId();
  const key = currentService();
  const state = db.services[key] || {charter:{},items:[],decisions:[],scenarios:[]};
  try{
    const r = await fetch(u,{
  		method:'POST',
  		headers:{'Content-Type':'text/plain'},
  		body: JSON.stringify({ route:'save', secret: proxySecret(), work_id: wid, state })
		});
    const j = await r.json();
    gsState.textContent = j.ok ? 'Sauv√© ‚úî' : 'Erreur';
  }catch(e){ gsState.textContent='Erreur'; alert(e.message); }
};

/* ====== DUMP / CLEAR ====== */
btnClear.onclick = () => {
  if (!confirm('Effacer l‚Äô√©tat local ?')) return;
  localStorage.removeItem('paria_db');
  if (typeof loadDB === 'function') loadDB();
  const el = document.getElementById('dump');
  if (el) el.textContent = '‚Äî';
  alert('R√©initialis√©.');
};

/* ====== CHARTER ====== */
function hydrateCharter(){
  const ch = (svc().charter||{});
  ch_obj.value = ch.objectifs||''; ch_ctx.value=ch.contexte||''; ch_scope.value=ch.perimetre||'';
  ch_hard.value = ch.contraintes||''; ch_pains.value=ch.douleurs||''; ch_kpi.value=ch.kpis||'';
  ch_tools.value=ch.outils||''; ch_roles.value=ch.roles||''; ch_budget.value=ch.budget||'';
  charterState.textContent='Charg√© ‚úî';
}
btnCharterFromState.onclick = hydrateCharter;
btnCharterToState.onclick = ()=>{
  const s=svc();
  s.charter = {
    objectifs: ch_obj.value.trim(), contexte: ch_ctx.value.trim(), perimetre: ch_scope.value.trim(),
    contraintes: ch_hard.value.trim(), douleurs: ch_pains.value.trim(), kpis: ch_kpi.value.trim(),
    outils: ch_tools.value.trim(), roles: ch_roles.value.trim(), budget: ch_budget.value.trim()
  };
  touch(); charterState.textContent='Sauv√© ‚úî';
};

/* ====== DICT√âE (anti-duplication) ====== */
(function setupMic(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ micStatus.textContent='(non support√©e)'; return; }
  const rec=new SR(); rec.lang='fr-FR'; rec.continuous=true; rec.interimResults=false;
  let on=false;
  btnMic.onclick=()=>{
    if(!on){ rec.start(); on=true; micStatus.textContent='√âcoute‚Ä¶'; btnMic.textContent='‚ñ† Stop'; }
    else   { rec.stop();  on=false; micStatus.textContent='‚Äî';       btnMic.textContent='üéôÔ∏è Dicter'; }
  };
  rec.onresult=(e)=>{
    for(let i=e.resultIndex;i<e.results.length;i++){
      const res=e.results[i]; if(res.isFinal){
        const txt=res[0].transcript.trim();
        if(!note.value.trim().endsWith(txt)) note.value=(note.value+' '+txt).trim();
      }
    }
  };
  rec.onend=()=>{ if(on) rec.start(); else { micStatus.textContent='‚Äî'; btnMic.textContent='üéôÔ∏è Dicter'; } };
})();

/* ====== ANALYSE (Apps Script -> OpenAI) ====== */
btnAnalyze.onclick = async ()=>{
  const u=gasUrl(); if(!u) return alert('Proxy non configur√©.');
  const s=svc();
  const noteEl = document.getElementById('note');
	const noteText = noteEl ? noteEl.value : '';
	const payload = { route:'analyze', secret: proxySecret(), model: MODEL, service_key: currentService(), charter: s.charter, note: noteText };
	console.log('[analyze] note len=', noteText.length, 'sample=', noteText.slice(0,80));

  aiState.textContent='Analyse‚Ä¶';
  try{
    const r=await fetch(u,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)});
    const j=await r.json();
    if(!j.ok) throw new Error(j.error||'analyse KO');
    const item=j.data;

    // normalisation
    item.id = item.id || ('I'+((s.items?.length||0)+1));
    item.title = item.title || (item.reformulation || 'Sujet √† pr√©ciser');
    (item.propositions||[]).forEach((p,i)=>{
      p.pid = p.pid || ('P'+(i+1));
      p.decision = p.decision || { status:'a_preciser', comment:'' };
    });
    item.pipeline = item.pipeline || 'pret_projecteur';
    item.priority = item.priority || 'P2';

  	// si le titre renvoy√© est court, pr√©f√®re la reformulation plus compl√®te
		if ((item.reformulation||'').length > (item.title||'').length) {
  		item.title = item.reformulation;
		}

    s.items.push(item);
    touch();
    analysis.textContent = JSON.stringify(item,null,2);
    aiState.textContent='OK ‚úî';
    touch();
  }catch(e){
    aiState.textContent='Erreur';
    alert('Analyse √©chou√©e: '+e.message);
  }
};

function openScenario(sid){
  const s = svc(); const sc=(s.scenarios||[]).find(x=>x.id===sid); 
  const el=document.getElementById('scWork'); if(!el){return;}
  if(!sc){ el.innerHTML='<em>Aucun sc√©nario s√©lectionn√©.</em>'; return; }
  const snap = sc.snapshot || { items:[], decisions:[] };
  const it = (snap.items||[]).find(x=>String(x.id)===String(s._lastCard || (s.items||[])[(s.items||[]).length-1]?.id)) || snap.items[0];
  if(!it){ el.innerHTML='<em>Sc√©nario vide.</em>'; return; }

	el.innerHTML = `
	  <div style="display:flex;gap:8px;margin-bottom:8px">
	    <button id="btnScInsert">Ins√©rer sims s√©lectionn√©es (${htmlEscape(sc.id)})</button>
	    <button id="btnScPromote">Promouvoir ${htmlEscape(sc.id)}</button>
	  </div>
	  ${renderCardCommon(
	    (sc.snapshot?.items||[]).find(x=>String(x.id)===String((svc()._lastCard)||((svc().items||[]).slice(-1)[0]?.id))) 
	    || (sc.snapshot?.items||[])[0] || {propositions:[]}
	  )}
	`;

  // handlers card dans le snapshot (√©dition dans le snapshot)
  attachCardHandlers(
    el,
    ()=>snap,
    (S)=>{ sc.snapshot = S; saveDB(); },
    ()=>{ openScenario(sid); }
  );

  // actions sp√©cifiques
  document.getElementById('btnScInsert').onclick = ()=>{
    const ref = svc(); // mod√®le projecteur
    // pour chaque proposition pick√©e du snapshot, on l‚Äôins√®re/maj dans la card de ref
    (snap.items||[]).forEach(si=>{
      const ti = (ref.items||[]).find(x=>String(x.id)===String(si.id)); if(!ti) return;
      (si.propositions||[]).forEach(sp=>{
        (sp.sims||[]).filter(sm=>sm.picked).forEach(sm=>{
          const tp=(ti.propositions||[]).find(pp=>String(pp.pid)===String(sp.pid)); if(!tp) return;
          tp.sims = Array.isArray(tp.sims)? tp.sims : [];
          tp.sims.push({ ...sm, origin:(sm.origin||'IA'), who:'scenario', scenario: sc.id, id: (tp.sims.length+1) });
        });
      });
    });
    alert('Simulations ins√©r√©es depuis '+sc.id);
  };

  document.getElementById('btnScPromote').onclick = ()=>{
    const ref = svc();
    ref.items = JSON.parse(JSON.stringify(snap.items||[]));
    ref.decisions = JSON.parse(JSON.stringify(snap.decisions||[]));
    alert('Sc√©nario '+sc.id+' promu sur la carte de r√©f√©rence.');
  };
}
	
function recomputePipelineForItem(it){
  const statuses = (it.propositions||[]).map(p=> (p.decision?.status)||'a_preciser');
  const hasAny = statuses.some(s => s==='valide' || s==='refuse');
  const allFinal = statuses.length>0 && statuses.every(s => s==='valide' || s==='refuse');
  if (allFinal) return 'bouclee';
  if (hasAny)   return 'en_validation';
  return 'pret_projecteur';
}

async function runSim(item, prop, comment){
  const u = gasUrl(); if(!u) return alert('Proxy non configur√©.');
  const s = svc();
  const payload = {
	  route:'analyze', secret: proxySecret(), model:MODEL,
	  service_key: currentService(),
	  charter: s.charter,
	  note: comment || (item.reformulation||'')
	};

  try{
    const r = await fetch(u,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)});
    const j = await r.json(); if(!j.ok) throw new Error(j.error||'analyse KO');
    const now = Date.now();
    const sid = 'S'+(((prop.sims||[]).length||0)+1);
    const sim = {
      id: sid, origin:'IA', ts: now,
      comment_source: comment||'',
      impact: { cout:'‚âà', delai:'‚âà', risque:'‚âà' }, // tu peux raffiner avec le retour
      paria: j.data?.paria || {},
      note: j.data?.reformulation || 'Simulation g√©n√©r√©e'
    };
    (prop.sims||(prop.sims=[])).push(sim);
    item.pipeline = recomputePipelineForItem(item);
    touch(); // autosave local + Drive
  }catch(e){
    alert('Simulation KO: '+e.message);
  }
}

/* ====== D√âCISIONS ====== */
function renderLastItem(){
  const s=svc();
  const it = (s.items||[])[(s.items||[]).length-1];
  if(!it){ lastItem.textContent='‚Äî'; return; }
  lastItem.textContent = JSON.stringify({
    id: it.id, title: it.title||it.reformulation||'', paria: it.paria||{}, propositions: it.propositions||[], questions: it.questions||[]
  },null,2);
}
document.querySelectorAll('.decide').forEach(b=>{
  b.onclick=()=>{
    const s=svc(); const it=(s.items||[])[(s.items||[]).length-1]; if(!it) return;
    (s.decisions||(s.decisions=[])).push({ ts:Date.now(), status:b.dataset.status, item:{ id:it.id, reformulation: it.reformulation||it.title||'' }});
    touch(); renderDecisions(); decState.textContent='Not√© ‚úî';
    touch();
  };
});
function renderDecisions(){
  const s=svc(), el=document.getElementById('decisions');
  if(!s.decisions?.length){ el.innerHTML='<em>Aucune d√©cision.</em>'; return; }
  el.innerHTML = s.decisions.slice().reverse().map(d=>{
    const txt = d.item?.reformulation || d.note || '';
    const st  = d.status || d.type || '';
    return `<div class="pill">${new Date(d.ts).toLocaleString()} ‚Äî <b>${st}</b> ‚Äî ${txt}</div>`;
  }).join('');
}

/* Alias legacy (certaines zones appellent encore renderJournal) */
window.renderJournal = window.renderDecisions;

/* ====== EXPORTS ====== */
btnExportMd.onclick=()=>{
  const key=currentService(); const s=svc();
  const md = makeMarkdown(key,s);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([md],{type:'text/markdown'}));
  a.download=`audit_${key}_${new Date().toISOString().slice(0,10)}.md`; a.click();
  expState.textContent='Export√© ‚úî';
};
function makeMarkdown(key,s){
  const L=[]; L.push(`# Audit ${key} ‚Äî PARIA`,'','## Service Charter');
  for(const [k,v] of Object.entries(s.charter||{})) L.push(`- **${k}**: ${v||'-'}`);
  L.push('','## Analyses');
  (s.items||[]).forEach((it,i)=>{
    L.push(`### Item #${i+1} (${it.id})`);
    if(it.reformulation) L.push(`Reformulation: ${it.reformulation}`);
    const b=it.paria||{};
    for(const k of ['problemes','ameliorations','reconfigurations','integration_ia','actions']){
      if(b[k]?.length){ L.push(`- **${k}**:`); b[k].forEach(x=>L.push(`  - ${x}`)); }
    }
    if(it.questions?.length){ L.push(`- **Questions**:`); it.questions.forEach(q=>L.push(`  - ${q}`)); }
    if(it.propositions?.length){
      L.push(`- **Propositions**:`); it.propositions.forEach(p=>L.push(`  - ${p.pid||''} ${p.label} ‚Äî ${p.type} [${p.indicateurs?.cout||'-'}/${p.indicateurs?.complexite||'-'}]`));
    }
    L.push('');
  });
  L.push('## D√©cisions');
  (s.decisions||[]).forEach(d=>L.push(`- ${new Date(d.ts).toLocaleString()} ‚Äî **${d.status||d.type||''}** ‚Äî ${d.item?.reformulation||d.note||''}`));
  return L.join('\n');
}

/* ====== Export HTML client + Import JSON ====== */
btnExportClientHtml.onclick = ()=>{
  const s = svc();
  const pack = { service: currentService(), charter: s.charter, items: s.items };
  const html = makeClientHtml(pack);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([html],{type:'text/html'}));
  a.download = `form_client_${currentService()}_${new Date().toISOString().slice(0,10)}.html`;
  a.click();
};

btnImportClientJson.onclick = ()=> clientJsonFile.click();
clientJsonFile.onchange = async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  let obj; try{ obj=JSON.parse(await f.text()); }catch{ return alert('JSON invalide'); }
  const s=svc(); let n=0;
  (obj?.responses||[]).forEach(r=>{
    const it = (s.items||[]).find(x=>x.id===r.card_id); if(!it) return;
    const p  = (it.propositions||[]).find(y=>y.pid===r.pid); if(!p) return;
    p.decision = { status:r.decision, comment:r.comment||'', source:'client', ts: Date.now(), import_file: (f?.name||'') };
    it.pipeline = recomputePipelineForItem(it);
    n++;
   	(s.decisions||(s.decisions=[])).push({ 
		  ts: Date.now(), type:'client_import', status:r.decision,
		  item:{ id:it.id, reformulation: it.reformulation||it.title||'' },
		  note:`${r.pid} ${r.decision}${r.comment? ' ('+r.comment+')':''} ¬∑ file:${f?.name||''}`
		});
  });
  touch(); 
  renderDecisions();
  alert(`R√©ponses client int√©gr√©es (${n}).`);
};

// G√©n√®re une page autonome que le client peut remplir (puis T√©l√©charger JSON)
// G√©n√®re une page autonome que le client peut remplir (puis T√©l√©charger JSON)
function makeClientHtml(pack){
  const safe = x=> String(x||'').replace(/[&<>]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;'})[s]);
  const rows = (pack.items||[]).map(it=>{
    const props = (it.propositions||[]).map(p=>`
      <tr>
        <td>${safe(p.pid)}</td>
        <td>${safe(p.label)}</td>
        <td>
          <select data-pid="${safe(p.pid)}" data-card="${safe(it.id)}">
            <option value="valide">Valider</option>
            <option value="a_preciser" selected>√Ä pr√©ciser</option>
            <option value="refuse">Refuser</option>
          </select>
        </td>
        <td><input type="text" data-cmt="1" data-pid="${safe(p.pid)}" data-card="${safe(it.id)}" placeholder="Commentaire"></td>
      </tr>`).join('');
    return `
      <section style="margin:12px 0;padding:10px;border:1px solid #eee;border-radius:8px">
        <h3>${safe(it.title||it.reformulation||'(sujet)')}</h3>
        <table border="1" cellpadding="6" style="border-collapse:collapse;width:100%">
          <thead><tr><th>PID</th><th>Proposition</th><th>D√©cision</th><th>Commentaire</th></tr></thead>
          <tbody>${props}</tbody>
        </table>
      </section>`;
  }).join('');

  return `<!doctype html><meta charset="utf-8"><title>Formulaire client ‚Äî ${safe(pack.service)}</title>
  <h2>Validation ‚Äî ${safe(pack.service)}</h2>
  <p>Choisissez une d√©cision pour chaque proposition, ajoutez un commentaire si besoin, puis <b>T√©l√©charger les r√©ponses</b> (ou Imprimer ‚Üí PDF).</p>
  ${rows}
  <button id="dl">T√©l√©charger les r√©ponses (JSON)</button>
  <button onclick="window.print()">Imprimer/PDF</button>
  <script>
    document.getElementById('dl').onclick = ()=>{
      const picks = [];
      document.querySelectorAll('select[data-pid]').forEach(sel=>{
        const pid=sel.getAttribute('data-pid');
        const cid=sel.getAttribute('data-card');
        const decision=sel.value;
        const cmt = (document.querySelector('input[data-cmt][data-pid="'+pid+'"][data-card="'+cid+'"]')||{}).value||'';
        picks.push({card_id:cid,pid,decision,comment:cmt});
      });
      const blob = new Blob([JSON.stringify({ responses:picks },null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'reponses_client.json';
      a.click();
    };
  <\/script>`;
}

/* ====== PROJECTEUR : inline ====== */
function chip(t){ return `<span style="border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin-right:6px">${t}</span>`; }
function stateBadge(p){ const map={discovery:'#A8B0B9',pret_projecteur:'#2463EB',en_validation:'#F59E0B',bouclee:'#10B981'}; const c=map[p]||'#A8B0B9'; return `<span style="background:${c};color:#fff;border-radius:6px;padding:2px 8px">${p||'‚Äî'}</span>`; }
function originTag(origin, who){
  // Normalise
  const label = origin
    || (who==='guest' ? 'Client' : who==='operator' ? 'SenIAr' : '‚Äî');
  const text  = (label==='ClientImport') ? 'Client (import)' : label;

  // Couleurs
  const colMap = {
    'IA':'#7c3aed',          // violet
    'Client':'#0ea5e9',      // bleu
    'ClientImport':'#0284c7',// bleu + fonc√©
    'SenIAr':'#14b8a6',      // turquoise
    '‚Äî':'#9ca3af'
  };
  const col = colMap[label] || '#9ca3af';

  return `<span style="display:inline-block;background:${col};color:#fff;border-radius:999px;padding:2px 8px;font-size:12px;line-height:18px">${text}</span>`;
}
// -- helpers communs
function htmlEscape(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function labelOf(it){ return htmlEscape(it?.title || it?.reformulation || '(sujet)'); }
function importBadge(dec){ return (dec?.import_file) ? `<span style="border:1px solid #60a5fa;border-radius:6px;padding:1px 6px;margin-left:6px">fichier: ${htmlEscape(dec.import_file)}</span>` : ''; }
function simsHtml(it,p){
  const sims=(p.sims||[]);
  return sims.map(sm=>`
    <div style="border:1px dashed #ddd;border-radius:6px;padding:8px;margin-top:6px">
      <div style="display:flex;align-items:center;gap:8px;font-size:12px;opacity:.9">
        <button class="spick" data-c="${it.id}" data-p="${p.pid}" data-s="${sm.id}" title="S√©lectionner cette simulation">${sm.picked?'‚òÖ':'‚òÜ'}</button>
        ${originTag(sm.origin||'IA')}
        <span>${htmlEscape(sm.id||'S')}</span>
        <span>${sm.ts? new Date(sm.ts).toLocaleTimeString(): ''}</span>
      </div>
      <div style="margin:4px 0">${htmlEscape(sm.note||'')}</div>
      <div style="font-size:12px;opacity:.8">impact: co√ªt ${htmlEscape(sm.impact?.cout??'‚Äî')} ¬∑ d√©lai ${htmlEscape(sm.impact?.delai??'‚Äî')} ¬∑ risque ${htmlEscape(sm.impact?.risque??'‚Äî')}</div>
    </div>`).join('');
}
function notesHtml(p){
  return (p.notes||[]).slice(-6).map(n=>`
    <div style="display:flex;gap:8px;align-items:baseline;margin-top:6px">
      ${originTag(n.origin, n.who)}
      <span style="font-size:12px;opacity:.7">${n.ts? new Date(n.ts).toLocaleTimeString(): ''}</span>
      <div>${htmlEscape(n.text||'')}</div>
    </div>`).join('');
}

// -- rendu projeteur commun (card)
function renderCardCommon(it){
  const props=(it.propositions||[]);
  const propsHtml = props.map((p,i)=>{
    const st=(p.decision?.status)||'a_preciser';
    const is = s=> (st===s ? 'class="pact active"' : 'class="pact"');
    return `
    <div style="border:1px solid #eee;border-radius:8px;padding:10px;margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div><strong>${htmlEscape(p.pid||('P'+(i+1)))}</strong> ¬∑ ${htmlEscape(p.label||'')}</div>
        <div>
          <button ${is('valide')}      data-c="${it.id}" data-p="${p.pid}" data-act="valide" style="margin-right:6px">Valider</button>
          <button ${is('a_preciser')}  data-c="${it.id}" data-p="${p.pid}" data-act="a_preciser" style="margin-right:6px">√Ä pr√©ciser</button>
          <button ${is('refuse')}      data-c="${it.id}" data-p="${p.pid}" data-act="refuse">Refuser</button>
          ${importBadge(p.decision)}
        </div>
      </div>
      <div style="opacity:.8;margin:4px 0">co√ªt:${htmlEscape(p.indicateurs?.cout??'‚Äî')} ¬∑ complexit√©:${htmlEscape(p.indicateurs?.complexite??'‚Äî')} ¬∑ embauche:${htmlEscape(p.indicateurs?.embauche??'‚Äî')} ¬∑ donn√©es:${htmlEscape(p.indicateurs?.donnees??'‚Äî')}</div>
      <label style="font-size:.9em;opacity:.8">Commentaire</label>
      <div style="display:flex;gap:6px;align-items:center">
			  <input type="text" class="pcmt" data-c="${it.id}" data-p="${p.pid}" value="${htmlEscape(p.decision?.comment||'')}" style="width:100%">
			  <button class="psim" data-c="${it.id}" data-p="${p.pid}">‚ö°</button>
			</div>
      <div style="margin-top:8px">${simsHtml(it,p)}</div>
      <div style="margin-top:6px">${notesHtml(p)}</div>
    </div>`;
  }).join('');

  return `
  <div class="card">
    <div style="font-weight:700;font-size:16px;margin-bottom:6px">${labelOf(it)}</div>
    <div id="propList">${propsHtml || '<em>Aucune proposition.</em>'}</div>
  </div>`;
}

// -- handlers communs (Valider/√Ä pr√©ciser/Refuser, commentaire, s√©lection simu)
function attachCardHandlers(root, getState, setState, onChange){
  // d√©cisions
  root.querySelectorAll('.pact').forEach(b=>{
    b.onclick = ()=>{
      const c = b.getAttribute('data-c'); const pid = b.getAttribute('data-p'); const act = b.getAttribute('data-act');
      const S = getState(); const it = (S.items||[]).find(x=>String(x.id)===String(c)); if(!it) return;
      const p = (it.propositions||[]).find(pp=>String(pp.pid)===String(pid)); if(!p) return;
      p.decision = p.decision||{}; p.decision.status = act; p.decision.ts = Date.now();
      setState(S); onChange && onChange();
    };
  });
  // commentaire
  root.querySelectorAll('.pcmt').forEach(inp=>{
    inp.onchange = ()=>{
      const c = inp.getAttribute('data-c'); const pid = inp.getAttribute('data-p');
      const S = getState(); const it = (S.items||[]).find(x=>String(x.id)===String(c)); if(!it) return;
      const p = (it.propositions||[]).find(pp=>String(pp.pid)===String(pid)); if(!p) return;
      p.decision = p.decision||{}; p.decision.comment = inp.value; p.decision.ts = Date.now();
      setState(S); onChange && onChange();
    };
  });
	// simulation IA (‚ö°) : prend le commentaire courant comme note source
	root.querySelectorAll('.psim').forEach(btn=>{
	  btn.onclick = async ()=>{
	    const c = btn.getAttribute('data-c'); const pid = btn.getAttribute('data-p');
	    const S = getState(); const it = (S.items||[]).find(x=>String(x.id)===String(c)); if(!it) return;
	    const p = (it.propositions||[]).find(pp=>String(pp.pid)===String(pid)); if(!p) return;
	    const cmt = root.querySelector(`.pcmt[data-c="${c}"][data-p="${pid}"]`)?.value || '';
	    await runSim(it, p, cmt);
	    setState(S); onChange && onChange();
	  };
	});

  // s√©lection simu ‚òÜ/‚òÖ
  root.querySelectorAll('.spick').forEach(btn=>{
    btn.onclick = ()=>{
      const c = btn.getAttribute('data-c'); const pid = btn.getAttribute('data-p'); const sid = btn.getAttribute('data-s');
      const S = getState(); const it = (S.items||[]).find(x=>String(x.id)===String(c)); if(!it) return;
      const p = (it.propositions||[]).find(pp=>String(pp.pid)===String(pid)); if(!p) return;
      const sm = (p.sims||[]).find(s=>String(s.id)===String(sid)); if(!sm) return;
      sm.picked = !sm.picked; sm.ts_pick = Date.now();
      setState(S); onChange && onChange();
    };
  });
}

function renderProjectorInline(){
  const s=svc();
  const items=(s.items||[]);
	const it = items.find(x=>x.id===window._projSel) || items[items.length-1];
	const ch = document.getElementById('cardHdr'); 
	if (ch) ch.textContent = it?.id || '‚Äî';
  const list=document.getElementById('projAgendaList');
  const card=document.getElementById('projCard');
	if(!it){
	  list.innerHTML = '<li>‚Äî</li>';
	  card.innerHTML='<em>Analyse un item dans ‚ÄúCapture‚Äù pour l‚Äôafficher ici, ou ouvre le Projecteur.</em>';
	  return;
	}
  const chips = (s.charter?.contraintes||'').split(/[;,‚Ä¢\n]/).map(x=>x.trim()).filter(Boolean).slice(0,4).map(chip).join(' ') || chip('‚Äî');
  function pill(dec){ 
    const st=(dec?.status)||'a_preciser';
    const src = dec?.source==='client' ? ' <span style="border:1px solid #60a5fa;border-radius:6px;padding:1px 6px;margin-left:6px">client</span>' : '';
    return `<span class="status-pill"><span class="dot ${st}"></span>${st.replace('_',' ')}</span>`;
  }
	const sel = window._projSel || (items[items.length-1]?.id);
	list.innerHTML = items.map(x=>{
	  const cur = (x.id===sel) ? 'font-weight:700;text-decoration:underline;' : '';
	  const label = x.title || x.reformulation || '‚Äî';
	  return `<li style="margin:6px 0"><a href="#" data-c="${x.id}" style="${cur}">${label}</a></li>`;
	}).join('') || '<li>‚Äî</li>';
	
	list.querySelectorAll('a[data-c]').forEach(a=>{
	  a.onclick=(e)=>{ e.preventDefault(); window._projSel=a.dataset.c; renderProjectorInline(); };
	});
	  // ---- Rendu card + handlers (page type)
	  card.innerHTML = renderCardCommon(it);
	  attachCardHandlers(
	    card,
	    ()=>svc(),
	    (S)=>{ touch(); },
	    ()=>{ renderProjectorInline(); }
	  );
}

btnOpenProjector.onclick = ()=>{
  // 1) Aligne le WID sur le service/date affich√©s
  if (typeof bindWork==='function') bindWork();

  // 2) Ouvre le projecteur en standalone (avec proxy si dispo)
  const base = location.href.split('?')[0];
  const url = new URL(base);
  url.searchParams.set('projecteur','1');
  const prox = gasUrl(); if (prox) url.searchParams.set('prox', prox);
  window.open(url.toString(),'projecteur_'+(localStorage.getItem(WORK_KEY)||''),'noopener');
};

/* ====== SC√âNARIOS ====== */
btnForkScenario.onclick = ()=>{
  const s=svc();
  (s.scenarios||(s.scenarios=[]));
  s.scenarios = Array.isArray(s.scenarios) ? s.scenarios : [];
	const id = 'S'+(s.scenarios.length+1);
	const snap = {
	  charter: s.charter || {},
	  items: JSON.parse(JSON.stringify(s.items||[])),
	  decisions: JSON.parse(JSON.stringify(s.decisions||[]))
	};
	s.scenarios.push({ id, snapshot: snap, ts: Date.now() });
	touch(); renderScList(); alert(`Sc√©nario ${id} cr√©√©.`);
};
btnPromoteScenario.onclick = ()=>{
  const s=svc(); if(!s.scenarios?.length) return alert('Aucun sc√©nario.');
  const cur = localStorage.getItem('paria_sel_scenario') || '';
  const chosen = s.scenarios.find(x=>x.id===cur) || s.scenarios[s.scenarios.length-1];
  const snap = chosen.snapshot || {};
  s.items     = Array.isArray(snap.items)     ? JSON.parse(JSON.stringify(snap.items))     : (s.items||[]);
  s.decisions = Array.isArray(snap.decisions) ? JSON.parse(JSON.stringify(snap.decisions)) : (s.decisions||[]);
  touch(); renderScList(); alert(`Sc√©nario ${chosen.id} promu (items & d√©cisions).`);
};

function renderScList(){
  const s=svc(); const el=document.getElementById('scList');
  if(!s.scenarios?.length){ el.innerHTML='<em>Aucun sc√©nario.</em>'; return; }

  const cur = localStorage.getItem('paria_sel_scenario') || '';
  el.innerHTML = s.scenarios.map(sc=>{
    const sel = (sc.id===cur) ? 'style="font-weight:700"' : '';
    return `<button class="pill scPick" data-id="${sc.id}" ${sel}>${sc.id} ‚Äî ${new Date(sc.ts).toLocaleString()}</button>`;
  }).join(' ');

  el.querySelectorAll('.scPick').forEach(b=>{
		b.onclick = ()=>{
		  localStorage.setItem('paria_sel_scenario', b.dataset.id);
		  renderScList();
		  document.getElementById('scWork').innerHTML = '';   // √©vite de ‚Äúgarder‚Äù l‚Äôancien rendu
		  openScenario(b.dataset.id);
		};
  });
}

/* ====== Projecteur standalone interactif (plein √©cran) ====== */
(function maybeStandaloneProjector(){
  const params = new URL(location.href).searchParams;
  if(params.get('projecteur')!=='1') return;
	const qpProx = params.get('prox');
	if (qpProx && (!gasUrl() || gasUrl()!==qpProx)) { setGasUrl(qpProx); }

  function loadLocal(){ try{ return JSON.parse(localStorage.getItem(DB_KEY)||'{"services":{}}'); }catch(e){ return {services:{}}; } }
  function saveLocal(x){ localStorage.setItem(DB_KEY, JSON.stringify(x)); touch(); }

  document.body.innerHTML = `
    <div class="full" style="font-size:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><strong>Projecteur</strong> ‚Äî <span id="p_hdr">‚Äî</span></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="p_prev">‚óÄ</button>
          <button id="p_next">‚ñ∂</button>
          <button id="p_big">A+</button>
          <button id="p_small">A‚àí</button>
          <button id="p_toggle_agenda">Afficher/Masquer Agenda</button>
          <small style="opacity:.7">F11 plein √©cran ¬∑ ‚Üê/‚Üí naviguer ¬∑ 1/2/3 d√©cider</small>
        </div>
      </div>
      <div id="p_grid" class="gridProj">
        <aside id="p_agenda" style="border:1px solid #ddd;border-radius:10px;padding:10px;max-height:74vh;overflow:auto"></aside>
        <main id="p_card" style="border:1px solid #ddd;border-radius:10px;padding:16px;min-height:70vh;background:#fff"></main>
      </div>
    </div>
  `;

  const hdr   = document.getElementById('p_hdr');
  const grid  = document.getElementById('p_grid');
  const agenda= document.getElementById('p_agenda');
  const card  = document.getElementById('p_card');
  const btnPrev = document.getElementById('p_prev');
  const btnNext = document.getElementById('p_next');
  const btnBig  = document.getElementById('p_big');
  const btnSmall= document.getElementById('p_small');
  const btnTogA = document.getElementById('p_toggle_agenda');
	const qp = new URL(location.href).searchParams;
	const qpSec = qp.get('ps');  if (qpSec) setProxySecret(qpSec);
	const qpWid = qp.get('wid'); if (qpWid) localStorage.setItem(WORK_KEY, qpWid);
	const qpProx = qp.get('prox'); if (qpProx) setGasUrl(qpProx);

	// --- SYNC INVIT√â (session events) ---
	let guest = { session:null, role:null, token:null, last_seq:0, poll:null };

	function isGuestMode(){
		const p = new URL(location.href).searchParams;
		return p.get('role') === 'guest' && p.get('session') && p.get('token');
	}
	function readGuestParams(){
		const p = new URL(location.href).searchParams;
		guest.session = p.get('session'); guest.role = 'guest'; guest.token = p.get('token');
	}
	async function pollGuestEvents(){
		if(!guest.session) return;
		try{
			const j = await (async ()=>{
				const u = new URL(gasUrl());
				u.searchParams.set('route','events_since');
				u.searchParams.set('secret', proxySecret());
				u.searchParams.set('session_id', guest.session);
				u.searchParams.set('token', guest.token);
				u.searchParams.set('after', String(guest.last_seq||0));
				const r = await fetch(u.toString());
				return await r.json();
			})();
			if(!j.ok) return;
			(j.events||[]).forEach(ev=>{
				guest.last_seq = Math.max(guest.last_seq, ev.seq||0);
				applyIncomingEventToLocal(ev);
			});
		}catch(e){ /* on tol√®re des rat√©s */ }
	}

	async function loadBaselineFromCloud(){
	  const u = gasUrl(); const sec = proxySecret(); const wid = localStorage.getItem(WORK_KEY)||'';
	  if(!u || !sec || !wid) return false;
	  try{
	    const r = await fetch(`${u}?route=load&secret=${encodeURIComponent(sec)}&work_id=${encodeURIComponent(wid)}`);
	    const j = await r.json();
	    if(j.ok && j.data){
	      state.db = loadLocal(); state.db.services = state.db.services || {};
	      const svcKey = (wid.split('|')[1] || 'Compta');
	      state.db.services[svcKey] = (j.data && j.data.charter) ? j.data : { charter:{}, items:[], decisions:[], scenarios:[], ...j.data };
	      saveLocal(state.db);
	      return true;
	    }
	  }catch(_){}
	  return false;
	}

	function startGuestPoll(){
		stopGuestPoll();
		guest.poll = setInterval(pollGuestEvents, 1500);
	}
	function stopGuestPoll(){ if(guest.poll){ clearInterval(guest.poll); guest.poll=null; } }

	// Applique un event re√ßu sur l'√©tat local du projecteur
	function applyIncomingEventToLocal(ev){
		const e = ev.event||{};
		const items = state.svc.items || [];
		if(e.type==='prop_decision'){
			const it = (state.svc.items||[]).find(x=>x.id===e.card_id);
			const p  = (it.propositions||[]).find(pp=>pp.pid===e.pid); if(!p) return;
			p.decision = p.decision || {status:'a_preciser', comment:''};
			if(e.status) p.decision.status = e.status;
			if(e.comment!==undefined) p.decision.comment = e.comment;
			it.pipeline = recomputePipelineForItem(it);
			saveLocal(state.db); renderCard();
		}
		if(e.type==='comment'){
			const it = (s.items||[]).find(x=>x.id===e.card_id); if(!it) return;
			const prop = (it.propositions||[]).find(pp=>pp.pid===e.pid); if(!prop) return;
			const origin = (ev.role==='guest') ? 'Client' : 'SenIAr';
			(prop.notes||(prop.notes=[])).push({
				ts: ev.ts || Date.now(),
				origin, who: ev.role,
				text: e.text||''
			});
			touch();
			try{
				if(!document.getElementById('tab-projecteur').classList.contains('hide')){
					renderProjectorInline();
				}
			}catch(_){}
		}
		// (plus tard) sim_create ...
	}

  function chip(t){ return `<span style="border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin-right:6px">${t}</span>`; }
  function stateBadge(p){ const map={discovery:'#A8B0B9',pret_projecteur:'#2463EB',en_validation:'#F59E0B',bouclee:'#10B981'}; const c=map[p]||'#A8B0B9'; return `<span style="background:${c};color:#fff;border-radius:6px;padding:2px 8px">${p||'‚Äî'}</span>`; }
  function block(label,arr){ if(!Array.isArray(arr)||!arr.length) return ''; return `<div><strong>${label}</strong><ul style="margin:6px 0 12px 22px">${arr.slice(0,6).map(x=>`<li>${x}</li>`).join('')}</ul></div>`; }

  let state = { db: loadLocal(), svcKey: null, svc: null, agendaIds: [], idx: 0 };

  function deriveService(){
    const wid = localStorage.getItem(WORK_KEY)||'';
    const parts = wid.split('|');
    return parts[1] || Object.keys(state.db.services||{})[0] || 'Compta';
  }
  function computeAgenda(){
    const items = state.svc.items||[];
    const ag = Array.isArray(state.svc.agenda)&&state.svc.agenda.length ? state.svc.agenda.slice() : items.map(x=>x.id);
    return ag.filter(id => items.some(x=>x.id===id));
  }
  function renderAgenda(){
    const items = state.svc.items||[];
    const html = state.agendaIds.map((cid,i)=>{
      const it = items.find(x=>x.id===cid);
      const cur = (i===state.idx) ? 'font-weight:700;text-decoration:underline;' : '';
      const label = (it?.title || it?.reformulation || '‚Äî'); /* fix label */ 
      return `<li style="margin:6px 0"><a href="#" data-i="${i}" style="${cur}">${label}</a></li>`;
    }).join('');
    agenda.innerHTML = `<h4 style="margin:0 0 8px 0">Agenda</h4><ol style="margin:0;padding-left:18px">${html||'<li>‚Äî</li>'}</ol>`;
    agenda.querySelectorAll('a[data-i]').forEach(a=>{
      a.onclick=(e)=>{ e.preventDefault(); state.idx=parseInt(a.dataset.i,10)||0; renderCard(); };
    });
  }
  function decide(cardId, pid, status, comment){
    const items = state.svc.items||[];
    const it = items.find(x=>x.id===cardId); if(!it) return;
    const p  = (it.propositions||[]).find(pp=>pp.pid===pid); if(!p) return;
    p.decision = p.decision || {status:'a_preciser', comment:''};
    if(status) p.decision.status = status;
    if(comment!==undefined) p.decision.comment = comment;
    const all = (it.propositions||[]).every(x=>x.decision && x.decision.status && x.decision.status!=='pending');
    it.pipeline = recomputePipelineForItem(it);
    (it.history||(it.history=[])).push({ts:Date.now(), who:'client', what:`${pid}=${p.decision.status}${p.decision.comment?' ('+p.decision.comment+')':''}`});
    saveLocal(state.db); renderCard();
  }
  function renderCard(){
    const items = state.svc.items||[];
    if(!state.agendaIds.length){ card.innerHTML = '<em>Aucun item.</em>'; return; }
    if(state.idx<0) state.idx=0; if(state.idx>=state.agendaIds.length) state.idx = state.agendaIds.length-1;
    const cid = state.agendaIds[state.idx];
    const it  = items.find(x=>x.id===cid);
    if(!it){ card.innerHTML='<em>Item introuvable.</em>'; return; }
    const chips = (state.svc.charter?.contraintes||'').split(/[;,‚Ä¢\n]/).map(x=>x.trim()).filter(Boolean).slice(0,4).map(chip).join(' ') || chip('‚Äî');
    const props = (it.propositions||[]).map((p,i)=>{
		  const st=(p.decision?.status)||'a_preciser';
		  const is = s=> (st===s ? 'class="pact active"' : 'class="pact"');
		  const importTag = p.decision?.import_file 
		      ? `<span style="border:1px solid #60a5fa;border-radius:6px;padding:1px 6px;margin-left:6px">fichier: ${p.decision.import_file}</span>` 
		      : '';
			// NEW: sims + notes + badges IA/Client/SenIAr
		  const sims = (p.sims||[]).map(sm=>`
		    <div style="border:1px dashed #ddd;border-radius:6px;padding:8px;margin-top:6px">
		      <div style="display:flex;align-items:center;gap:8px;font-size:12px;opacity:.9">
		        <button class="spick" data-c="${it.id}" data-p="${p.pid}" data-s="${sm.id}" title="S√©lectionner cette simulation">${sm.picked?'‚òÖ':'‚òÜ'}</button>
		        ${originTag(sm.origin||'IA')}
		        <span>${sm.id} ¬∑ ${new Date(sm.ts).toLocaleTimeString()}</span>
		      </div>
		      <div style="margin:4px 0">${(sm.note||'').replace(/</g,'&lt;')}</div>
		      <div style="font-size:12px;opacity:.8">impact: co√ªt ${sm.impact?.cout||'‚Äî'} ¬∑ d√©lai ${sm.impact?.delai||'‚Äî'} ¬∑ risque ${sm.impact?.risque||'‚Äî'}</div>
		    </div>`).join('');
		
		  const notes = (p.notes||[]).slice(-6).map(n=>`
		    <div style="display:flex;gap:8px;align-items:baseline;margin-top:6px">
		      ${originTag(n.origin, n.who)}
		      <span style="font-size:12px;opacity:.7">${new Date(n.ts).toLocaleTimeString()}</span>
		      <div>${(n.text||'').replace(/</g,'&lt;')}</div>
		    </div>`).join('');
      return `
      <div style="border:1px solid #eee;border-radius:8px;padding:10px;margin-bottom:12px">
		    <div style="display:flex;justify-content:space-between;align-items:center">
		      <div><strong>${p.pid||('P'+(i+1))}</strong> ¬∑ ${p.label||''}</div>
		      <div>
		        <button ${is('valide')}      data-c="${it.id}" data-p="${p.pid}" data-act="valide" style="margin-right:6px">Valider</button>
		        <button ${is('a_preciser')}  data-c="${it.id}" data-p="${p.pid}" data-act="a_preciser" style="margin-right:6px">√Ä pr√©ciser</button>
		        <button ${is('refuse')}      data-c="${it.id}" data-p="${p.pid}" data-act="refuse">Refuser</button>
		        ${importTag}
		      </div>
		    </div>
		    <div style="opacity:.8;margin:4px 0">co√ªt:${p.indicateurs?.cout||'‚Äî'} ¬∑ complexit√©:${p.indicateurs?.complexite||'‚Äî'} ¬∑ embauche:${p.indicateurs?.embauche||'‚Äî'} ¬∑ donn√©es:${p.indicateurs?.donnees||'‚Äî'}</div>
		    <label style="font-size:.9em;opacity:.8">Commentaire</label>
		    <input type="text" class="pcmt" data-c="${it.id}" data-p="${p.pid}" value="${p.decision?.comment||''}" style="width:100%">
		    <!-- NEW: sims + notes -->
		    <div style="margin-top:8px">${sims}</div>
		    <div style="margin-top:6px">${notes}</div>
		  </div>`; 
    }).join('');
    card.innerHTML = renderCardCommon(it);
		attachCardHandlers(
		  card,
		  ()=>state.svc,
		  (S)=>{ state.svc = S; saveLocal(state.db); },
		  ()=>{ renderCard(); }
		);

    document.getElementById('p_prev2').onclick = ()=> { state.idx=Math.max(0,state.idx-1); renderCard(); };
    document.getElementById('p_next2').onclick = ()=> { state.idx=Math.min(state.agendaIds.length-1,state.idx+1); renderCard(); };
  }
  function renderAll(){
    state.db = loadLocal();
    state.svcKey = deriveService();
    state.svc    = state.db.services[state.svcKey] || {charter:{},items:[],agenda:[]};
    state.agendaIds = computeAgenda();
    if(state.idx>=state.agendaIds.length) state.idx = 0;
    const wid = localStorage.getItem(WORK_KEY)||(`‚Äî | ${state.svcKey} | ‚Äî`);
    const cid = state.agendaIds[state.idx] || '‚Äî';
		hdr.textContent = `Service projet√© : ${state.svcKey} ¬∑ Card #${cid} ¬∑ INVIT√â ¬∑ LIVE`;
    renderAgenda(); renderCard();
  }
	loadBaselineFromCloud().finally(()=>{
	  renderAll();
	  if(isGuestMode()){
	    readGuestParams();
	    startGuestPoll();
	  }
	});

  // sync via storage et contr√¥les
  window.addEventListener('storage', (e)=>{ if(e.key===DB_KEY || e.key==='paria_touch' || e.key===WORK_KEY) renderAll(); });
  btnPrev.onclick = ()=>{ state.idx=Math.max(0,state.idx-1); renderCard(); };
  btnNext.onclick = ()=>{ state.idx=Math.min(state.agendaIds.length-1,state.idx+1); renderCard(); };
  btnBig.onclick  = ()=>{ document.querySelector('.full').style.fontSize='18px'; };
  btnSmall.onclick= ()=>{ document.querySelector('.full').style.fontSize='15px'; };
  btnTogA.onclick = ()=>{ const hidden = agenda.style.display === 'none'; agenda.style.display = hidden ? 'block' : 'none'; grid.classList.toggle('no-agenda', !hidden); };
  window.addEventListener('keydown', (ev)=>{
    if(ev.key==='ArrowLeft'){ btnPrev.click(); ev.preventDefault(); }
    if(ev.key==='ArrowRight'){ btnNext.click(); ev.preventDefault(); }
    if(['1','2','3'].includes(ev.key)){
      const first = card.querySelector('.pact[data-act]'); if(!first) return;
      const c = first.getAttribute('data-c'); const p = first.getAttribute('data-p'); const map = { '1':'valide', '2':'a_preciser', '3':'refuse' };
      decide(c,p,map[ev.key]); ev.preventDefault();
    }
  });
})();
</script>
</body>
</html>











